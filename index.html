<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Karanlƒ±k Koridor: Ka√ßƒ±≈ü</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; }
        
        /* Aray√ºz Katmanƒ± */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Envanter */
        #inventory {
            padding: 20px;
            color: #d4af37; /* Altƒ±n rengi */
            font-size: 24px;
            text-shadow: 2px 2px 4px #000;
        }

        /* Etkile≈üim Yazƒ±sƒ± */
        #interaction {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 20px;
            display: none;
            text-shadow: 0 0 10px #ff0000;
        }

        /* Ba≈ülangƒ±√ß Ekranƒ± */
        #blocker {
            position: absolute;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 999;
            pointer-events: all;
            color: white;
        }
        
        #instructions {
            font-size: 30px;
            cursor: pointer;
            text-align: center;
        }

        #game-over {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: red;
            color: black;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="game-over">YAKALANDIN!</div>
    <div id="blocker">
        <div id="instructions">
            <span>BA≈ûLAMAK ƒ∞√áƒ∞N TIKLA</span><br/>
            (W, A, S, D = Y√ºr√º | Mouse = Bak)<br/>
            Karanlƒ±kta hayatta kal...
        </div>
    </div>

    <div id="ui-layer">
        <div id="inventory">ENVANTER: <span id="item-name">Skeleton Key</span> üóùÔ∏è</div>
        <div id="interaction">[E] KAPIYI A√á</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- DEƒûƒ∞≈ûKENLER ---
        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        // Oyun Objeleri
        let doorModel = null;
        let zombieModel = null;
        let keyModel = null; // Elde tutulan
        
        // Durumlar
        let hasKey = true; // Hikaye gereƒüi anahtar elimizde
        let isDoorOpen = false;
        let chaseMode = false;
        let isGameOver = false;

        // Ayarlar
        const zombieSpeed = 6.5; // Zombi hƒ±zƒ±
        const interactionDist = 5.0; // Kapƒ±ya ne kadar yakla≈üƒ±nca a√ßƒ±lsƒ±n

        // HTML Elementleri
        const interactionText = document.getElementById('interaction');
        const blocker = document.getElementById('blocker');
        const instructions = document.getElementById('instructions');
        const gameOverScreen = document.getElementById('game-over');

        init();
        animate();

        function init() {
            // 1. Sahne Kurulumu
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            // Korku atmosferi i√ßin yoƒüun sis
            scene.fog = new THREE.FogExp2(0x000000, 0.15); 

            // 2. Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.y = 1.6; // ƒ∞nsan boyu

            // 3. I≈üƒ±klandƒ±rma (El Feneri)
            const light = new THREE.HemisphereLight(0x222222, 0x000000, 0.5); // √áok lo≈ü ortam
            scene.add(light);

            // Kameraya baƒülƒ± spot ƒ±≈üƒ±ƒüƒ± (El feneri efekti)
            const flashLight = new THREE.SpotLight(0xffffff, 2, 20, Math.PI/6, 0.5, 1);
            flashLight.position.set(0, 0, 0);
            flashLight.target.position.set(0, 0, -1);
            camera.add(flashLight);
            camera.add(flashLight.target);
            scene.add(camera);

            // 4. Kontroller
            controls = new PointerLockControls(camera, document.body);

            instructions.addEventListener('click', function () {
                controls.lock();
            });

            controls.addEventListener('lock', function () {
                instructions.style.display = 'none';
                blocker.style.display = 'none';
            });

            controls.addEventListener('unlock', function () {
                if(!isGameOver){
                    blocker.style.display = 'flex';
                    instructions.style.display = '';
                }
            });

            // 5. Harita (Basit Zemin ve Duvarlar)
            const floorGeometry = new THREE.PlaneGeometry(20, 40);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1a1a1a, 
                roughness: 0.8 
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // 6. 3D Model Y√ºklemeleri (GLB)
            const loader = new GLTFLoader();

            // KAPI Y√úKLEME
            loader.load('./Door.glb', function (gltf) {
                doorModel = gltf.scene;
                // Kapƒ±yƒ± oyuncunun kar≈üƒ±sƒ±na koyuyoruz
                doorModel.position.set(0, 0, -5); 
                doorModel.scale.set(1, 1, 1); // Model boyutuna g√∂re burayƒ± deƒüi≈ütirmen gerekebilir (√∂rn: 0.01)
                scene.add(doorModel);
            }, undefined, function (error) {
                console.error('Door.glb y√ºklenemedi, yerine kutu koyuluyor.', error);
                // Yedek (Fallback) obje
                const geo = new THREE.BoxGeometry(2, 3, 0.2);
                const mat = new THREE.MeshStandardMaterial({color: 0x4a3c31});
                doorModel = new THREE.Mesh(geo, mat);
                doorModel.position.set(0, 1.5, -5);
                scene.add(doorModel);
            });

            // ZOMBƒ∞ Y√úKLEME
            loader.load('./Zombie.glb', function (gltf) {
                zombieModel = gltf.scene;
                // Zombiyi kapƒ±nƒ±n arkasƒ±na saklƒ±yoruz
                zombieModel.position.set(0, 0, -10); 
                // Zombi ba≈ülangƒ±√ßta bize baksƒ±n
                zombieModel.rotation.y = Math.PI;
                scene.add(zombieModel);
            }, undefined, function(error) {
                console.error('Zombie.glb y√ºklenemedi.');
                // Yedek zombi
                const geo = new THREE.BoxGeometry(1, 2, 1);
                const mat = new THREE.MeshStandardMaterial({color: 0x00ff00});
                zombieModel = new THREE.Mesh(geo, mat);
                zombieModel.position.set(0, 1, -10);
                scene.add(zombieModel);
            });

            // ANAHTAR Y√úKLEME (Elde duracak)
            loader.load('./Skeleton Key.glb', function (gltf) {
                keyModel = gltf.scene;
                // Anahtarƒ± kameraya ekliyoruz ki bizimle gelsin (FPS el g√∂r√ºnt√ºs√º)
                keyModel.position.set(0.5, -0.5, -1); // Saƒü altta dursun
                keyModel.rotation.set(0, Math.PI / 2, 0);
                keyModel.scale.set(0.5, 0.5, 0.5); // Boyut ayarƒ±
                camera.add(keyModel);
            }, undefined, function(error) {
                console.log("Anahtar modeli y√ºklenemedi veya yok.");
            });

            // 7. Render Setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onKeyDown(event) {
            switch (event.code) {
                case 'ArrowUp': case 'KeyW': moveForward = true; break;
                case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                case 'ArrowRight': case 'KeyD': moveRight = true; break;
                case 'KeyE': interact(); break; // E tu≈üu etkile≈üim
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'ArrowUp': case 'KeyW': moveForward = false; break;
                case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                case 'ArrowRight': case 'KeyD': moveRight = false; break;
            }
        }

        // KAPIYLA ETKƒ∞LE≈ûƒ∞M FONKSƒ∞YONU
        function interact() {
            if (!doorModel || isDoorOpen) return;

            // Kapƒ±ya olan mesafeyi √∂l√ß
            const dist = camera.position.distanceTo(doorModel.position);
            
            if (dist < interactionDist && hasKey) {
                // Kapƒ± a√ßƒ±lma animasyonu (Basit d√∂nd√ºrme)
                isDoorOpen = true;
                
                // Kapƒ±yƒ± 90 derece d√∂nd√ºr
                // Not: Modelin pivot noktasƒ±na g√∂re ayar gerekebilir.
                // Burada basit√ße Y ekseninde d√∂nd√ºr√ºyoruz.
                let targetRotation = doorModel.rotation.y + (Math.PI / 2);
                
                // Basit bir animasyon d√∂ng√ºs√º yerine direkt √ßeviriyoruz (TWEEN kullanmadan)
                // Daha p√ºr√ºzs√ºz olmasƒ± i√ßin animate i√ßinde yapƒ±labilir ama bu hƒ±zlƒ± bir √ß√∂z√ºm:
                doorModel.rotation.y = targetRotation;
                doorModel.position.x += 1; // Kapƒ± biraz yana kaysƒ±n (Mente≈üe sim√ºlasyonu yoksa)

                // Envanter g√ºncelle
                document.getElementById('item-name').innerText = "Bo≈ü";
                document.getElementById('item-name').style.color = "grey";
                if(keyModel) keyModel.visible = false; // Anahtarƒ± elden kaldƒ±r

                // ZOMBƒ∞ KOVALAMACASINI BA≈ûLAT
                startChase();
            }
        }

        function startChase() {
            chaseMode = true;
            // Korkutucu ses efekti eklenebilir buraya
            // Zombinin rengini veya ƒ±≈üƒ±ƒüƒ±nƒ± deƒüi≈ütirebiliriz
            scene.fog.color.setHex(0x330000); // Sis hafif kƒ±rmƒ±zƒ±la≈üƒ±r
        }

        function animate() {
            requestAnimationFrame(animate);

            if(isGameOver) return;

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked === true) {
                // --- KARAKTER HAREKETƒ∞ ---
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // Hƒ±zƒ±n √ßaprazda artmasƒ±nƒ± engelle

                if (moveForward || moveBackward) velocity.z -= direction.z * 40.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 40.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
                
                // --- OYUN MANTIƒûI ---

                // 1. Kapƒ± Etkile≈üim UI Kontrol√º
                if (doorModel && !isDoorOpen) {
                    const dist = camera.position.distanceTo(doorModel.position);
                    if (dist < interactionDist && hasKey) {
                        interactionText.style.display = 'block';
                    } else {
                        interactionText.style.display = 'none';
                    }
                } else {
                    interactionText.style.display = 'none';
                }

                // 2. Zombi Yapay Zekasƒ± (Chase Mode)
                if (chaseMode && zombieModel) {
                    // Zombiyi oyuncuya d√∂nd√ºr
                    zombieModel.lookAt(camera.position.x, 1, camera.position.z);
                    
                    // Oyuncuya doƒüru hareket ettir
                    const zombieDir = new THREE.Vector3();
                    zombieDir.subVectors(camera.position, zombieModel.position).normalize();
                    
                    zombieModel.position.add(zombieDir.multiplyScalar(zombieSpeed * delta));

                    // Yakalanma Kontrol√º (Distance check)
                    const zombieDist = camera.position.distanceTo(zombieModel.position);
                    if (zombieDist < 1.5) {
                        isGameOver = true;
                        controls.unlock();
                        gameOverScreen.style.display = 'flex';
                    }
                }
            }

            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
