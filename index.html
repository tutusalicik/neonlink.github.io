<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CS2 WEB: ULTIMATE</title>
    <style>
        /* --- PRO UI DESIGN --- */
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        #ui-layer { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; }
        
        /* CROSSHAIR (Dinamik) */
        #crosshair-container { position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); }
        .ch-line { position: absolute; background: #0f0; box-shadow: 0 0 4px #000; transition: all 0.05s ease-out; }
        .ch-h { width: 10px; height: 2px; left: -5px; top: 0; }
        .ch-v { width: 2px; height: 10px; top: -5px; left: 0; }
        /* Ateş edince açılan crosshair */
        .shooting .ch-h { width: 20px; left: -10px; background: #ff4444; }
        .shooting .ch-v { height: 20px; top: -10px; background: #ff4444; }

        /* HUD */
        #hud-bottom { 
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 50px; 
            text-shadow: 2px 2px 0 #000;
        }
        .hud-box { display: flex; flex-direction: column; }
        .hud-val { font-size: 60px; font-weight: 900; color: white; line-height: 1; }
        .hud-label { font-size: 14px; color: #bbb; font-weight: bold; letter-spacing: 2px; }
        #ammo-val { color: #eebc51; }

        /* FLASH & VIGNETTE */
        #muzzle-flash-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, rgba(255, 200, 50, 0.1) 0%, transparent 40%); opacity: 0; transition: opacity 0.05s; }
        #vignette { position: absolute; width:100%; height:100%; box-shadow: inset 0 0 150px rgba(0,0,0,0.9); pointer-events: none; }

        /* LOADING */
        #loader { position: fixed; width:100%; height:100%; background: #080808; z-index: 999; display: flex; align-items: center; justify-content: center; color: #eebc51; flex-direction: column; }
        .bar { width: 300px; height: 4px; background: #222; margin-top: 15px; }
        .fill { width: 0%; height: 100%; background: #eebc51; transition: 0.2s; }

        /* MENU */
        #menu { position: absolute; width:100%; height:100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; pointer-events: all; }
        h1 { font-size: 80px; color: white; margin: 0; font-style: italic; letter-spacing: -4px; text-shadow: 0 0 20px #eebc51; }
        .btn { padding: 20px 50px; background: linear-gradient(45deg, #eebc51, #d4a030); border: none; font-size: 24px; font-weight: bold; cursor: pointer; margin-top: 30px; color: #000; transform: skewX(-10deg); transition: 0.2s; }
        .btn:hover { transform: skewX(-10deg) scale(1.1); box-shadow: 0 0 30px rgba(238, 188, 81, 0.5); }

    </style>
</head>
<body>

    <div id="loader">
        <h2 style="letter-spacing: 5px;">TITAN ENGINE v8.0</h2>
        <div class="bar"><div class="fill" id="l-fill"></div></div>
        <div id="l-msg" style="margin-top: 5px; font-size: 10px; color: #555;">ASSETS LOADING...</div>
    </div>

    <div id="menu">
        <h1>CS:WEB <span style="font-size: 30px; color:#eebc51">ULTIMATE</span></h1>
        <button class="btn" onclick="Game.start()">OYUNA GİR</button>
        <div style="color:#666; margin-top: 20px;">WASD: Hareket | SOL TIK: Tara | R: Şarjör</div>
    </div>

    <div id="ui-layer">
        <div id="vignette"></div>
        <div id="muzzle-flash-overlay"></div>
        
        <div id="crosshair-container">
            <div class="ch-line ch-h"></div>
            <div class="ch-line ch-v"></div>
        </div>

        <div id="hud-bottom">
            <div class="hud-box">
                <div class="hud-val">✚ 100</div>
                <div class="hud-label">HEALTH</div>
            </div>
            <div class="hud-box" style="text-align: right;">
                <div class="hud-val" id="ammo-val">30</div>
                <div class="hud-label">AK-47 / 90</div>
            </div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- AYARLAR (BURASI ÇOK ÖNEMLİ) ---
        const CONFIG = {
            // Silahın eline oturma ayarı
            weapon: {
                scale: 0.15,         // Silah boyutu
                posX: 0.2,           // Sağ/Sol (Pozitif sağ)
                posY: -0.3,          // Yukarı/Aşağı
                posZ: -0.5,          // İleri/Geri
                rotY: Math.PI / 2,   // YAN TUTMA SORUNU İÇİN: 90 derece çevir (Math.PI/2) veya 0 dene
                rotZ: 0              // Eğer silah yatıksa burayı değiştir
            },
            // Guy.glb boyutu
            npcScale: 0.05,          // GUY ÇOK BÜYÜKSE BUNU 0.05 YAP
            fireRate: 0.09           // Tarama hızı
        };

        const Sys = { scene: null, camera: null, renderer: null, controls: null, assets: {}, particles: [] };
        const State = { ammo: 30, isFiring: false, lastShot: 0 };
        const Recoil = { x: 0, y: 0 };

        init();

        async function init() {
            // 1. Sahne
            Sys.scene = new THREE.Scene();
            Sys.scene.background = new THREE.Color(0x111111);
            Sys.scene.fog = new THREE.Fog(0x111111, 0, 40);

            Sys.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
            Sys.camera.position.y = 1.6;

            Sys.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            Sys.renderer.setSize(window.innerWidth, window.innerHeight);
            Sys.renderer.shadowMap.enabled = true;
            document.body.appendChild(Sys.renderer.domElement);

            // 2. Işıklar (PRO LIGHTING)
            const amb = new THREE.AmbientLight(0xffffff, 0.4);
            Sys.scene.add(amb);
            
            const sun = new THREE.DirectionalLight(0xffedd0, 1.5);
            sun.position.set(10, 30, 10);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 2048;
            sun.shadow.mapSize.height = 2048;
            Sys.scene.add(sun);

            // Namlu Işığı (Muzzle Flash Light) - Silaha bağlı olacak
            Sys.muzzleLight = new THREE.PointLight(0xffaa00, 0, 5);
            Sys.scene.add(Sys.muzzleLight);

            Sys.controls = new PointerLockControls(Sys.camera, document.body);

            // 3. Yükleme
            await loadAssets();
        }

        async function loadAssets() {
            const loader = new GLTFLoader();
            const files = { map: './map.glb', guy: './guy.glb', ak47: './Ak47.glb' };
            const keys = Object.keys(files);

            for(let i=0; i<keys.length; i++) {
                const k = keys[i];
                try {
                    document.getElementById('l-msg').innerText = "LOADING " + k.toUpperCase();
                    const gltf = await loader.loadAsync(files[k]);
                    Sys.assets[k] = gltf.scene;
                    document.getElementById('l-fill').style.width = ((i+1)/3*100) + "%";
                } catch(e) {
                    console.error("HATA:", k);
                    // Hata olursa kırmızı kutu koy
                    Sys.assets[k] = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshBasicMaterial({color:'red'}));
                }
            }
            document.getElementById('loader').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        }

        window.Game = {
            start: () => {
                document.getElementById('menu').style.display = 'none';
                Sys.controls.lock();
                buildWorld();
                animate();
            }
        };

        function buildWorld() {
            // MAP
            const map = Sys.assets.map;
            map.traverse(o => { if(o.isMesh) { o.receiveShadow=true; o.castShadow=true; } });
            Sys.scene.add(map);

            // SİLAH (AK-47 FIX)
            const ak = Sys.assets.ak47;
            ak.scale.set(CONFIG.weapon.scale, CONFIG.weapon.scale, CONFIG.weapon.scale);
            ak.rotation.set(0, CONFIG.weapon.rotY, CONFIG.weapon.rotZ); // Dönüş ayarı
            ak.position.set(CONFIG.weapon.posX, CONFIG.weapon.posY, CONFIG.weapon.posZ);
            
            // Gölge kapama (FPS için)
            ak.traverse(o => { if(o.isMesh) { o.castShadow=false; o.receiveShadow=false; } });

            Sys.gunContainer = new THREE.Group(); // Recoil için container
            Sys.gunContainer.add(ak);
            Sys.camera.add(Sys.gunContainer);
            Sys.scene.add(Sys.camera);

            // BOTLAR (KÜÇÜLTÜLMÜŞ)
            spawnBot(5, 0, 10);
            spawnBot(-5, 0, 10);
            spawnBot(0, 0, 15);
        }

        function spawnBot(x, y, z) {
            const bot = Sys.assets.guy.clone();
            bot.scale.set(CONFIG.npcScale, CONFIG.npcScale, CONFIG.npcScale); // KÜÇÜLTME BURADA
            bot.position.set(x, y, z);
            
            // Botun içindeki animasyonları/materyalleri düzelt
            bot.traverse(o => { 
                if(o.isMesh) { 
                    o.castShadow=true; 
                    if(!o.material.map) o.material.color.setHex(0x555555); 
                } 
            });

            Sys.scene.add(bot);
            // Bot verisi
            if(!Sys.bots) Sys.bots = [];
            Sys.bots.push({ mesh: bot, hp: 100 });
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = 0.016; // 60 FPS fix

            // 1. ATEŞ ETME (SPRAY)
            if(State.isFiring && Sys.controls.isLocked) {
                const now = Date.now() / 1000;
                if(now - State.lastShot > CONFIG.fireRate) {
                    fire();
                    State.lastShot = now;
                }
            } else {
                // Ateş etmiyorsan crosshair düzelir
                document.getElementById('crosshair-container').classList.remove('shooting');
                Sys.muzzleLight.intensity = 0; // Işığı kapat
            }

            // 2. RECOIL & SİLAH ANİMASYONU
            // Geri tepmeyi yavaşça düzelt (Recovery)
            Recoil.x = THREE.MathUtils.lerp(Recoil.x, 0, dt * 10);
            Recoil.y = THREE.MathUtils.lerp(Recoil.y, 0, dt * 5);
            
            if(Sys.gunContainer) {
                Sys.gunContainer.position.z = -0.1 * Recoil.x; // Geri git
                Sys.gunContainer.rotation.x = 0.2 * Recoil.x;  // Namlu kalk
                
                // Nefes alma (Idle)
                const time = Date.now() * 0.002;
                Sys.gunContainer.position.y = Math.sin(time) * 0.002 - (Recoil.x * 0.05); 
            }

            // Kamera Titremesi (Screen Shake)
            Sys.camera.rotation.x -= Recoil.x * 0.002; // Kamera yukarı seker
            
            // 3. BOTLAR (BİZE BAKSIN)
            if(Sys.bots) {
                Sys.bots.forEach(b => {
                    if(b.hp > 0) b.mesh.lookAt(Sys.camera.position.x, 0, Sys.camera.position.z);
                });
            }

            // 4. PARTİKÜLLER (KAN EFEKTİ)
            updateParticles();

            handleInput(dt);
            Sys.renderer.render(Sys.scene, Sys.camera);
        }

        function fire() {
            if(State.ammo <= 0) return;
            State.ammo--;
            document.getElementById('ammo-val').innerText = State.ammo;

            // Efektler
            Recoil.x = Math.min(Recoil.x + 0.5, 2.0); // Tepme biriktir
            document.getElementById('crosshair-container').classList.add('shooting');
            
            // Namlu Işığı Çakması
            Sys.muzzleLight.position.copy(Sys.camera.position).add(Sys.camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(1));
            Sys.muzzleLight.intensity = 2;
            
            // Ekran Flashı
            const flash = document.getElementById('muzzle-flash-overlay');
            flash.style.opacity = 0.2;
            setTimeout(() => flash.style.opacity = 0, 50);

            // VURUŞ TESTİ (RAYCAST)
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), Sys.camera); // Tam ortadan
            
            // Bot meshlerini topla
            const botMeshes = Sys.bots.map(b => b.mesh);
            const hits = ray.intersectObjects(botMeshes, true);

            if(hits.length > 0) {
                const hitPoint = hits[0].point;
                const hitObj = hits[0].object;
                
                // Kan Efekti Çıkar
                spawnBlood(hitPoint);

                // Botu bul ve canını azalt
                // Basitçe: İlk vurulan botu bul
                // (Projenin karmaşıklığına göre ebeveyn taraması gerekebilir)
                const botRoot = hitObj.parent || hitObj; 
                // Botu yere yatır (Basit ölüm)
                // Gerçek logic için Sys.bots dizisinden bulup hp düşürmek lazım
                // Görsel test için:
                hitObj.material = new THREE.MeshBasicMaterial({color: 0xaa0000}); 
                setTimeout(()=> { hitObj.material = new THREE.MeshStandardMaterial({color:0x555555}); }, 100);
            }
        }

        function spawnBlood(pos) {
            for(let i=0; i<5; i++) {
                const p = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.05, 0.05), new THREE.MeshBasicMaterial({color:0xaa0000}));
                p.position.copy(pos);
                // Rastgele saçılma
                p.userData = { 
                    vel: new THREE.Vector3((Math.random()-0.5), (Math.random()), (Math.random()-0.5)).multiplyScalar(0.2) 
                };
                Sys.scene.add(p);
                Sys.particles.push(p);
            }
        }

        function updateParticles() {
            for(let i=Sys.particles.length-1; i>=0; i--) {
                const p = Sys.particles[i];
                p.position.add(p.userData.vel);
                p.userData.vel.y -= 0.01; // Yerçekimi
                p.scale.multiplyScalar(0.9); // Küçülme
                if(p.scale.x < 0.01) {
                    Sys.scene.remove(p);
                    Sys.particles.splice(i, 1);
                }
            }
        }

        // --- KLAVYE ---
        const keys = { w:false, a:false, s:false, d:false };
        function handleInput(dt) {
            const speed = 5.0;
            const dir = new THREE.Vector3();
            if(keys.w) dir.z = 1; if(keys.s) dir.z = -1;
            if(keys.a) dir.x = -1; if(keys.d) dir.x = 1;
            
            if(dir.length() > 0) {
                Sys.controls.moveForward(dir.z * speed * dt);
                Sys.controls.moveRight(dir.x * speed * dt);
            }
        }
        
        document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        document.addEventListener('mousedown', () => { if(Sys.controls.isLocked) State.isFiring = true; });
        document.addEventListener('mouseup', () => State.isFiring = false);

    </script>
</body>
</html>
