<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Koridor: G√∂r√ºn√ºr Karanlƒ±k</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        
        /* Aray√ºz */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }

        #inventory { 
            padding: 25px; color: #ffcc00; font-size: 24px; font-weight: bold; 
            text-shadow: 2px 2px 0px #000; letter-spacing: 1px;
        }

        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 18px; display: none; text-align: center;
            background: rgba(0, 0, 0, 0.7); padding: 10px 20px; border: 1px solid #fff; border-radius: 4px;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 8px; height: 8px;
            background: rgba(255, 255, 255, 0.8); border-radius: 50%; 
            transform: translate(-50%, -50%); z-index: 5; box-shadow: 0 0 5px white;
        }

        /* Ba≈ülangƒ±√ß Ekranƒ± */
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #111;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 999; pointer-events: all; color: #ddd;
        }
        #instructions { font-size: 20px; text-align: center; line-height: 2; cursor: pointer; }
        #instructions h1 { font-size: 50px; color: #c00; margin: 0; text-transform: uppercase; letter-spacing: 5px; }

        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #500; color: #fff; z-index: 1000;
            justify-content: center; align-items: center; flex-direction: column;
            font-size: 80px; font-weight: 900;
        }
        
        #stamina-bar-container {
            position: absolute; bottom: 30px; left: 30px; width: 250px; height: 15px; 
            background: rgba(0,0,0,0.5); border: 2px solid #555; border-radius: 10px; overflow: hidden;
        }
        #stamina-bar { width: 100%; height: 100%; background: #fff; transition: width 0.1s linear; }

    </style>
</head>
<body>

    <div id="game-over">YAKALANDIN</div>
    
    <div id="blocker">
        <div id="instructions">
            <h1>KA√áI≈û</h1>
            <p>OYUNA BA≈ûLAMAK ƒ∞√áƒ∞N TIKLA</p>
            <p>(W, A, S, D = Hareket | SHIFT = Ko≈ü | E = Etkile≈üim)</p>
        </div>
    </div>

    <div id="crosshair"></div>

    <div id="ui-layer">
        <div id="inventory">ANAHTAR: <span id="key-status" style="color:#0f0;">VAR</span> üóùÔ∏è</div>
        <div id="interaction">[E] KAPIYI A√á</div>
        <div id="stamina-bar-container"><div id="stamina-bar"></div></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SES Sƒ∞STEMƒ∞ (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'unlock') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(); osc.stop(now + 0.2);
            } else if (type === 'creak') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(80, now);
                osc.frequency.linearRampToValueAtTime(120, now + 2);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 2);
                osc.start(); osc.stop(now + 2);
            } else if (type === 'step') {
                // Adƒ±m sesi (Daha tok)
                osc.type = 'square';
                osc.frequency.setValueAtTime(50, now);
                gainNode.gain.setValueAtTime(0.05, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'scream') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.5);
                gainNode.gain.setValueAtTime(0.5, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 1.0);
                osc.start(); osc.stop(now + 1.0);
            }
        }

        // --- DOKU OLU≈ûTURUCU (Dosya indirmeden texture yapma) ---
        function createProceduralTexture(color1, color2) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Arka plan
            ctx.fillStyle = color1;
            ctx.fillRect(0,0,512,512);
            
            // Izgara (Grid) deseni
            ctx.strokeStyle = color2;
            ctx.lineWidth = 4;
            ctx.beginPath();
            // Dikey √ßizgiler
            for(let i=0; i<=512; i+=64) { ctx.moveTo(i,0); ctx.lineTo(i,512); }
            // Yatay √ßizgiler
            for(let i=0; i<=512; i+=64) { ctx.moveTo(0,i); ctx.lineTo(512,i); }
            ctx.stroke();
            
            // Biraz kir ekle (Noise)
            for(let i=0; i<500; i++) {
                ctx.fillStyle = Math.random() > 0.5 ? '#000' : '#fff';
                ctx.globalAlpha = 0.1;
                ctx.fillRect(Math.random()*512, Math.random()*512, 4, 4);
            }
            
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        // --- OYUN DEƒûƒ∞≈ûKENLERƒ∞ ---
        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, isSprinting = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        
        let doorGroup = new THREE.Group();
        let zombieModel = null;
        let keyModel = null;

        let hasKey = true;
        let doorState = 0; // 0:Kapalƒ±, 1:Anahtar, 2:A√ßƒ±lƒ±yor, 3:A√ßƒ±k
        let chaseMode = false;
        let isGameOver = false;
        let stamina = 100;
        let stepTimer = 0; // Adƒ±m sesi i√ßin

        // Animasyon Zamanlayƒ±cƒ±larƒ±
        let keyAnimStart = 0;

        const interactionUI = document.getElementById('interaction');
        const blocker = document.getElementById('blocker');
        const instructions = document.getElementById('instructions');
        const keyStatus = document.getElementById('key-status');
        const staminaBar = document.getElementById('stamina-bar');
        const gameOverDiv = document.getElementById('game-over');

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            // Ortam biraz daha gri olsun ki duvarlar g√∂z√ºks√ºn
            scene.background = new THREE.Color(0x111111);
            // Sis yoƒüunluƒüunu azalttƒ±m, etraf daha net
            scene.fog = new THREE.FogExp2(0x111111, 0.08);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.y = 1.7;

            // --- I≈ûIKLANDIRMA (ARTIK G√ñZ√úK√úYOR) ---
            // 1. Ortam I≈üƒ±ƒüƒ± (Genel aydƒ±nlƒ±k)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); 
            scene.add(ambientLight);

            // 2. El Feneri (Daha geni≈ü ve g√º√ßl√º)
            const flashLight = new THREE.SpotLight(0xffffff, 4, 40, Math.PI/4, 0.3, 1);
            flashLight.position.set(0, 0, 0);
            flashLight.target.position.set(0, 0, -5);
            flashLight.castShadow = true;
            flashLight.shadow.bias = -0.0001;
            camera.add(flashLight);
            camera.add(flashLight.target);
            scene.add(camera);

            controls = new PointerLockControls(camera, document.body);

            instructions.addEventListener('click', () => controls.lock());
            controls.addEventListener('lock', () => {
                instructions.style.display = 'none';
                blocker.style.display = 'none';
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
            controls.addEventListener('unlock', () => {
                if(!isGameOver) {
                    blocker.style.display = 'flex';
                    instructions.style.display = '';
                }
            });

            // --- ORTAM OLU≈ûTURMA (DUVARLAR & ZEMƒ∞N) ---
            const wallTexture = createProceduralTexture('#333333', '#111111'); // Gri Duvar
            const floorTexture = createProceduralTexture('#222222', '#444444'); // Koyu Zemin
            
            wallTexture.repeat.set(5, 1);
            floorTexture.repeat.set(2, 10);

            // Zemin
            const floorGeo = new THREE.PlaneGeometry(10, 60);
            const floorMat = new THREE.MeshStandardMaterial({ map: floorTexture, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Duvarlar
            const wallGeo = new THREE.BoxGeometry(1, 6, 60);
            const wallMat = new THREE.MeshStandardMaterial({ map: wallTexture, roughness: 0.9 });
            
            const wallL = new THREE.Mesh(wallGeo, wallMat);
            wallL.position.set(-5.5, 3, 0);
            wallL.receiveShadow = true;
            wallL.castShadow = true;
            scene.add(wallL);

            const wallR = new THREE.Mesh(wallGeo, wallMat);
            wallR.position.set(5.5, 3, 0);
            wallR.receiveShadow = true;
            wallR.castShadow = true;
            scene.add(wallR);

            // Tavan
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(10, 60), new THREE.MeshBasicMaterial({color:0x050505}));
            ceil.rotation.x = Math.PI / 2;
            ceil.position.y = 6;
            scene.add(ceil);

            // --- MODEL Y√úKLEME ---
            const loader = new GLTFLoader();

            // Kapƒ±
            loader.load('./Door.glb', (gltf) => {
                const model = gltf.scene;
                model.traverse(o => { if(o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
                // Kapƒ± modelinin merkezine g√∂re ayarlama
                model.position.set(0.6, 0, 0); // Kapƒ± mente≈üesi ayarƒ±
                doorGroup.add(model);
                doorGroup.position.set(-0.6, 0, -15); // Kapƒ± koridorun sonunda
                scene.add(doorGroup);
            }, undefined, (e) => {
                // Yedek Kapƒ±
                const g = new THREE.BoxGeometry(2.5, 4, 0.2);
                const m = new THREE.MeshStandardMaterial({color:0x654321});
                const d = new THREE.Mesh(g,m);
                d.position.set(1.25, 2, 0);
                doorGroup.add(d);
                doorGroup.position.set(-1.25, 0, -15);
                scene.add(doorGroup);
            });

            // Zombi
            loader.load('./Zombie.glb', (gltf) => {
                zombieModel = gltf.scene;
                zombieModel.traverse(o => { if(o.isMesh) o.castShadow = true; });
                zombieModel.position.set(0, 0, -18); // Kapƒ±nƒ±n arkasƒ±nda
                zombieModel.rotation.y = Math.PI;
                scene.add(zombieModel);
            }, undefined, () => {
                // Yedek Zombi
                const g = new THREE.CapsuleGeometry(0.6, 1.8);
                const m = new THREE.MeshStandardMaterial({color:0x00ff00});
                zombieModel = new THREE.Mesh(g,m);
                zombieModel.position.set(0, 0.9, -18);
                scene.add(zombieModel);
            });

            // Anahtar (Elde)
            loader.load('./Skeleton Key.glb', (gltf) => {
                keyModel = gltf.scene;
                keyModel.scale.set(0.5, 0.5, 0.5);
                keyModel.position.set(0.5, -0.5, -0.8);
                keyModel.rotation.set(0, 1.5, 0);
                camera.add(keyModel);
            });

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
        }

        function onKeyDown(e) {
            switch(e.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyD': moveRight = true; break;
                case 'ShiftLeft': isSprinting = true; break;
                case 'KeyE': interact(); break;
            }
        }
        function onKeyUp(e) {
            switch(e.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyD': moveRight = false; break;
                case 'ShiftLeft': isSprinting = false; break;
            }
        }

        function interact() {
            if(!hasKey || doorState !== 0) return;
            const dist = camera.position.distanceTo(doorGroup.position);
            if(dist < 5) {
                doorState = 1; // Animasyon ba≈ülasƒ±n
                keyAnimStart = performance.now();
                playSound('unlock');
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(isGameOver) return;

            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            prevTime = time;

            // --- KAPI MEKANƒ∞ƒûƒ∞ ---
            if(doorState === 1 && keyModel) {
                // Anahtar animasyonu
                const elapsed = (time - keyAnimStart) / 1000;
                // Anahtarƒ± ortaya kaydƒ±r
                keyModel.position.lerp(new THREE.Vector3(0, -0.1, -0.4), 0.1);
                keyModel.rotation.z += 6 * delta;

                if(elapsed > 1.2) {
                    doorState = 2;
                    keyModel.visible = false;
                    hasKey = false;
                    keyStatus.innerText = "YOK";
                    keyStatus.style.color = "red";
                    playSound('creak');
                    
                    // Zombi gecikmeli gelsin
                    setTimeout(() => {
                        chaseMode = true;
                        playSound('scream');
                        scene.fog.color.setHex(0x330000); // Sis kƒ±zarƒ±r
                    }, 500);
                }
            }

            if(doorState === 2) {
                // Kapƒ± a√ßƒ±lma
                if(doorGroup.rotation.y > -Math.PI/2) {
                    doorGroup.rotation.y -= 1.5 * delta;
                } else {
                    doorState = 3;
                }
            }

            // --- ZOMBƒ∞ KOVALAMACA ---
            if(chaseMode && zombieModel) {
                zombieModel.lookAt(camera.position.x, 0, camera.position.z);
                const speed = 7.2;
                const dir = new THREE.Vector3().subVectors(camera.position, zombieModel.position).normalize();
                
                zombieModel.position.x += dir.x * speed * delta;
                zombieModel.position.z += dir.z * speed * delta;
                // Y eksenini ellemiyoruz, zemin d√ºz

                if(camera.position.distanceTo(zombieModel.position) < 1.0) {
                    isGameOver = true;
                    controls.unlock();
                    gameOverDiv.style.display = 'flex';
                }
            }

            // --- OYUNCU HAREKET ---
            if(controls.isLocked) {
                const speed = (isSprinting && stamina > 0) ? 10.0 : 4.0;
                
                // Stamina mantƒ±ƒüƒ±
                if(isSprinting && (moveForward || moveBackward || moveRight || moveLeft)) {
                    stamina -= 30 * delta;
                    if(stamina < 0) stamina = 0;
                } else {
                    stamina += 15 * delta;
                    if(stamina > 100) stamina = 100;
                }
                staminaBar.style.width = stamina + '%';
                staminaBar.style.backgroundColor = stamina < 20 ? '#ff0000' : '#ffffff';

                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * speed * delta; // Hƒ±z fakt√∂r√º arttƒ±
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * speed * delta;

                controls.moveRight(-velocity.x * delta * 0.02);
                controls.moveForward(-velocity.z * delta * 0.02);

                // Adƒ±m sesi (Basit zamanlayƒ±cƒ±)
                if(moveForward || moveBackward || moveLeft || moveRight) {
                    stepTimer += delta * (isSprinting ? 15 : 10);
                    if(stepTimer > 5) {
                        playSound('step');
                        stepTimer = 0;
                        // Head bob
                        camera.position.y = 1.7 + Math.sin(time * 0.015) * 0.05;
                    }
                } else {
                    camera.position.y = THREE.MathUtils.lerp(camera.position.y, 1.7, 0.1);
                }

                // Raycaster (Etkile≈üim kontrol√º)
                const ray = new THREE.Raycaster();
                ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects([doorGroup], true);
                if(hits.length > 0 && hits[0].distance < 5 && doorState === 0 && hasKey) {
                    interactionUI.style.display = 'block';
                } else {
                    interactionUI.style.display = 'none';
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
