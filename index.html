<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Karanlƒ±k Koridor: Final Chapter</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        /* --- G√ñRSEL EFEKTLER (Shader Benzeri CSS Katmanlarƒ±) --- */
        
        /* 1. Vignette (K√∂≈üeleri Karartma) */
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 50%, rgba(0,0,0,0.9) 100%);
            pointer-events: none; z-index: 5;
        }

        /* 2. Film Grain (Kumlu G√∂r√ºnt√º Animasyonu) */
        #grain {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.1"/%3E%3C/svg%3E');
            pointer-events: none; z-index: 4;
            animation: grainAnim 0.5s steps(5) infinite;
            opacity: 0.4;
        }
        @keyframes grainAnim {
            0%, 100% { transform:translate(0, 0) }
            10% { transform:translate(-5%, -10%) }
            20% { transform:translate(-15%, 5%) }
            30% { transform:translate(7%, -25%) }
            40% { transform:translate(-5%, 25%) }
            50% { transform:translate(-15%, 10%) }
            60% { transform:translate(15%, 0%) }
            70% { transform:translate(0%, 15%) }
            80% { transform:translate(3%, 35%) }
            90% { transform:translate(-10%, 10%) }
        }

        /* ARAY√úZ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        #inventory { padding: 25px; color: #d4af37; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 5px #000; }
        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 16px; display: none; text-align: center; letter-spacing: 2px;
            text-shadow: 0 0 10px #ff0000;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: rgba(255, 255, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); z-index: 6;
            box-shadow: 0 0 4px #fff;
        }
        
        /* EKRANLAR */
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 999; pointer-events: all; color: #666;
        }
        #instructions { font-size: 24px; cursor: pointer; text-align: center; }
        #instructions span { color: #a00; font-size: 40px; font-weight: bold; }
        
        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #c00; z-index: 1000;
            justify-content: center; align-items: center; flex-direction: column;
            font-size: 100px; font-weight: bold; text-shadow: 0 0 30px #f00;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 50px red; } 100% { opacity: 0.8; } }

    </style>
</head>
<body>

    <div id="vignette"></div>
    <div id="grain"></div>
    
    <div id="game-over">√ñLD√úN</div>

    <div id="blocker">
        <div id="instructions">
            <span>BA≈ûLAT</span><br/><br/>
            Karanlƒ±k Koridor<br/>
            (Kulaklƒ±k Tak)
        </div>
    </div>

    <div id="crosshair"></div>

    <div id="ui-layer">
        <div id="inventory">ENVANTER: <span id="key-status">Skeleton Key</span> üóùÔ∏è</div>
        <div id="interaction">[E] Kƒ∞Lƒ∞Dƒ∞ A√á</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SES (Procedural) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'unlock') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(1000, now+0.1);
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.5);
                osc.start(); osc.stop(now+0.5);
            } else if (type === 'scream') {
                // Canavar sesi (Noise benzeri)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(800, now+0.2);
                // Mod√ºlasyon
                const lfo = audioCtx.createOscillator();
                lfo.frequency.value = 50;
                const lfoGain = audioCtx.createGain();
                lfoGain.gain.value = 500;
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                lfo.start(); lfo.stop(now+1);

                gain.gain.setValueAtTime(0.5, now);
                gain.gain.linearRampToValueAtTime(0, now+1.5);
                osc.start(); osc.stop(now+1.5);
            }
        }

        // --- DEƒûƒ∞≈ûKENLER ---
        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        let doorGroup = new THREE.Group();
        let zombieModel = null;
        let keyModel = null;

        // Oyun Durumu
        let hasKey = true;
        let doorState = 0; // 0:Kapalƒ±, 1:A√ßƒ±lƒ±yor
        let chaseMode = false;
        let isGameOver = false;

        // Ayarlar
        const ZOMBIE_SPEED = 9.0;
        const KILL_DISTANCE = 1.8; // Bu mesafeye girince √∂l√ºrs√ºn

        const interactionUI = document.getElementById('interaction');
        const blocker = document.getElementById('blocker');
        const instructions = document.getElementById('instructions');
        const gameOverScreen = document.getElementById('game-over');

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020202);
            // Korku sisi (Daha karanlƒ±k)
            scene.fog = new THREE.FogExp2(0x020202, 0.12);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.7, 10); // Kapƒ±dan uzakta ba≈üla

            // --- I≈ûIKLANDIRMA ---
            const ambient = new THREE.AmbientLight(0x404040, 0.1); // √áok lo≈ü
            scene.add(ambient);

            // El Feneri
            const flashLight = new THREE.SpotLight(0xffffff, 5, 30, Math.PI/6, 0.5, 2);
            flashLight.position.set(0, 0, 0);
            flashLight.target.position.set(0, 0, -1);
            flashLight.castShadow = true;
            flashLight.shadow.mapSize.width = 1024;
            flashLight.shadow.mapSize.height = 1024;
            camera.add(flashLight);
            camera.add(flashLight.target);
            scene.add(camera);

            controls = new PointerLockControls(camera, document.body);

            instructions.addEventListener('click', () => controls.lock());
            controls.addEventListener('lock', () => { blocker.style.display = 'none'; });
            controls.addEventListener('unlock', () => { if(!isGameOver) blocker.style.display = 'flex'; });

            // --- MAP ƒ∞N≈ûAATI (Koridor ve Duvarlar) ---
            const textureLoader = new THREE.TextureLoader();
            
            // Basit Texture √úretimi (Grid)
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,256,256);
            ctx.strokeStyle = '#333'; ctx.lineWidth=4; ctx.strokeRect(0,0,256,256);
            // Kan lekesi gibi detay
            ctx.fillStyle = '#300'; ctx.fillRect(50, 50, 20, 20);
            const wallTex = new THREE.CanvasTexture(canvas);
            wallTex.wrapS = THREE.RepeatWrapping; wallTex.wrapT = THREE.RepeatWrapping;
            wallTex.repeat.set(5, 5);

            const wallMat = new THREE.MeshStandardMaterial({ map: wallTex, roughness: 0.8 });

            // 1. Zemin
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(10, 50), wallMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // 2. Yan Duvarlar
            const wallLeft = new THREE.Mesh(new THREE.BoxGeometry(1, 6, 50), wallMat);
            wallLeft.position.set(-5.5, 3, 0);
            wallLeft.receiveShadow = true; wallLeft.castShadow = true;
            scene.add(wallLeft);

            const wallRight = new THREE.Mesh(new THREE.BoxGeometry(1, 6, 50), wallMat);
            wallRight.position.set(5.5, 3, 0);
            wallRight.receiveShadow = true; wallRight.castShadow = true;
            scene.add(wallRight);

            // 3. Tavan
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(10, 50), new THREE.MeshBasicMaterial({color:0x050505}));
            ceil.rotation.x = Math.PI / 2; ceil.position.y = 6;
            scene.add(ceil);

            // 4. KAPI DUVARI (End Wall) - √ñNEMLƒ∞: Zombiyi saklayan duvar
            // Kapƒ±nƒ±n olduƒüu yerde bir delik olmasƒ± i√ßin duvarƒ± 3 par√ßadan yapƒ±yoruz.
            const endWallZ = -15;
            
            // Sol Par√ßa
            const w1 = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 1), wallMat);
            w1.position.set(-3, 3, endWallZ);
            w1.castShadow = true; w1.receiveShadow = true;
            scene.add(w1);
            
            // Saƒü Par√ßa
            const w2 = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 1), wallMat);
            w2.position.set(3, 3, endWallZ);
            w2.castShadow = true; w2.receiveShadow = true;
            scene.add(w2);

            // √úst Par√ßa (Lintel)
            const w3 = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 1), wallMat);
            w3.position.set(0, 5, endWallZ); // Kapƒ±nƒ±n √ºst√º
            w3.castShadow = true; w3.receiveShadow = true;
            scene.add(w3);

            // --- MODELLER ---
            const loader = new GLTFLoader();

            // KAPI
            loader.load('./Door.glb', (gltf) => {
                const model = gltf.scene;
                // Kapƒ±yƒ± duvarƒ±n ortasƒ±ndaki bo≈üluƒüa yerle≈ütir
                model.position.set(0.5, 0, 0); // Pivot ayarƒ± (Modele g√∂re deƒüi≈üebilir)
                
                doorGroup.add(model);
                doorGroup.position.set(-0.5, 0, endWallZ); // Duvar hizasƒ±
                scene.add(doorGroup);
            }, undefined, (e) => {
                // Yedek Kapƒ± (Eƒüer dosya yoksa)
                const d = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 0.2), new THREE.MeshStandardMaterial({color:0x332211}));
                d.position.set(1, 2, 0);
                doorGroup.add(d);
                doorGroup.position.set(-1, 0, endWallZ);
                scene.add(doorGroup);
            });

            // ZOMBƒ∞ (Duvarƒ±n arkasƒ±nda saklƒ±)
            loader.load('./Zombie.glb', (gltf) => {
                zombieModel = gltf.scene;
                zombieModel.traverse(o => { if(o.isMesh) o.castShadow = true; });
                
                // Duvarƒ±n (-15) arkasƒ±nda ba≈ülatƒ±yoruz. G√∂z√ºkmemeli.
                zombieModel.position.set(0, 0, endWallZ - 3); 
                zombieModel.rotation.y = Math.PI; // Bize bakƒ±yor
                scene.add(zombieModel);
            }, undefined, () => {
                // Yedek Zombi
                zombieModel = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.8), new THREE.MeshStandardMaterial({color:0x00ff00}));
                zombieModel.position.set(0, 0.9, endWallZ - 3);
                scene.add(zombieModel);
            });

            // ANAHTAR (FPS)
            loader.load('./Skeleton Key.glb', (gltf) => {
                keyModel = gltf.scene;
                keyModel.scale.set(0.5, 0.5, 0.5);
                keyModel.position.set(0.5, -0.5, -0.8);
                keyModel.rotation.set(0, 1.5, 0);
                camera.add(keyModel);
            });

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; // G√∂lgeler a√ßƒ±k
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
        }

        function onKeyDown(e) {
            switch(e.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyD': moveRight = true; break;
                case 'KeyE': interact(); break;
            }
        }
        function onKeyUp(e) {
            switch(e.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyD': moveRight = false; break;
            }
        }

        function interact() {
            if(!hasKey || doorState !== 0) return;
            // Kapƒ±ya mesafe kontrol√º
            if(camera.position.distanceTo(doorGroup.position) < 4) {
                startDoorEvent();
            }
        }

        function startDoorEvent() {
            doorState = 1; // A√ßƒ±lma ba≈üladƒ±
            hasKey = false;
            if(keyModel) keyModel.visible = false;
            document.getElementById('key-status').innerText = "YOK";
            document.getElementById('key-status').style.color = "red";
            
            playSound('unlock');
            playSound('scream'); // √áƒ±ƒülƒ±k
        }

        function animate() {
            if(isGameOver) return; // Oyun bittiyse d√∂ng√ºy√º durdur
            
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            prevTime = time;

            // --- KAPI HAREKETƒ∞ ---
            if(doorState === 1) {
                // Kapƒ± yava≈ü√ßa a√ßƒ±lƒ±yor
                if(doorGroup.rotation.y > -Math.PI / 1.5) {
                    doorGroup.rotation.y -= 2 * delta;
                } else {
                    // Kapƒ± tamamen a√ßƒ±lƒ±nca Zombi aktifle≈üir
                    chaseMode = true;
                }
            }

            // --- ZOMBƒ∞ YAPAY ZEKASI (GERƒ∞Cƒ∞ HAREKETLER) ---
            if(chaseMode && zombieModel) {
                // 1. Bize d√∂n
                zombieModel.lookAt(camera.position.x, 0, camera.position.z);
                
                // 2. Hareket (Ko≈üma)
                const dir = new THREE.Vector3().subVectors(camera.position, zombieModel.position).normalize();
                zombieModel.position.x += dir.x * ZOMBIE_SPEED * delta;
                zombieModel.position.z += dir.z * ZOMBIE_SPEED * delta;

                // 3. Glitch Efekti (Gerici titreme)
                // Zombi ko≈üarken rastgele saƒüa sola ƒ±≈üƒ±nlanƒ±r gibi titresin
                if(Math.random() > 0.8) {
                    zombieModel.position.x += (Math.random() - 0.5) * 0.2;
                }

                // 4. √ñLD√úRME KONTROL√ú
                const dist = camera.position.distanceTo(zombieModel.position);
                if(dist < KILL_DISTANCE) {
                    gameOver();
                }
            }

            // --- OYUNCU HAREKETƒ∞ ---
            if(controls.isLocked) {
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

                controls.moveRight(-velocity.x * delta * 0.015);
                controls.moveForward(-velocity.z * delta * 0.015);

                // UI Kontrol√º (Raycaster)
                const ray = new THREE.Raycaster();
                ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects([doorGroup], true);
                if(hits.length > 0 && hits[0].distance < 4 && doorState === 0 && hasKey) {
                    interactionUI.style.display = 'block';
                } else {
                    interactionUI.style.display = 'none';
                }
            }

            renderer.render(scene, camera);
        }

        function gameOver() {
            isGameOver = true;
            controls.unlock();
            gameOverScreen.style.display = 'flex';
            // Ekranƒ± kƒ±rmƒ±zƒ±ya boya (Korku efekti)
            document.body.style.backgroundColor = "#500";
        }

    </script>
</body>
</html>
