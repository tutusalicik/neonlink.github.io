<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>PROJECT: OUTLAST PROTOCOL</title>
    <style>
        /* --- CAMCORDER LENS EFEKTİ & GENEL STİL --- */
        body { 
            margin: 0; overflow: hidden; background: #020202; 
            font-family: 'Courier New', Courier, monospace; /* Dijital kamera fontu */
            user-select: none;
            /* Tüm ekrana eski kamera filtresi uygula */
            filter: contrast(1.1) sepia(0.2) saturate(0.9);
        }
        
        /* --- SİNEMATİK KATMANLAR --- */
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 40%, rgba(0,0,0,0.9) 100%);
            pointer-events: none; z-index: 5; mix-blend-mode: multiply;
        }
        /* Scanlines (Tarama Çizgileri) Efekti */
        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(to bottom, transparent 0px, transparent 2px, rgba(0,0,0,0.1) 3px);
            pointer-events: none; z-index: 6;
        }
        #blood-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circleAt center, transparent 50%, rgba(180, 0, 0, 0.6) 100%);
            opacity: 0; transition: opacity 0.3s; z-index: 7; pointer-events: none;
        }

        /* --- CAMCORDER UI (REC) --- */
        #camcorder-ui {
            position: absolute; top: 20px; left: 30px; color: #ff3333;
            font-size: 20px; font-weight: bold; z-index: 20; display: flex; align-items: center;
            text-shadow: 0 0 5px #ff0000;
        }
        .blink-dot {
            width: 15px; height: 15px; background: #ff3333; border-radius: 50%;
            margin-right: 10px; animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
        #time-code {
            position: absolute; top: 20px; right: 30px; color: #fff;
            font-size: 20px; font-family: monospace; z-index: 20; text-shadow: 1px 1px 2px #000;
        }

        /* --- OYUN İÇİ UI --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 15; }

        /* Altyazı (Outlast Tarzı) */
        #subtitle-box {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
        }
        #subtitle-text {
            display: inline-block; background: rgba(0, 0, 0, 0.8); color: #fff;
            padding: 12px 24px; font-size: 22px; font-style: italic; font-family: 'Segoe UI', Tahoma, sans-serif;
            border-left: 4px solid #ff3333; opacity: 0; transition: opacity 0.8s;
            max-width: 60%; line-height: 1.4; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Mermi */
        #weapon-hud {
            position: absolute; bottom: 30px; right: 40px; text-align: right; color: #fff;
        }
        #ammo-count { font-size: 70px; font-weight: 900; color: #ff3333; font-family: Impact, sans-serif; }

        /* Etkileşim */
        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; background: rgba(50,0,0,0.8); padding: 10px 20px; 
            border: 1px solid #ff3333; font-size: 16px; display: none;
        }

        /* Menü */
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #080808; color: #ccc;
            display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999;
        }
        #start-btn {
            font-size: 30px; color: #ff3333; border: 2px solid #ff3333; padding: 15px 40px; 
            cursor: pointer; letter-spacing: 5px; transition: 0.3s;
        }
        #start-btn:hover { background: #ff3333; color: #000; }

    </style>
</head>
<body>

    <div id="vignette"></div>
    <div id="scanlines"></div>
    <div id="blood-overlay"></div>

    <div id="camcorder-ui"><div class="blink-dot"></div>REC</div>
    <div id="time-code">00:00:00:00</div>

    <div id="blocker">
        <h1 style="color:#ff3333; letter-spacing: 10px; margin-bottom: 40px;">OUTLAST PROTOCOL</h1>
        <div id="start-btn">KAYDI BAŞLAT</div>
        <p style="margin-top:20px;">(W,A,S,D Hareket | SHIFT Koş | SOL TIK Ateş | SAĞ TIK Zoom | E Kullan)</p>
    </div>

    <div id="ui-layer">
        <div style="position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: rgba(255,255,255,0.5); transform: translate(-50%,-50%); border-radius: 50%;"></div>
        <div id="subtitle-box"><div id="subtitle-text"></div></div>
        <div id="interaction">[E] KAPIYI İNCELE</div>
        <div id="weapon-hud"><div id="ammo-count">15</div>PROTOTYPE</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const CONFIG = {
            walkSpeed: 5.0, runSpeed: 11.0, weaponSway: 0.06, recoilForce: 0.12,
            zombieHP: 5, zombieSpeed: 7.0
        };

        let camera, scene, renderer, controls;
        let moveF=false, moveB=false, moveL=false, moveR=false, isSprint=false;
        let prevTime = performance.now();
        let velocity = new THREE.Vector3();
        
        let hasKey = false;
        let doorOpen = false;
        let canShoot = true;
        let isAiming = false;
        let ammo = 15;
        let startTime = Date.now();

        let weaponContainer = new THREE.Group();
        let muzzleLight, doorGroup = new THREE.Group(), keyModel, zombie = {mesh:null, hp:5, state:'IDLE'};
        let redAlarmLight; // Titreyen kırmızı ışık

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const uiSub = document.getElementById('subtitle-text');
        const timeCodeEl = document.getElementById('time-code');

        init(); animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020202);
            // Daha az yoğun, daha ürkütücü sis
            scene.fog = new THREE.FogExp2(0x020202, 0.025);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.y = 1.7;

            // --- AYDINLATMA (OUTLAST STİLİ) ---
            // 1. Ortam Işığı (Artırıldı, artık zifiri karanlık değil)
            const ambient = new THREE.AmbientLight(0x333344, 0.4); 
            scene.add(ambient);
            
            // 2. Oyuncu Kamera Işığı (Soğuk LED Panel Hissi)
            const flash = new THREE.SpotLight(0xaaccff, 6, 60, Math.PI/4.5, 0.4, 1);
            flash.position.set(0,0,0); flash.target.position.set(0,0,-1);
            flash.castShadow = true;
            camera.add(flash); camera.add(flash.target);

            // 3. Çevresel Titreyen Kırmızı Işık (Atmosfer için)
            redAlarmLight = new THREE.PointLight(0xff0000, 2, 20);
            redAlarmLight.position.set(0, 4, -15); // Kapının oralarda
            scene.add(redAlarmLight);

            camera.add(weaponContainer);
            weaponContainer.position.set(0.25, -0.3, -0.5);
            scene.add(camera);

            createLevel();
            createProceduralGun();
            setupMuzzleFlash();

            const loader = new GLTFLoader();
            // GLB Yüklemeleri (Dosya varsa kullanır, yoksa procedural kalır)
            loader.load(encodeURI('./Rigged Glock 19.glb'), (g)=>{
                while(weaponContainer.children.length>1) weaponContainer.remove(weaponContainer.children[0]);
                g.scene.scale.set(50,50,50); g.scene.rotation.y=Math.PI;
                weaponContainer.add(g.scene); setupMuzzleFlash();
            }, undefined, ()=>{}); // Hata olursa sessizce devam et (Procedural silah zaten var)

            loader.load('./Door.glb', (g)=>{doorGroup.add(g.scene);}, undefined, ()=>createFallbackDoor());
            loader.load('./Zombie.glb', (g)=>{zombie.mesh=g.scene; setupZombie();}, undefined, ()=>createFallbackZombie());
            loader.load('./Skeleton Key.glb', (g)=>{keyModel=g.scene; setupKey();}, undefined, ()=>createFallbackKey());

            controls = new PointerLockControls(camera, document.body);
            document.getElementById('start-btn').addEventListener('click', ()=>{
                controls.lock(); if(audioCtx.state==='suspended') audioCtx.resume();
            });
            controls.addEventListener('lock', ()=>{
                document.getElementById('blocker').style.display='none';
                startTime = Date.now();
                // HİKAYE BAŞLANGICI (İç Monolog)
                triggerSubtitle("(Nefes nefese) Tanrım... Başım çatlıyor. Neresi burası? Lanet olası kamera hala kayıtta mı?", 5000);
                setTimeout(() => triggerSubtitle("Hava buz gibi... ve içerisi leş gibi kokuyor. Bir çıkış yolu bulmalıyım.", 4000), 6000);
            });
            controls.addEventListener('unlock', ()=>{document.getElementById('blocker').style.display='flex';});

            document.addEventListener('keydown', onKeyDown); document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousedown', onMouseDown); document.addEventListener('mouseup', onMouseUp);

            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);
            window.addEventListener('resize', onWindowResize);
        }

        // --- PROSEDÜREL DÜNYA ---
        function createLevel() {
            // Daha kirli, betonumsu duvar dokusu
            const canvas = document.createElement('canvas'); canvas.width=512; canvas.height=512; const ctx=canvas.getContext('2d');
            ctx.fillStyle='#1a1a1a'; ctx.fillRect(0,0,512,512);
            for(let i=0; i<5000; i++) { ctx.fillStyle = Math.random()>0.5?'#222':'#111'; ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2); }
            // Duvarlara kan sıçraması
            for(let i=0;i<5;i++){ctx.fillStyle='rgba(100,0,0,0.4)'; ctx.beginPath(); ctx.arc(Math.random()*512, Math.random()*512, Math.random()*50+20,0,Math.PI*2); ctx.fill();}
            
            const tex = new THREE.CanvasTexture(canvas); tex.wrapS=tex.wrapT=THREE.RepeatWrapping; tex.repeat.set(5,5);
            const mat = new THREE.MeshStandardMaterial({map:tex, roughness:0.9, bumpMap:tex, bumpScale:0.02});

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(30,60), mat); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(30,60), mat); ceil.rotation.x=Math.PI/2; ceil.position.y=8; scene.add(ceil);

            const createWall=(x,y,z,w,h,d)=>{const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat); m.position.set(x,y,z); m.castShadow=true; m.receiveShadow=true; scene.add(m);}
            createWall(-8, 4, 0, 1, 8, 60); createWall(8, 4, 0, 1, 8, 60); createWall(0, 4, 30, 16, 8, 1);
            
            const doorZ = -20;
            createWall(-5, 4, doorZ, 7, 8, 1); createWall(5, 4, doorZ, 7, 8, 1); createWall(0, 7, doorZ, 3, 2, 1);
            doorGroup.position.set(0,0,doorZ); scene.add(doorGroup);
        }

        function createProceduralGun() {
            const matBody = new THREE.MeshStandardMaterial({color:0x222222, roughness:0.3});
            const root=new THREE.Group();
            const body=new THREE.Mesh(new THREE.BoxGeometry(0.08,0.1,0.4),matBody);
            const barrel=new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.42),matBody); barrel.rotation.x=Math.PI/2; barrel.position.y=0.03;
            root.add(body,barrel); weaponContainer.add(root);
        }
        function setupMuzzleFlash() { muzzleLight=new THREE.PointLight(0xffaa00,0,8); muzzleLight.position.set(0,0.1,-0.5); weaponContainer.add(muzzleLight); }
        function createFallbackDoor(){const d=new THREE.Mesh(new THREE.BoxGeometry(3,6,0.2),new THREE.MeshStandardMaterial({color:0x333})); d.position.y=3; doorGroup.add(d);}
        function setupZombie(){zombie.mesh.position.set(0,0,-26); zombie.mesh.rotation.y=Math.PI; scene.add(zombie.mesh);}
        function createFallbackZombie(){zombie.mesh=new THREE.Mesh(new THREE.CapsuleGeometry(0.6,1.8),new THREE.MeshStandardMaterial({color:0x550000})); setupZombie();}
        function setupKey(){keyModel.position.set(6,0.5,15); keyModel.scale.set(0.5,0.5,0.5); scene.add(keyModel); const l=new THREE.PointLight(0xff0000,1,2); keyModel.add(l);}
        function createFallbackKey(){keyModel=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3),new THREE.MeshBasicMaterial({color:0xff0000})); setupKey();}

        function onKeyDown(e){switch(e.code){case 'KeyW':moveF=true;break;case 'KeyA':moveL=true;break;case 'KeyS':moveB=true;break;case 'KeyD':moveR=true;break;case 'ShiftLeft':isSprint=true;break;case 'KeyE':interact();break;}}
        function onKeyUp(e){switch(e.code){case 'KeyW':moveF=false;break;case 'KeyA':moveL=false;break;case 'KeyS':moveB=false;break;case 'KeyD':moveR=false;break;case 'ShiftLeft':isSprint=false;break;}}
        function onMouseDown(e){if(!controls.isLocked)return; if(e.button===0)fireWeapon(); if(e.button===2)isAiming=true;}
        function onMouseUp(e){if(e.button===2)isAiming=false;}

        function interact() {
            if(!hasKey && keyModel && camera.position.distanceTo(keyModel.position)<3) {
                hasKey=true; keyModel.visible=false;
                playSound('PICKUP');
                triggerSubtitle("Bu... bir morg anahtarı. Tanrım, burada ne haltlar dönüyor?", 4000);
                return;
            }
            if(hasKey && !doorOpen && camera.position.distanceTo(doorGroup.position)<5) {
                doorOpen=true; playSound('DOOR');
                triggerSubtitle("(Korkuyla fısıldar) Kapının arkasında... bir şey nefes alıyor...", 4000);
                setTimeout(()=>{zombie.state='CHASE'; playSound('SCREAM');}, 1500);
            } else if (!hasKey && camera.position.distanceTo(doorGroup.position)<5) {
                 triggerSubtitle("Kilitli. Lanet olsun, açılmıyor! Anahtarı bulmalıyım.", 3000);
            }
        }

        function fireWeapon() {
            if(!canShoot||ammo<=0){if(ammo<=0)triggerSubtitle("Şarjör boş! Olamaz!",2000); return;}
            canShoot=false; ammo--; document.getElementById('ammo-count').innerText=ammo;
            playSound('SHOOT');
            if(muzzleLight){muzzleLight.intensity=8; setTimeout(()=>muzzleLight.intensity=0,50);}
            camera.rotation.x+=CONFIG.recoilForce; weaponContainer.position.z+=0.15; weaponContainer.rotation.x+=0.1;
            
            const ray=new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0),camera);
            if(zombie.state!=='DEAD' && zombie.mesh){
                if(ray.intersectObject(zombie.mesh,true).length>0) hitZombie();
            }
            setTimeout(()=>canShoot=true, 120);
        }

        function hitZombie() {
            zombie.hp--; playSound('HIT'); zombie.mesh.position.z-=0.4;
            if(zombie.hp<=0){
                zombie.state='DEAD'; zombie.mesh.rotation.x=-Math.PI/2; zombie.mesh.position.y=0.5;
                triggerSubtitle("(Titreyerek) Öldü mü? Hareket etmiyor... Kaydı durdurmalı mıyım?", 5000);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - lastTime) / 1000;
            lastTime = time;

            // Time Code Güncelleme
            const elapsed = Date.now() - startTime;
            const ms = Math.floor((elapsed % 1000) / 10);
            const s = Math.floor((elapsed / 1000) % 60);
            const m = Math.floor((elapsed / (1000 * 60)) % 60);
            timeCodeEl.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}:${ms.toString().padStart(2,'0')}`;

            // Kırmızı Alarm Işığı Titremesi
            if(redAlarmLight) redAlarmLight.intensity = 1 + Math.sin(time * 0.01) * Math.random() * 3;

            if(controls.isLocked) {
                const speed = isSprint ? CONFIG.runSpeed : CONFIG.walkSpeed;
                velocity.x -= velocity.x*10.0*delta; velocity.z -= velocity.z*10.0*delta;
                direction.z = Number(moveF)-Number(moveB); direction.x = Number(moveR)-Number(moveL); direction.normalize();
                if(moveF||moveB) velocity.z -= direction.z*speed*delta;
                if(moveL||moveR) velocity.x -= direction.x*speed*delta;
                controls.moveRight(-velocity.x*delta); controls.moveForward(-velocity.z*delta);

                const isMoving = moveF||moveB||moveL||moveR;
                const targetPos = isAiming ? new THREE.Vector3(0,-0.21,-0.4) : new THREE.Vector3(0.25,-0.3,-0.5);
                if(isMoving){ targetPos.y+=Math.sin(time*0.01)*0.003; targetPos.x+=Math.cos(time*0.005)*0.003; }
                weaponContainer.position.lerp(targetPos, 10*delta);
                if(camera.rotation.x>0) camera.rotation.x -= 1*delta;

                if(doorOpen && doorGroup.rotation.y > -Math.PI/1.5) doorGroup.rotation.y -= 1.5*delta;

                if(zombie.state==='CHASE' && zombie.mesh){
                    zombie.mesh.lookAt(camera.position.x,0,camera.position.z);
                    zombie.mesh.position.add(new THREE.Vector3().subVectors(camera.position,zombie.mesh.position).normalize().multiplyScalar(CONFIG.zombieSpeed*delta));
                    if(camera.position.distanceTo(zombie.mesh.position)<1.5){
                        document.getElementById('blood-overlay').style.opacity=1; setTimeout(()=>document.getElementById('blood-overlay').style.opacity=0,800);
                        playSound('SCREAM');
                        velocity.add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(-15)); // Geri itilme
                    }
                }

                const ray=new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(),camera);
                const hitsD=ray.intersectObjects([doorGroup],true); const hitsK=keyModel?ray.intersectObject(keyModel):[];
                const showP=(hitsD.length>0 && hitsD[0].distance<5 && !doorOpen) || (hitsK.length>0 && hitsK[0].distance<3 && !hasKey);
                document.getElementById('interaction').style.display = showP?'block':'none';
            }
            renderer.render(scene, camera);
        }

        function playSound(t) {
            const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); const ct=audioCtx.currentTime;
            if(t==='SHOOT'){o.type='sawtooth';o.frequency.setValueAtTime(120,ct);g.gain.exponentialRampToValueAtTime(0.01,ct+0.2);o.start();o.stop(ct+0.2);}
            else if(t==='DOOR'){o.type='square';o.frequency.setValueAtTime(50,ct);g.gain.linearRampToValueAtTime(0,ct+1.5);o.start();o.stop(ct+1.5);}
            else if(t==='SCREAM'){o.type='sawtooth';o.frequency.linearRampToValueAtTime(600,ct+0.5);g.gain.linearRampToValueAtTime(0,ct+0.8);o.start();o.stop(ct+0.8);}
            else if(t==='PICKUP'){o.type='sine';o.frequency.linearRampToValueAtTime(800,ct+0.2);g.gain.linearRampToValueAtTime(0,ct+0.2);o.start();o.stop(ct+0.2);}
        }
        function triggerSubtitle(txt,dur){uiSub.innerText=txt; uiSub.style.opacity=1; setTimeout(()=>uiSub.style.opacity=0,dur);}
        function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);}
    </script>
</body>
</html>
