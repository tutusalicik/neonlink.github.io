<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CS2 WEB - ROOT DIR</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; user-select: none; }
        
        /* Loading Screen */
        #loader-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #de9b35; }
        .bar-container { width: 300px; height: 5px; background: #333; margin: 20px 0; }
        .bar-fill { height: 100%; width: 0%; background: #de9b35; transition: width 0.2s; }
        #error-log { margin-top: 20px; color: #ff5555; font-size: 12px; font-family: monospace; max-width: 80%; text-align: center; }
        #force-start-btn { display: none; margin-top: 20px; padding: 10px 20px; background: #de9b35; border: none; font-weight: bold; cursor: pointer; }

        /* Game UI */
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; display: none; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #0f0; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: 0 0 3px #000; }
        #hud-ammo { position: absolute; bottom: 30px; right: 30px; font-size: 40px; color: #de9b35; font-weight: 900; text-shadow: 2px 2px 0 #000; }
        #hud-health { position: absolute; bottom: 30px; left: 30px; font-size: 40px; color: #fff; font-weight: 900; text-shadow: 2px 2px 0 #000; }

        /* Menu */
        #menu { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        h1 { color: #fff; font-size: 60px; margin-bottom: 20px; letter-spacing: -2px; }
        button { padding: 15px 50px; font-size: 20px; cursor: pointer; background: transparent; border: 2px solid #de9b35; color: #fff; margin: 10px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #de9b35; color: #000; }
    </style>
</head>
<body>

    <div id="loader-screen">
        <h2>ENGINE LOADING...</h2>
        <div class="bar-container"><div class="bar-fill" id="bar-fill"></div></div>
        <div id="status-text">Assets initializing...</div>
        <div id="error-log"></div>
        <button id="force-start-btn" onclick="Game.forceStart()">SORUNLU BAŞLAT (FORCE START)</button>
    </div>

    <div id="menu">
        <h1>CS:ROOT</h1>
        <button onclick="Game.startMatch()">OYUNA GİR</button>
        <div style="color: #aaa; margin-top:10px;">WASD: Git | R: Şarjör | Sol Tık: Ateş</div>
    </div>

    <div id="ui-layer">
        <div id="crosshair"></div>
        <div id="hud-health">100</div>
        <div id="hud-ammo">20 <span style="font-size:14px; color:#aaa;">/ 90</span></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // ==========================================
        // GAME CONFIG & STATE
        // ==========================================
        const Config = {
            files: {
                map: './map.glb',     // AYNI KLASÖRDE OLDUĞU İÇİN ./
                weapon: './Pistol.glb',
                player: './guy.glb'
            }
        };

        const State = {
            hp: 100,
            ammo: 20,
            isMoving: false,
            canShoot: true
        };

        // ==========================================
        // ENGINE CORE
        // ==========================================
        const Engine = {
            scene: null, camera: null, renderer: null, controls: null,
            assets: {},
            clock: new THREE.Clock(),
            
            // Silah Objesi
            weaponContainer: new THREE.Group(),
            weaponMesh: null,
            recoil: 0,
            
            init: async () => {
                Engine.scene = new THREE.Scene();
                Engine.scene.background = new THREE.Color(0x222222);
                Engine.scene.fog = new THREE.Fog(0x222222, 10, 60);

                Engine.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                Engine.renderer = new THREE.WebGLRenderer({ antialias: true });
                Engine.renderer.setSize(window.innerWidth, window.innerHeight);
                Engine.renderer.shadowMap.enabled = true;
                document.body.appendChild(Engine.renderer.domElement);

                // Işıklar
                const ambLight = new THREE.AmbientLight(0xffffff, 0.5);
                Engine.scene.add(ambLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(10, 20, 10);
                dirLight.castShadow = true;
                Engine.scene.add(dirLight);

                // Kontroller
                Engine.controls = new PointerLockControls(Engine.camera, document.body);

                // Silah Konteyneri (Kameraya bağlı)
                Engine.camera.add(Engine.weaponContainer);
                Engine.scene.add(Engine.camera);

                // Yükleme Başlat
                await Engine.loadAssets();
            },

            loadAssets: () => {
                const loader = new GLTFLoader();
                const items = Object.entries(Config.files);
                let loadedCount = 0;
                const total = items.length;

                // Zaman aşımı kontrolü (5 saniye yüklenmezse buton çıkar)
                setTimeout(() => {
                    if(loadedCount < total) {
                        document.getElementById('error-log').innerText = "UYARI: Modeller yüklenemedi veya çok yavaş. Dosya isimlerini kontrol et veya 'Force Start' yap.";
                        document.getElementById('force-start-btn').style.display = 'block';
                    }
                }, 5000);

                const checkDone = () => {
                    loadedCount++;
                    document.getElementById('bar-fill').style.width = (loadedCount / total * 100) + '%';
                    if(loadedCount === total) {
                        setTimeout(Game.onLoadComplete, 500);
                    }
                };

                items.forEach(([key, url]) => {
                    loader.load(url, 
                        (gltf) => {
                            Engine.assets[key] = gltf.scene;
                            console.log(key + " yüklendi.");
                            checkDone();
                        },
                        undefined,
                        (err) => {
                            console.error("Yükleme Hatası:", err);
                            document.getElementById('status-text').innerText = "Hata: " + url + " bulunamadı!";
                            // Hata olsa bile oyunun açılması için placeholder oluştur
                            const box = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:0xff0000}));
                            Engine.assets[key] = box; 
                            checkDone(); // Hata olsa da devam et
                        }
                    );
                });
            }
        };

        // ==========================================
        // GAMEPLAY LOGIC
        // ==========================================
        const Game = {
            velocity: new THREE.Vector3(),
            direction: new THREE.Vector3(),
            move: { f: false, b: false, l: false, r: false },

            forceStart: () => {
                Game.onLoadComplete();
            },

            onLoadComplete: () => {
                document.getElementById('loader-screen').style.display = 'none';
                document.getElementById('menu').style.display = 'flex';
                Game.setupWorld();
            },

            setupWorld: () => {
                // Harita
                const map = Engine.assets.map;
                map.traverse(n => { if(n.isMesh) { n.receiveShadow = true; n.castShadow = true; } });
                Engine.scene.add(map);

                // Silah Ayarı
                const pistol = Engine.assets.weapon;
                pistol.scale.set(1, 1, 1); // Silah çok büyükse burayı 0.1 yap
                pistol.rotation.y = Math.PI; // Silah tersse burayı sil veya değiştir
                pistol.position.set(0.2, -0.2, -0.4); // Kameraya göre konumu
                Engine.weaponMesh = pistol;
                Engine.weaponContainer.add(pistol);

                // Düşman (Örnek)
                const enemy = Engine.assets.player.clone();
                enemy.position.set(5, 0, 5);
                Engine.scene.add(enemy);

                Game.setupInputs();
                Game.animate();
            },

            startMatch: () => {
                document.getElementById('menu').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                Engine.controls.lock();
                Engine.camera.position.y = 1.6;
            },

            setupInputs: () => {
                document.addEventListener('keydown', (e) => {
                    switch(e.code) {
                        case 'KeyW': Game.move.f = true; break;
                        case 'KeyS': Game.move.b = true; break;
                        case 'KeyA': Game.move.l = true; break;
                        case 'KeyD': Game.move.r = true; break;
                        case 'KeyR': Game.reload(); break;
                    }
                });
                document.addEventListener('keyup', (e) => {
                    switch(e.code) {
                        case 'KeyW': Game.move.f = false; break;
                        case 'KeyS': Game.move.b = false; break;
                        case 'KeyA': Game.move.l = false; break;
                        case 'KeyD': Game.move.r = false; break;
                    }
                });
                document.addEventListener('mousedown', () => {
                    if(Engine.controls.isLocked) Game.shoot();
                });
            },

            shoot: () => {
                if(State.ammo <= 0) return;
                
                State.ammo--;
                document.getElementById('hud-ammo').innerText = State.ammo;
                
                // Recoil (Geri tepme)
                Engine.recoil += 0.1;
                
                // Silah animasyonu (Geri git gel)
                if(Engine.weaponMesh) {
                    Engine.weaponMesh.position.z += 0.1;
                    setTimeout(() => Engine.weaponMesh.position.z -= 0.1, 50);
                }
            },

            reload: () => {
                State.ammo = 20;
                document.getElementById('hud-ammo').innerText = "R...";
                setTimeout(() => {
                    document.getElementById('hud-ammo').innerText = State.ammo;
                }, 1000);
            },

            animate: () => {
                requestAnimationFrame(Game.animate);
                
                const delta = Math.min(Engine.clock.getDelta(), 0.1);

                // --- FİZİK VE HAREKET ---
                Game.velocity.x -= Game.velocity.x * 10.0 * delta;
                Game.velocity.z -= Game.velocity.z * 10.0 * delta;
                // Game.velocity.y -= 9.8 * delta; // Yerçekimi kapalı şimdilik (Map collider olmadığı için düşersin)

                Game.direction.z = Number(Game.move.f) - Number(Game.move.b);
                Game.direction.x = Number(Game.move.r) - Number(Game.move.l);
                Game.direction.normalize();

                if (Game.move.f || Game.move.b) Game.velocity.z -= Game.direction.z * 40.0 * delta;
                if (Game.move.l || Game.move.r) Game.velocity.x -= Game.direction.x * 40.0 * delta;

                Engine.controls.moveRight(-Game.velocity.x * delta);
                Engine.controls.moveForward(-Game.velocity.z * delta);

                // --- SİLAH SALLANMASI (SWAY & BOB) ---
                if(Engine.weaponContainer) {
                    // Yürürken sallanma (Bobbing)
                    const isMoving = Game.move.f || Game.move.b || Game.move.l || Game.move.r;
                    const time = Date.now() * 0.01;
                    
                    if(isMoving) {
                        Engine.weaponContainer.position.y = Math.sin(time) * 0.005; 
                        Engine.weaponContainer.position.x = Math.cos(time * 0.5) * 0.005;
                    } else {
                        // Dururken nefes alma efekti
                        Engine.weaponContainer.position.y = Math.sin(time * 0.5) * 0.002;
                        Engine.weaponContainer.position.x = 0;
                    }

                    // Recoil Recovery
                    Engine.recoil = Math.max(0, Engine.recoil - delta * 2);
                    Engine.camera.rotation.x += Engine.recoil * delta * 0.5; // Kamerayı yukarı kaldırır
                    Engine.weaponContainer.rotation.x = Engine.recoil; 
                }

                Engine.renderer.render(Engine.scene, Engine.camera);
            }
        };

        // Window Helper
        window.Game = Game;
        Engine.init();

    </script>
</body>
</html>
