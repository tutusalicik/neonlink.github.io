<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Karanlık Koridor: FINAL FIX</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; user-select: none; font-family: Arial, sans-serif; }
        
        /* UI */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: #0f0; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10;
            box-shadow: 0 0 5px #0f0;
        }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        #inventory { position: absolute; top: 20px; left: 20px; color: gold; font-size: 24px; font-weight: bold; text-shadow: 1px 1px 0 #000; }
        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; background: rgba(0,0,0,0.8); padding: 15px; border: 2px solid white; display: none;
        }
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #111; color: #fff;
            display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999;
        }
        #msg { font-size: 50px; color: red; font-weight: bold; margin-bottom: 20px; }
        #debug { position: absolute; bottom: 10px; left: 10px; color: lime; font-family: monospace; }
    </style>
</head>
<body>
    <div id="blocker">
        <div id="msg">TIKLA VE BAŞLA</div>
        <div>W,A,S,D = Hızlı Hareket | SHIFT = Uçuş Modu | E = Kapı</div>
    </div>
    <div id="crosshair"></div>
    <div id="ui-layer">
        <div id="inventory">DURUM: Anahtarı Bul</div>
        <div id="interaction">[E] KAPIYI AÇ</div>
        <div id="debug">Sistem Hazır...</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- AYARLAR ---
        const SILAH_BOYUTU = 100.0; // Silah görünmezse burayı değiştir (0.1, 1, 10, 100 dene)
        const HIZ_YURUME = 2500.0;  // İnanılmaz hızlandırdım
        const HIZ_KOSMA = 5000.0;   // Uçak hızı

        let camera, scene, renderer, controls;
        let moveF=false, moveB=false, moveL=false, moveR=false, isSprint=false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        let doorGroup = new THREE.Group();
        let zombieModel, keyModel, glockModel, dummyGun;
        let hasKey=true, hasGun=false, doorState=0, zombieState=0, zombieHP=3;
        let canShoot=true;

        const debugDiv = document.getElementById('debug');

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);
            scene.fog = new THREE.FogExp2(0x111111, 0.05);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.7, 10);

            // IŞIKLAR (GÖRÜNMESİ İÇİN GÜÇLÜ)
            const ambient = new THREE.AmbientLight(0xffffff, 0.8); 
            scene.add(ambient);
            const flash = new THREE.SpotLight(0xffffff, 2, 50, Math.PI/4);
            flash.position.set(0,0,0); flash.target.position.set(0,0,-1);
            camera.add(flash); camera.add(flash.target); scene.add(camera);

            controls = new PointerLockControls(camera, document.body);
            document.getElementById('blocker').addEventListener('click', ()=>controls.lock());
            controls.addEventListener('lock', ()=>document.getElementById('blocker').style.display='none');
            controls.addEventListener('unlock', ()=>document.getElementById('blocker').style.display='flex');

            // --- ORTAM ---
            const mat = new THREE.MeshStandardMaterial({color: 0x444444});
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(20,100), mat); floor.rotation.x=-Math.PI/2; scene.add(floor);
            
            // Duvarlar
            const wGeo = new THREE.BoxGeometry(1,10,100);
            const w1 = new THREE.Mesh(wGeo, mat); w1.position.set(-10,5,0); scene.add(w1);
            const w2 = new THREE.Mesh(wGeo, mat); w2.position.set(10,5,0); scene.add(w2);

            // Kapı Duvarı
            const endZ = -20;
            const dw = new THREE.Mesh(new THREE.BoxGeometry(8,10,1), mat); dw.position.set(-6,5,endZ); scene.add(dw);
            const dw2 = new THREE.Mesh(new THREE.BoxGeometry(8,10,1), mat); dw2.position.set(6,5,endZ); scene.add(dw2);
            const dw3 = new THREE.Mesh(new THREE.BoxGeometry(4,4,1), mat); dw3.position.set(0,8,endZ); scene.add(dw3);

            const loader = new GLTFLoader();

            // KAPI YÜKLE
            loader.load('./Door.glb', (g)=>{
                const m = g.scene; m.position.set(0.5,0,0);
                doorGroup.add(m); doorGroup.position.set(-0.5,0,endZ); scene.add(doorGroup);
            }, undefined, ()=>{
                // Yedek Kapı
                const d = new THREE.Mesh(new THREE.BoxGeometry(4,6,0.2), new THREE.MeshStandardMaterial({color:0x654321}));
                d.position.set(2,3,0); doorGroup.add(d); doorGroup.position.set(-2,0,endZ); scene.add(doorGroup);
            });

            // ZOMBİ YÜKLE
            loader.load('./Zombie.glb', (g)=>{
                zombieModel = g.scene; zombieModel.position.set(0,0,endZ-5); scene.add(zombieModel);
            }, undefined, ()=>{
                zombieModel = new THREE.Mesh(new THREE.BoxGeometry(1,2,0.5), new THREE.MeshStandardMaterial({color:0x00ff00}));
                zombieModel.position.set(0,1,endZ-5); scene.add(zombieModel);
            });

            // ANAHTAR
            loader.load('./Skeleton Key.glb', (g)=>{
                keyModel = g.scene; keyModel.scale.set(0.5,0.5,0.5);
                keyModel.position.set(0.5,-0.5,-0.8); camera.add(keyModel);
            });

            // --- GLOCK YÜKLEME (ÖNEMLİ KISIM) ---
            // 1. Önce yedek silahı (Kırmızı Kutu) oluşturuyoruz
            const boxGeo = new THREE.BoxGeometry(0.1, 0.1, 0.4);
            const boxMat = new THREE.MeshBasicMaterial({color: 0xff0000}); // KIPKIRMIZI
            dummyGun = new THREE.Mesh(boxGeo, boxMat);
            dummyGun.position.set(0.5, -0.4, -0.8);
            dummyGun.visible = false; // Başta gizli
            camera.add(dummyGun);

            // 2. Gerçek modeli yüklemeye çalışıyoruz
            // Dosya ismindeki boşlukları encodeURI ile hallediyoruz
            loader.load(encodeURI('./Rigged Glock 19.glb'), (g)=>{
                debugDiv.innerText = "GLOCK YÜKLENDİ!";
                glockModel = g.scene;
                glockModel.scale.set(SILAH_BOYUTU, SILAH_BOYUTU, SILAH_BOYUTU);
                glockModel.rotation.y = Math.PI; // Namluyu çevir
                glockModel.position.set(0.5, -0.5, -0.8); // Eline yerleştir
                glockModel.visible = false;
                camera.add(glockModel);
            }, 
            (xhr) => { debugDiv.innerText = "Silah yükleniyor: " + (xhr.loaded / xhr.total * 100) + "%"; },
            (err) => { 
                debugDiv.innerText = "GLOCK HATASI: Dosya bulunamadı veya bozuk.";
                console.error(err);
            });

            // Girdiler
            document.addEventListener('keydown', (e)=>{
                switch(e.code){
                    case 'KeyW':moveF=true;break; case 'KeyA':moveL=true;break;
                    case 'KeyS':moveB=true;break; case 'KeyD':moveR=true;break;
                    case 'ShiftLeft':isSprint=true;break; case 'KeyE':interact();break;
                }
            });
            document.addEventListener('keyup', (e)=>{
                switch(e.code){
                    case 'KeyW':moveF=false;break; case 'KeyA':moveL=false;break;
                    case 'KeyS':moveB=false;break; case 'KeyD':moveR=false;break;
                    case 'ShiftLeft':isSprint=false;break;
                }
            });
            document.addEventListener('mousedown', shoot);

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
        }

        function interact() {
            if(!hasKey || doorState!==0) return;
            if(camera.position.distanceTo(doorGroup.position) < 8) {
                doorState=1; 
                if(keyModel) keyModel.visible=false; 
                hasKey=false;
                equipGun();
            }
        }

        function equipGun() {
            hasGun = true;
            document.getElementById('inventory').innerText = "DURUM: ÖLDÜR!";
            document.getElementById('inventory').style.color = "red";

            // Eğer gerçek model yüklendiyse onu göster
            if(glockModel) {
                glockModel.visible = true;
                debugDiv.innerText = "GLOCK AKTİF";
            } else {
                // Yüklenemediyse Kırmızı Kutuyu göster (Yedek)
                dummyGun.visible = true;
                debugDiv.innerText = "YEDEK SİLAH (DOSYA BULUNAMADI)";
            }
        }

        function shoot() {
            if(!hasGun || !canShoot) return;
            canShoot=false;
            
            // Tepme
            camera.rotation.x += 0.1;
            
            // Ses (Basit)
            const ac = new (window.AudioContext||window.webkitAudioContext)();
            const osc = ac.createOscillator(); osc.type='sawtooth'; osc.frequency.value=100;
            osc.connect(ac.destination); osc.start(); osc.stop(ac.currentTime+0.1);

            // Vuruş
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
            if(zombieModel && zombieState!==3) {
                const hits = ray.intersectObject(zombieModel, true);
                if(hits.length>0) {
                    zombieModel.position.z -= 1.0; // Geri it
                    zombieHP--;
                    if(zombieHP<=0) {
                        zombieState=3;
                        zombieModel.rotation.x = -Math.PI/2;
                        zombieModel.position.y = 0.5;
                        document.getElementById('msg').innerText="BAŞARDIN";
                        document.getElementById('blocker').style.display='flex';
                        controls.unlock();
                    }
                }
            }
            setTimeout(()=>canShoot=true, 150);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            prevTime = time;

            // --- HAREKET FİZİĞİ (GÜNCELLENDİ) ---
            if(controls.isLocked) {
                // Sürtünmeyi azalttım (Daha kaygan ama hızlı)
                velocity.x -= velocity.x * 5.0 * delta;
                velocity.z -= velocity.z * 5.0 * delta;

                direction.z = Number(moveF) - Number(moveB);
                direction.x = Number(moveR) - Number(moveL);
                direction.normalize();

                const speed = isSprint ? HIZ_KOSMA : HIZ_YURUME;

                if (moveF || moveB) velocity.z -= direction.z * speed * delta;
                if (moveL || moveR) velocity.x -= direction.x * speed * delta;

                controls.moveRight(-velocity.x * delta * 0.02);
                controls.moveForward(-velocity.z * delta * 0.02);

                // Silah Tepmesi Düzeltme
                if(camera.rotation.x > 0) camera.rotation.x -= 2 * delta;

                // Kapı Raycast
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects([doorGroup], true);
                if(hits.length>0 && hits[0].distance<8 && doorState===0 && hasKey) {
                    document.getElementById('interaction').style.display='block';
                } else {
                    document.getElementById('interaction').style.display='none';
                }
            }

            // Kapı Animasyon
            if(doorState===1) {
                doorGroup.rotation.y -= 2 * delta;
                if(doorGroup.rotation.y < -Math.PI/1.5) { doorState=2; zombieState=1; }
            }

            // Zombi
            if(zombieState===1) { // Dön
                zombieModel.rotation.y += 3 * delta;
                if(Math.abs(zombieModel.rotation.y) > 3) zombieState=2; // Kabaca 180 derece
            } else if (zombieState===2) { // Kovala
                zombieModel.lookAt(camera.position.x, 0, camera.position.z);
                const dir = new THREE.Vector3().subVectors(camera.position, zombieModel.position).normalize();
                zombieModel.position.add(dir.multiplyScalar(10 * delta));
                if(camera.position.distanceTo(zombieModel.position)<1.5) {
                    document.getElementById('msg').innerText="ÖLDÜN";
                    document.getElementById('blocker').style.display='flex';
                    controls.unlock();
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
