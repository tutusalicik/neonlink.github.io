<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 WEB: CORE ENGINE</title>
    <style>
        /* --- CSS ENGINE UI --- */
        :root { --primary: #de9b35; --bg: #0f1012; --hud-bg: rgba(0,0,0,0.6); }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* LAYERS */
        #game-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #menu-layer { position: absolute; width: 100%; height: 100%; background: rgba(15,16,18,0.95); z-index: 20; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }

        /* HUD */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #0f0; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 4px #000; }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(0,255,0,0.5); }
        #crosshair::before { width: 20px; height: 2px; top: 1px; left: -8px; }
        #crosshair::after { width: 2px; height: 20px; top: -8px; left: 1px; }

        .hud-panel { position: absolute; background: var(--hud-bg); color: white; padding: 15px; border-radius: 4px; border-left: 3px solid var(--primary); }
        #health-panel { bottom: 30px; left: 30px; width: 200px; }
        #ammo-panel { bottom: 30px; right: 30px; text-align: right; }
        #health-val { font-size: 32px; font-weight: 800; }
        #ammo-val { font-size: 40px; font-weight: 800; color: var(--primary); }
        
        #killfeed { position: absolute; top: 20px; right: 20px; text-align: right; display: flex; flex-direction: column; gap: 5px; }
        .kill-item { background: linear-gradient(90deg, transparent, rgba(200,0,0,0.5)); color: white; padding: 5px 10px; font-size: 14px; font-weight: bold; border-right: 2px solid red; animation: fadeOut 4s forwards; }

        #voice-indicator { position: absolute; bottom: 100px; right: 30px; color: #0f0; display: none; font-weight: bold; font-size: 14px; text-transform: uppercase; }

        /* MENU DESIGN */
        .menu-box { width: 400px; text-align: center; }
        h1 { color: var(--primary); font-size: 60px; margin: 0; letter-spacing: -2px; text-shadow: 0 0 20px rgba(222,155,53,0.3); }
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: transparent; border: 1px solid #444; color: #fff; font-size: 18px; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-weight: bold; }
        .btn:hover { background: var(--primary); border-color: var(--primary); color: #000; transform: scale(1.02); }
        .input-group { display: flex; gap: 10px; margin: 20px 0; }
        input { flex: 1; padding: 15px; background: #222; border: 1px solid #444; color: white; text-align: center; font-family: monospace; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; color: var(--primary); font-family: monospace; }

        @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; display: none; } }
    </style>
</head>
<body>

    <div id="loading">ENGINE LOADING... %0</div>

    <div id="menu-layer">
        <div class="menu-box">
            <h1>CS:WEB</h1>
            <p style="color:#666; margin-bottom: 30px;">GEMINI PRO BUILD v1.2</p>
            
            <div id="host-section">
                <button class="btn" onclick="Network.hostGame()">ODA OLU≈ûTUR (HOST)</button>
                <div id="my-invite-code" style="color: #0f0; margin: 10px; font-family: monospace; display: none;">KODUNUZ: <span id="code-display">...</span></div>
            </div>

            <div style="height: 1px; background: #333; margin: 20px 0;"></div>

            <div class="input-group">
                <input type="text" id="invite-input" placeholder="DAVET KODUNU YAPI≈ûTIR">
                <button class="btn" style="width: auto;" onclick="Network.joinGame()">BAƒûLAN</button>
            </div>
            
            <div style="font-size: 12px; color: #444; margin-top: 20px;">
                WASD: Hareket | R: ≈ûarj√∂r | G: Konu≈ü (Bas-Konu≈ü) | M: Men√º
            </div>
        </div>
    </div>

    <div id="ui-layer" style="display:none;">
        <div id="crosshair"></div>
        <div id="health-panel">HP <span id="health-val">100</span></div>
        <div id="ammo-panel">
            <div id="ammo-val">20</div>
            <div style="color:#aaa; font-size:12px;">/ 90 GLOCK-18</div>
        </div>
        <div id="killfeed"></div>
        <div id="voice-indicator">üé§ Mƒ∞KROFON A√áIK</div>
    </div>

    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script type="module">
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // ==========================================
        // CORE ENGINE CLASSES
        // ==========================================

        class AssetManager {
            constructor() {
                this.loader = new GLTFLoader();
                this.assets = {};
                this.toLoad = [
                    { name: 'map', url: 'models/map.glb' },
                    { name: 'player', url: 'models/Guy.glb' },
                    { name: 'weapon', url: 'models/Pistol.glb' }
                ];
            }

            async loadAll(onProgress) {
                let loaded = 0;
                for (const item of this.toLoad) {
                    try {
                        const gltf = await this.loader.loadAsync(item.url);
                        this.assets[item.name] = gltf;
                        loaded++;
                        if(onProgress) onProgress(Math.floor((loaded / this.toLoad.length) * 100));
                        console.log(`[ASSET] ${item.name} loaded.`);
                    } catch (e) {
                        console.error(`[ERROR] Failed to load ${item.name}. Using placeholder.`, e);
                        this.createPlaceholder(item.name);
                    }
                }
                document.getElementById('loading').style.display = 'none';
            }

            createPlaceholder(name) {
                // Modeller yoksa oyun √ß√∂kmesin diye placeholder olu≈üturur
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0xff0000}));
                this.assets[name] = { scene: mesh };
            }
        }

        class SoundSystem {
            constructor() {
                this.isTalking = false;
                this.localStream = null;
                this.peers = {}; // Uzaktaki oyuncularƒ±n sesleri
            }

            async initMic() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    // Ba≈ülangƒ±√ßta mikrofonu sustur (Push to Talk i√ßin)
                    this.localStream.getAudioTracks()[0].enabled = false;
                } catch(e) {
                    console.error("Mikrofon izni verilmedi.");
                }
            }

            toggleMic(isActive) {
                if(!this.localStream) return;
                this.localStream.getAudioTracks()[0].enabled = isActive;
                document.getElementById('voice-indicator').style.display = isActive ? 'block' : 'none';
                this.isTalking = isActive;
            }
        }

        class Weapon {
            constructor(camera, model) {
                this.camera = camera;
                this.model = model;
                this.ammo = 20;
                this.magSize = 20;
                this.reserve = 90;
                this.damage = 25;
                this.canShoot = true;
                this.recoil = 0;
                
                // Model ayarlarƒ±
                if(this.model) {
                    this.model.position.set(0.3, -0.3, -0.5);
                    this.model.scale.set(1, 1, 1); // √ñl√ßeklendirme gerekirse burayƒ± deƒüi≈ütir
                    this.camera.add(this.model);
                }
            }

            shoot() {
                if (!this.canShoot || this.ammo <= 0) return false;

                this.ammo--;
                this.recoil += 0.05;
                this.canShoot = false;
                
                // ATE≈û EFEKTƒ∞ (Basit)
                if(this.model) this.model.position.z += 0.1; 
                setTimeout(() => { if(this.model) this.model.position.z -= 0.1; }, 50);

                // UI G√ºncelle
                UI.updateAmmo(this.ammo);

                // Ate≈ü hƒ±zƒ±
                setTimeout(() => { this.canShoot = true; }, 150);
                
                return true; // Ate≈ü edildi
            }

            update() {
                // Recoil Recovery
                if (this.recoil > 0) {
                    this.recoil -= 0.002;
                    this.camera.rotation.x += 0.002; // Kamera yukarƒ± kaysƒ±n
                }
            }

            reload() {
                if (this.reserve > 0 && this.ammo < this.magSize) {
                    this.canShoot = false;
                    console.log("Reloading...");
                    setTimeout(() => {
                        const needed = this.magSize - this.ammo;
                        const taken = Math.min(needed, this.reserve);
                        this.ammo += taken;
                        this.reserve -= taken;
                        this.canShoot = true;
                        UI.updateAmmo(this.ammo);
                    }, 2000); // 2 saniye reload
                }
            }
        }

        class Player {
            constructor(scene, camera) {
                this.scene = scene;
                this.camera = camera;
                this.velocity = new THREE.Vector3();
                this.direction = new THREE.Vector3();
                this.health = 100;
                this.isDead = false;
                
                // Physics params
                this.speed = 10.0;
                this.gravity = 30.0;
                this.jumpHeight = 15.0;
                this.canJump = false; // Basit zemin kontrol√º i√ßin
            }

            update(delta, controls, moveState) {
                if (this.isDead) return;

                // S√ºrt√ºnme
                this.velocity.x -= this.velocity.x * 10.0 * delta;
                this.velocity.z -= this.velocity.z * 10.0 * delta;
                this.velocity.y -= this.gravity * delta; // Yer √ßekimi

                this.direction.z = Number(moveState.forward) - Number(moveState.backward);
                this.direction.x = Number(moveState.right) - Number(moveState.left);
                this.direction.normalize();

                if (moveState.forward || moveState.backward) this.velocity.z -= this.direction.z * 100.0 * delta;
                if (moveState.left || moveState.right) this.velocity.x -= this.direction.x * 100.0 * delta;

                // Hareket uygula
                controls.moveRight(-this.velocity.x * delta);
                controls.moveForward(-this.velocity.z * delta);
                this.camera.position.y += this.velocity.y * delta;

                // Basit Zemin Kontrol√º (Harita physics yoksa d√º≈ümemek i√ßin)
                if (this.camera.position.y < 1.6) {
                    this.velocity.y = 0;
                    this.camera.position.y = 1.6;
                    this.canJump = true;
                }
            }
            
            takeDamage(amount) {
                this.health -= amount;
                UI.updateHealth(this.health);
                if(this.health <= 0) this.die();
            }

            die() {
                this.isDead = true;
                alert("√ñLD√úN!");
                location.reload();
            }
        }

        // ==========================================
        // NETWORK MANAGER (PEERJS)
        // ==========================================
        const Network = {
            peer: null,
            conn: null,
            mediaConnection: null,
            isHost: false,
            otherPlayers: {}, // { id: { mesh: Mesh, targetPos: Vector3 } }

            init: (id = null) => {
                Network.peer = id ? new Peer(id) : new Peer();
                
                Network.peer.on('open', (myId) => {
                    console.log('My Peer ID:', myId);
                    if(Network.isHost) {
                        document.getElementById('code-display').innerText = myId;
                        document.getElementById('my-invite-code').style.display = 'block';
                    }
                });

                Network.peer.on('connection', (conn) => {
                    console.log("Birisi baƒülandƒ±!");
                    Network.setupConnection(conn);
                });

                // Sesli Arama Geldiƒüinde
                Network.peer.on('call', (call) => {
                    call.answer(Engine.sound.localStream);
                    call.on('stream', remoteStream => {
                        const audio = new Audio();
                        audio.srcObject = remoteStream;
                        audio.play();
                    });
                });
            },

            hostGame: () => {
                Network.isHost = true;
                Network.init();
                UI.hideMenu();
                Engine.startLoop();
            },

            joinGame: () => {
                const hostId = document.getElementById('invite-input').value;
                if(!hostId) return alert("Kodu gir!");
                
                Network.init();
                const conn = Network.peer.connect(hostId);
                
                conn.on('open', () => {
                    Network.setupConnection(conn);
                    UI.hideMenu();
                    Engine.startLoop();
                    
                    // Sesli aramayƒ± ba≈ülat
                    if(Engine.sound.localStream) {
                        const call = Network.peer.call(hostId, Engine.sound.localStream);
                        call.on('stream', remoteStream => {
                            const audio = new Audio();
                            audio.srcObject = remoteStream;
                            audio.play();
                        });
                    }
                });
            },

            setupConnection: (conn) => {
                Network.conn = conn;
                conn.on('data', (data) => {
                    Network.handleData(data);
                });
            },

            sendData: (data) => {
                if(Network.conn && Network.conn.open) {
                    Network.conn.send(data);
                }
            },

            handleData: (data) => {
                // Basit Multiplayer Mantƒ±ƒüƒ±: Sadece 1 d√º≈üman destekler (√ñrnek olduƒüu i√ßin)
                // Ger√ßek pro'da 'data.id' ile array y√∂netilir.
                
                if(data.type === 'move') {
                    if(!Network.otherPlayers['enemy']) {
                        // D√º≈üman modelini olu≈ütur
                        const enemyMesh = Engine.assets.assets['player'].scene.clone();
                        Engine.scene.add(enemyMesh);
                        Network.otherPlayers['enemy'] = { mesh: enemyMesh };
                    }
                    const enemy = Network.otherPlayers['enemy'].mesh;
                    enemy.position.set(data.x, data.y - 1.6, data.z); // G√∂z hizasƒ± d√ºzeltmesi
                    enemy.rotation.y = data.rot;
                }
                
                if(data.type === 'shoot') {
                    // D√º≈üman ate≈ü etti sesi √ßalƒ±nabilir
                    // Basit raycast ile vurulduk mu kontrol√º (Normalde sunucuda yapƒ±lƒ±r)
                    // Burada hileye a√ßƒ±k ama P2P i√ßin mecbur.
                }

                if(data.type === 'hit') {
                    Engine.player.takeDamage(data.dmg);
                }
            }
        };

        // ==========================================
        // UI MANAGER
        // ==========================================
        const UI = {
            hideMenu: () => {
                document.getElementById('menu-layer').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                Engine.controls.lock();
            },
            updateHealth: (val) => document.getElementById('health-val').innerText = val,
            updateAmmo: (val) => document.getElementById('ammo-val').innerText = val,
            addKillFeed: (msg) => {
                const div = document.createElement('div');
                div.className = 'kill-item';
                div.innerText = msg;
                document.getElementById('killfeed').appendChild(div);
                setTimeout(() => div.remove(), 4000);
            }
        };

        // ==========================================
        // GAME ENGINE MAIN LOOP
        // ==========================================
        const Engine = {
            scene: null, camera: null, renderer: null, controls: null,
            player: null, weapon: null, sound: null, assets: null,
            moveState: { forward: false, backward: false, left: false, right: false },
            clock: new THREE.Clock(),

            init: async () => {
                // Three.js Setup
                Engine.scene = new THREE.Scene();
                Engine.scene.background = new THREE.Color(0x87ceeb);
                Engine.scene.fog = new THREE.Fog(0x87ceeb, 0, 50);

                Engine.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                Engine.camera.position.y = 1.6;

                Engine.renderer = new THREE.WebGLRenderer({ antialias: true });
                Engine.renderer.setSize(window.innerWidth, window.innerHeight);
                Engine.renderer.shadowMap.enabled = true;
                document.getElementById('game-layer').appendChild(Engine.renderer.domElement);

                // Lighting
                const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                Engine.scene.add(hemiLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(50, 200, 100);
                dirLight.castShadow = true;
                Engine.scene.add(dirLight);

                // Controls
                Engine.controls = new PointerLockControls(Engine.camera, document.body);
                Engine.setupInputs();

                // Load Assets
                Engine.assets = new AssetManager();
                await Engine.assets.loadAll((p) => document.getElementById('loading').innerHTML = `LOADING ASSETS... %${p}`);

                // Setup World
                const map = Engine.assets.assets['map'].scene;
                Engine.scene.add(map);

                // Setup Player & Weapon
                Engine.player = new Player(Engine.scene, Engine.camera);
                Engine.weapon = new Weapon(Engine.camera, Engine.assets.assets['weapon'].scene);
                Engine.scene.add(Engine.camera); // Silah kamerada olduƒüu i√ßin kamerayƒ± sahneye ekle

                // Setup Audio
                Engine.sound = new SoundSystem();
                Engine.sound.initMic(); // ƒ∞zin iste

                document.getElementById('menu-layer').style.display = 'flex'; // Men√ºy√º a√ß
            },

            setupInputs: () => {
                const onKey = (code, down) => {
                    switch(code) {
                        case 'KeyW': Engine.moveState.forward = down; break;
                        case 'KeyS': Engine.moveState.backward = down; break;
                        case 'KeyA': Engine.moveState.left = down; break;
                        case 'KeyD': Engine.moveState.right = down; break;
                        case 'Space': if(down && Engine.player.canJump) { Engine.player.velocity.y += Engine.player.jumpHeight; Engine.player.canJump = false; } break;
                        case 'KeyR': if(down) Engine.weapon.reload(); break;
                        case 'KeyG': Engine.sound.toggleMic(down); break;
                    }
                };
                document.addEventListener('keydown', (e) => onKey(e.code, true));
                document.addEventListener('keyup', (e) => onKey(e.code, false));
                document.addEventListener('mousedown', () => {
                    if(Engine.controls.isLocked) {
                        if(Engine.weapon.shoot()) {
                            // Raycast for shooting logic
                            Engine.checkHit();
                            Network.sendData({ type: 'shoot' });
                        }
                    } else {
                        // Engine.controls.lock(); // Men√ºden basƒ±lmasƒ± daha saƒülƒ±klƒ±
                    }
                });
            },

            checkHit: () => {
                // Ekranƒ±n ortasƒ±ndan Ray at
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(0,0), Engine.camera);
                
                // D√º≈üman meshlerini kontrol et
                const enemies = Object.values(Network.otherPlayers).map(p => p.mesh);
                const intersects = raycaster.intersectObjects(enemies, true);

                if(intersects.length > 0) {
                    console.log("VURDUN!");
                    UI.addKillFeed("D√º≈ümanƒ± Vurdun! (-25 HP)");
                    Network.sendData({ type: 'hit', dmg: 25 });
                }
            },

            startLoop: () => {
                Engine.renderer.setAnimationLoop(() => {
                    const delta = Math.min(Engine.clock.getDelta(), 0.1);
                    
                    Engine.player.update(delta, Engine.controls, Engine.moveState);
                    Engine.weapon.update();

                    // Network Update (Her frame deƒüil, kƒ±sƒ±tlanabilir ama ≈üimdilik her frame)
                    if(Network.conn && Network.conn.open) {
                        const p = Engine.camera.position;
                        const r = Engine.camera.rotation.y;
                        Network.sendData({ type: 'move', x: p.x, y: p.y, z: p.z, rot: r });
                    }

                    Engine.renderer.render(Engine.scene, Engine.camera);
                });
            }
        };

        // GLOBAL START
        window.Game = Network; // HTML butonlarƒ± eri≈üebilsin diye
        Engine.init();

    </script>
    <div id="game-layer"></div>
</body>
</html>
