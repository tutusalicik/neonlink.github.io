<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 WEB: TITAN WARZONE</title>
    <style>
        /* --- VISUAL INTERFACE DESIGN --- */
        :root { --gold: #f0c643; --red: #ff3b3b; --bg: #0f1012; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* LOADING SCREEN */
        #loader { position: fixed; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 60px; height: 60px; border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .load-text { margin-top: 20px; color: #fff; letter-spacing: 3px; font-weight: bold; font-size: 14px; }
        
        /* HUD ELEMENTS */
        #ui-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        /* CROSSHAIR SYSTEM */
        #crosshair-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: 0.05s; }
        .ch-part { position: absolute; background: #0f0; box-shadow: 0 0 2px #000; transition: all 0.1s; }
        .ch-h { width: 8px; height: 2px; left: -4px; top: 0; }
        .ch-v { width: 2px; height: 8px; top: -3px; left: -1px; }
        /* Hitmarker */
        #hitmarker { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%) rotate(45deg); opacity: 0; transition: opacity 0.1s; }
        .hm-line { position: absolute; background: #fff; width: 100%; height: 2px; top: 9px; }
        .hm-v { transform: rotate(90deg); }

        /* Spread Effect */
        .shooting .ch-h { width: 14px; left: -7px; background: var(--red); }
        .shooting .ch-v { height: 14px; top: -6px; background: var(--red); }

        /* STATUS BARS */
        #hud-bottom { position: absolute; bottom: 40px; left: 40px; display: flex; gap: 40px; text-shadow: 2px 2px 0 #000; }
        .stat-block { display: flex; flex-direction: column; }
        .stat-val { font-size: 50px; font-weight: 900; color: #fff; line-height: 1; }
        .stat-label { font-size: 12px; color: #aaa; font-weight: bold; letter-spacing: 1px; }
        #ammo-count { color: var(--gold); }
        #hp-count { color: #fff; transition: color 0.2s; }
        .low-hp { color: var(--red) !important; animation: pulse 1s infinite; }

        /* KILL FEED */
        #kill-feed { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .kf-item { background: linear-gradient(90deg, transparent, rgba(0,0,0,0.8)); padding: 5px 15px; border-right: 3px solid var(--red); color: white; font-size: 13px; font-weight: bold; opacity: 0; animation: slideIn 0.3s forwards; }
        
        /* DAMAGE OVERLAY */
        #bloody-screen { position: absolute; width:100%; height:100%; box-shadow: inset 0 0 0 0 rgba(255,0,0,0); transition: 0.1s; }

        /* MENU */
        #menu { position: absolute; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        h1 { font-size: 80px; color: white; margin: 0; font-style: italic; letter-spacing: -2px; }
        .btn { padding: 20px 60px; font-size: 20px; background: var(--gold); border: none; font-weight: bold; cursor: pointer; margin-top: 30px; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%); transition: 0.2s; }
        .btn:hover { transform: scale(1.05); background: #fff; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div class="load-text">TITAN ENGINE v9.0 LOADING...</div>
        <div id="debug" style="color:#555; font-size:10px; margin-top:10px;"></div>
    </div>

    <div id="menu">
        <h1>CS:WEB <span style="color:var(--gold)">WARZONE</span></h1>
        <button class="btn" onclick="Game.start()">SAVAÅžA BAÅžLA</button>
        <p style="color:#666; margin-top:15px;">WASD: Hareket | SOL TIK: AteÅŸ | R: ÅžarjÃ¶r</p>
    </div>

    <div id="ui-layer">
        <div id="bloody-screen"></div>
        
        <div id="crosshair-box">
            <div class="ch-part ch-h"></div>
            <div class="ch-part ch-v"></div>
        </div>
        <div id="hitmarker">
            <div class="hm-line"></div>
            <div class="hm-line hm-v"></div>
        </div>

        <div id="kill-feed"></div>

        <div id="hud-bottom">
            <div class="stat-block">
                <div class="stat-val" id="hp-count">100</div>
                <div class="stat-label">HEALTH</div>
            </div>
            <div class="stat-block" style="text-align: right;">
                <div class="stat-val" id="ammo-count">30</div>
                <div class="stat-label">AK-47</div>
            </div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // =================================================================
        // âš™ï¸ OYUN AYARLARI (CONFIG)
        // =================================================================
        const CONFIG = {
            // SÄ°LAH AYARLARI (Senin AK-47 modeline gÃ¶re)
            weapon: {
                scale: 0.15,         // SilahÄ±n boyutu
                pos: { x: 0.25, y: -0.3, z: -0.6 }, // Ekrandaki konumu
                // DÃ–NÃœÅž AÃ‡ISI (Ters tutuyorsa burayla oyna)
                rot: { x: 0, y: Math.PI, z: 0 } // Math.PI = 180 derece Ã§evir
            },
            
            // BOT AYARLARI
            bot: {
                scale: 0.05,         // Guy.glb Ã§ok bÃ¼yÃ¼kse kÃ¼Ã§Ã¼lt (0.05 ideal genelde)
                speed: 3.5,          // Bot yÃ¼rÃ¼me hÄ±zÄ±
                weaponScale: 1.0     // Botun elindeki AK'nin boyutu (Botun scale'ine gÃ¶re Ã§arpÄ±lÄ±r)
            },

            // OYNANIÅž
            regenDelay: 5000,    // Can yenilenmesi kaÃ§ sn sonra baÅŸlar (ms)
            playerSpeed: 8.0     // Oyuncu hÄ±zÄ±
        };

        // =================================================================
        // ðŸš€ GLOBAL DEÄžÄ°ÅžKENLER
        // =================================================================
        const Sys = { 
            scene: null, camera: null, renderer: null, controls: null, 
            clock: new THREE.Clock(), assets: {}, bullets: [], particles: [] 
        };
        const World = { bots: [], gunGroup: null };
        const Player = { hp: 100, ammo: 30, isDead: false, lastHitTime: 0 };
        const Input = { w:false, a:false, s:false, d:false, fire:false };

        init();

        async function init() {
            // 1. Sahne Kurulumu
            Sys.scene = new THREE.Scene();
            Sys.scene.background = new THREE.Color(0x111111);
            Sys.scene.fog = new THREE.Fog(0x111111, 0, 50);

            Sys.camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 1000);
            Sys.camera.position.y = 1.7;

            Sys.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            Sys.renderer.setSize(window.innerWidth, window.innerHeight);
            Sys.renderer.shadowMap.enabled = true;
            document.body.appendChild(Sys.renderer.domElement);

            // 2. IÅŸÄ±klandÄ±rma
            const amb = new THREE.AmbientLight(0xffffff, 0.6);
            Sys.scene.add(amb);
            const sun = new THREE.DirectionalLight(0xffd700, 1.5);
            sun.position.set(20, 50, 20);
            sun.castShadow = true;
            Sys.scene.add(sun);

            Sys.controls = new PointerLockControls(Sys.camera, document.body);

            // 3. Asset YÃ¼kleme
            await loadAssets();

            // 4. Dinleyiciler
            setupInputs();
        }

        async function loadAssets() {
            const loader = new GLTFLoader();
            const files = { map: './map.glb', guy: './guy.glb', ak: './Ak47.glb' };
            const keys = Object.keys(files);

            for(const k of keys) {
                try {
                    document.getElementById('debug').innerText = "Loading: " + k;
                    const gltf = await loader.loadAsync(files[k]);
                    Sys.assets[k] = gltf.scene;
                } catch(e) {
                    console.error("YÃ¼kleme HatasÄ±:", k);
                    Sys.assets[k] = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshBasicMaterial({color:'red'}));
                }
            }
            document.getElementById('loader').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        }

        // =================================================================
        // ðŸŽ® OYUN MANTIÄžI
        // =================================================================
        window.Game = {
            start: () => {
                document.getElementById('menu').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                Sys.controls.lock();
                
                // HaritayÄ± Ekle
                const map = Sys.assets.map;
                map.traverse(o => { if(o.isMesh) { o.receiveShadow=true; o.castShadow=true; } });
                Sys.scene.add(map);

                // SilahÄ±nÄ± KuÅŸan
                setupPlayerWeapon();

                // BotlarÄ± Yarat
                spawnBot(new THREE.Vector3(5, 0, 15));
                spawnBot(new THREE.Vector3(-5, 0, 15));
                spawnBot(new THREE.Vector3(0, 0, 20));

                animate();
            }
        };

        function setupPlayerWeapon() {
            const ak = Sys.assets.ak.clone();
            ak.scale.set(CONFIG.weapon.scale, CONFIG.weapon.scale, CONFIG.weapon.scale);
            ak.position.set(CONFIG.weapon.pos.x, CONFIG.weapon.pos.y, CONFIG.weapon.pos.z);
            ak.rotation.set(CONFIG.weapon.rot.x, CONFIG.weapon.rot.y, CONFIG.weapon.rot.z);
            
            // GÃ¶lge sorunlarÄ±nÄ± engelle
            ak.traverse(o => { if(o.isMesh) { o.castShadow=false; o.receiveShadow=false; } });

            World.gunGroup = new THREE.Group();
            World.gunGroup.add(ak);
            Sys.camera.add(World.gunGroup);
            Sys.scene.add(Sys.camera);
        }

        function spawnBot(pos) {
            const botMesh = Sys.assets.guy.clone();
            botMesh.scale.set(CONFIG.bot.scale, CONFIG.bot.scale, CONFIG.bot.scale);
            botMesh.position.copy(pos);

            // BOTA SÄ°LAH VER (Ã–NEMLÄ° Ã–ZELLÄ°K)
            const botGun = Sys.assets.ak.clone();
            // Botun silah boyutu
            const s = CONFIG.bot.weaponScale; 
            botGun.scale.set(s, s, s);
            
            // SilahÄ± botun eline (tahmini) yerleÅŸtir
            // Not: Bone attachment olmadan parent yapÄ±yoruz
            botGun.position.set(0.2, 1.2, 0.4); // Botun gÃ¶vdesine gÃ¶re konumu
            botGun.rotation.set(0, Math.PI, 0); // SilahÄ±n yÃ¶nÃ¼
            botMesh.add(botGun);

            botMesh.traverse(o => { if(o.isMesh) { o.castShadow=true; o.receiveShadow=true; if(!o.material.map) o.material.color.setHex(0x555555); } });
            
            Sys.scene.add(botMesh);
            World.bots.push({ mesh: botMesh, gunMesh: botGun, hp: 100, lastShot: 0, id: Math.floor(Math.random()*100) });
        }

        // =================================================================
        // ðŸ”„ ANA DÃ–NGÃœ (MAIN LOOP)
        // =================================================================
        function animate() {
            requestAnimationFrame(animate);
            const dt = 0.016; // Sabit zaman adÄ±mÄ±
            const now = Date.now();

            if(Player.isDead) return;

            // 1. OYUNCU HAREKETÄ°
            updatePlayerMovement(dt);

            // 2. SÄ°LAH MANTIÄžI & EFEKTLER
            updateWeaponEffects(now);

            // 3. BOT YAPAY ZEKASI
            updateBots(dt, now);

            // 4. MERMÄ° Ä°ZLERÄ° & EFEKTLER
            updateProjectiles();
            updateParticles();

            // 5. CAN YENÄ°LENMESÄ° (Auto-Regen)
            if(now - Player.lastHitTime > CONFIG.regenDelay && Player.hp < 100) {
                Player.hp = Math.min(Player.hp + 0.5, 100);
                updateHUD();
            }

            Sys.renderer.render(Sys.scene, Sys.camera);
        }

        function updatePlayerMovement(dt) {
            const v = new THREE.Vector3();
            const s = CONFIG.playerSpeed * dt;
            if(Input.w) v.z = 1; if(Input.s) v.z = -1;
            if(Input.a) v.x = -1; if(Input.d) v.x = 1;
            
            if(v.length() > 0) {
                Sys.controls.moveForward(v.z * s);
                Sys.controls.moveRight(v.x * s);
            }
        }

        function updateWeaponEffects(now) {
            // AteÅŸ Etme
            if(Input.fire && Sys.controls.isLocked) {
                if(now % 100 < 20) { // Basit atÄ±ÅŸ hÄ±zÄ± sÄ±nÄ±rlayÄ±cÄ±
                    fireWeapon(true); // true = Oyuncu
                }
                document.getElementById('crosshair-box').classList.add('shooting');
            } else {
                document.getElementById('crosshair-box').classList.remove('shooting');
            }

            // Silah SallanmasÄ± (Sway & Bob)
            if(World.gunGroup) {
                const time = now * 0.003;
                const bobY = Math.sin(time) * 0.001;
                // Recoil
                if(Input.fire) {
                    World.gunGroup.position.z = THREE.MathUtils.lerp(World.gunGroup.position.z, 0.1, 0.2);
                    World.gunGroup.rotation.x = THREE.MathUtils.lerp(World.gunGroup.rotation.x, 0.1, 0.2);
                } else {
                    World.gunGroup.position.z = THREE.MathUtils.lerp(World.gunGroup.position.z, 0, 0.1);
                    World.gunGroup.rotation.x = THREE.MathUtils.lerp(World.gunGroup.rotation.x, 0, 0.1);
                }
                World.gunGroup.position.y = CONFIG.weapon.pos.y + bobY;
            }
        }

        function updateBots(dt, now) {
            World.bots.forEach(bot => {
                if(bot.hp <= 0) return;

                // Oyuncuya Bak
                bot.mesh.lookAt(Sys.camera.position.x, bot.mesh.position.y, Sys.camera.position.z);
                
                // Mesafe
                const dist = bot.mesh.position.distanceTo(Sys.camera.position);

                // Takip Et
                if(dist > 5) {
                    bot.mesh.translateZ(CONFIG.bot.speed * dt);
                }

                // AteÅŸ Et
                if(dist < 20 && now - bot.lastShot > 500) { // YarÄ±m saniyede bir
                    bot.lastShot = now;
                    fireWeapon(false, bot); // false = Bot
                }
            });
        }

        // =================================================================
        // ðŸ”« SÄ°LAH SÄ°STEMÄ° & TRACERS
        // =================================================================
        function fireWeapon(isPlayer, shooterBot = null) {
            // BaÅŸlangÄ±Ã§ noktasÄ±
            const startPos = new THREE.Vector3();
            const direction = new THREE.Vector3();

            if(isPlayer) {
                if(Player.ammo <= 0) return;
                Player.ammo--;
                document.getElementById('ammo-count').innerText = Player.ammo;

                // Kamera yÃ¶nÃ¼
                Sys.camera.getWorldPosition(startPos);
                // Hafif saÄŸ alttan Ã§Ä±ksÄ±n (silah namlusu gibi)
                startPos.add(Sys.camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(0.5));
                startPos.y -= 0.2; 
                startPos.x += 0.2;

                Sys.camera.getWorldDirection(direction);
                
                // Raycast
                checkHit();
            } else {
                // Bot AteÅŸi
                shooterBot.mesh.getWorldPosition(startPos);
                startPos.y += 1.2; // Silah hizasÄ±
                
                // Oyuncuya doÄŸru
                direction.subVectors(Sys.camera.position, startPos).normalize();
                
                // DaÄŸÄ±lÄ±m (Accuracy)
                direction.x += (Math.random()-0.5) * 0.1;
                direction.y += (Math.random()-0.5) * 0.1;

                // Hasar ver
                if(Math.random() > 0.6) takeDamage(10); // %40 isabet oranÄ±
            }

            // MERMÄ° Ä°ZÄ° (TRACER) OLUÅžTUR
            createTracer(startPos, direction);
        }

        function createTracer(start, dir) {
            // SarÄ± Ã§izgi
            const material = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const geometry = new THREE.CylinderGeometry(0.02, 0.02, 2, 8);
            geometry.rotateX(Math.PI / 2); // Silindiri yatÄ±r
            const bullet = new THREE.Mesh(geometry, material);
            
            bullet.position.copy(start);
            bullet.lookAt(start.clone().add(dir));
            
            bullet.userData = { dir: dir, life: 0 };
            Sys.scene.add(bullet);
            Sys.bullets.push(bullet);
        }

        function updateProjectiles() {
            for(let i = Sys.bullets.length - 1; i >= 0; i--) {
                const b = Sys.bullets[i];
                b.position.add(b.userData.dir.clone().multiplyScalar(2.0)); // Mermi hÄ±zÄ±
                b.userData.life++;
                if(b.userData.life > 20) { // 20 frame sonra sil
                    Sys.scene.remove(b);
                    Sys.bullets.splice(i, 1);
                }
            }
        }

        function checkHit() {
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), Sys.camera);
            
            const targets = World.bots.map(b => b.mesh);
            const hits = ray.intersectObjects(targets, true);

            if(hits.length > 0) {
                const hitObj = hits[0].object;
                const point = hits[0].point;
                
                // Hitmarker GÃ¶ster
                const hm = document.getElementById('hitmarker');
                hm.style.opacity = 1;
                setTimeout(() => hm.style.opacity = 0, 100);

                // Kan Efekti
                spawnParticles(point, 0xaa0000);

                // Botu Bul
                // (Parent taramasÄ± yap)
                let curr = hitObj;
                while(curr.parent && curr.parent !== Sys.scene) curr = curr.parent;
                
                const bot = World.bots.find(b => b.mesh === curr);
                if(bot) {
                    bot.hp -= 25; // 4 mermide Ã¶lÃ¼r
                    if(bot.hp <= 0) killBot(bot);
                    else {
                         // Vurulma efekti (KÄ±sa sÃ¼reli kÄ±rmÄ±zÄ± yanÄ±p sÃ¶nme)
                         hitObj.material = new THREE.MeshBasicMaterial({color: 0xff0000});
                         setTimeout(() => hitObj.material = new THREE.MeshStandardMaterial({color: 0x555555}), 50);
                    }
                }
            }
        }

        function killBot(bot) {
            // Kill Feed Ekle
            const feed = document.getElementById('kill-feed');
            const item = document.createElement('div');
            item.className = 'kf-item';
            item.innerHTML = `SEN ðŸ”« BOT #${bot.id}`;
            feed.appendChild(item);
            setTimeout(() => item.remove(), 3000);

            // Botu yatÄ±r
            bot.mesh.rotation.x = -Math.PI/2; 
            bot.mesh.position.y = 0.2;
            
            // Listeden tamamen silme, sadece HP 0 kalsÄ±n (Ceset kalsÄ±n)
        }

        function takeDamage(amount) {
            Player.hp -= amount;
            Player.lastHitTime = Date.now();
            updateHUD();

            // Ekran kana bulansÄ±n
            const blood = document.getElementById('bloody-screen');
            blood.style.boxShadow = "inset 0 0 100px 50px rgba(180,0,0,0.6)";
            setTimeout(() => blood.style.boxShadow = "none", 200);

            if(Player.hp <= 0) {
                Player.isDead = true;
                Sys.controls.unlock();
                alert("Ã–LDÃœN! SAYFAYI YENÄ°LE.");
                location.reload();
            }
        }

        function updateHUD() {
            const el = document.getElementById('hp-count');
            el.innerText = Math.ceil(Player.hp);
            if(Player.hp < 30) el.classList.add('low-hp');
            else el.classList.remove('low-hp');
        }

        function spawnParticles(pos, color) {
            for(let i=0; i<8; i++) {
                const geo = new THREE.BoxGeometry(0.05, 0.05, 0.05);
                const mat = new THREE.MeshBasicMaterial({color: color});
                const p = new THREE.Mesh(geo, mat);
                p.position.copy(pos);
                p.userData = { vel: new THREE.Vector3((Math.random()-0.5)*0.2, Math.random()*0.2, (Math.random()-0.5)*0.2) };
                Sys.scene.add(p);
                Sys.particles.push(p);
            }
        }

        function updateParticles() {
            for(let i=Sys.particles.length-1; i>=0; i--) {
                const p = Sys.particles[i];
                p.position.add(p.userData.vel);
                p.userData.vel.y -= 0.01; // Gravity
                p.scale.multiplyScalar(0.9);
                if(p.scale.x < 0.001) {
                    Sys.scene.remove(p);
                    Sys.particles.splice(i, 1);
                }
            }
        }

        // =================================================================
        // âŒ¨ï¸ KONTROLLER
        // =================================================================
        function setupInputs() {
            document.addEventListener('keydown', e => {
                const k = e.key.toLowerCase();
                if(k==='w') Input.w=true; if(k==='s') Input.s=true;
                if(k==='a') Input.a=true; if(k==='d') Input.d=true;
                if(k==='r') { Player.ammo = 30; document.getElementById('ammo-count').innerText=30; }
            });
            document.addEventListener('keyup', e => {
                const k = e.key.toLowerCase();
                if(k==='w') Input.w=false; if(k==='s') Input.s=false;
                if(k==='a') Input.a=false; if(k==='d') Input.d=false;
            });
            document.addEventListener('mousedown', () => { if(Sys.controls.isLocked) Input.fire = true; });
            document.addEventListener('mouseup', () => Input.fire = false);
        }

    </script>
</body>
</html>
