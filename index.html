<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Karanlık Koridor: Glock 19</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; user-select: none; font-family: 'Courier New', Courier, monospace; }
        
        /* EFEKTLER */
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,1) 100%);
            pointer-events: none; z-index: 5;
        }
        
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: rgba(255, 255, 255, 0.8); border-radius: 50%; transform: translate(-50%, -50%); z-index: 6;
            transition: opacity 0.2s;
            box-shadow: 0 0 4px #fff;
        }

        /* ARAYÜZ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
        }
        #ammo-counter {
            position: absolute; bottom: 30px; right: 30px; font-size: 50px; color: #fff; font-weight: bold; text-shadow: 2px 2px 0 #000;
            display: none; font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif; letter-spacing: 2px;
        }
        #inventory { position: absolute; top: 20px; left: 20px; color: #d4af37; font-size: 20px; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; background: rgba(0,0,0,0.8); padding: 10px 20px; border: 1px solid #fff; display: none;
        }

        /* Başlangıç/Bitiş */
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #050505;
            display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; color: #aaa;
        }
        #msg { font-size: 40px; color: #c00; font-weight: bold; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; }
        .controls { text-align: center; line-height: 1.8; font-size: 18px; }

        #hit-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,0,0,0.4);
            display: none; z-index: 8; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="vignette"></div>
    <div id="hit-flash"></div> 
    
    <div id="blocker">
        <div id="msg">BAŞLAT</div>
        <div class="controls">
            W,A,S,D = Hareket<br/>
            E = Kapı<br/>
            SAĞ TIK = Nişan Al (ADS)<br/>
            SOL TIK = Ateş Et
        </div>
    </div>

    <div id="crosshair"></div>

    <div id="ui-layer">
        <div id="inventory">GÖREV: <span id="status-text">Anahtarı Bul</span></div>
        <div id="interaction">[E] KAPIYI AÇ</div>
        <div id="ammo-counter">15 / ∞</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- AYARLAR ---
        const CONFIG = {
            gunScale: 20.0,       // SİLAH BOYUTU (Çok büyük/küçükse burayı değiştir: örn 1.0 veya 100.0)
            walkSpeed: 450.0,
            runSpeed: 800.0,
            zombieSpeed: 8.5,
            zombieTurnSpeed: 2.0, // Zombi dönüş hızı
            zombieHealth: 4,      // Zombi canı
            recoil: 0.08,         // Geri tepme miktarı
            fovBase: 75,
            fovAim: 45
        };

        // --- SES MOTORU ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;

            if (type === 'gunshot') {
                // Güçlü silah sesi
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(120, now); osc.frequency.exponentialRampToValueAtTime(10, now+0.15);
                gain.gain.setValueAtTime(0.6, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.15);
                osc.start(); osc.stop(now+0.15);
                // Mekanik ses
                const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
                osc2.connect(g2); g2.connect(audioCtx.destination);
                osc2.type='square'; osc2.frequency.setValueAtTime(60, now);
                g2.gain.setValueAtTime(0.1, now); g2.gain.linearRampToValueAtTime(0, now+0.1);
                osc2.start(); osc2.stop(now+0.1);
            } else if (type === 'unlock') {
                osc.type='sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(); osc.stop(now+0.3);
            } else if (type === 'hit') {
                osc.type='triangle'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(50, now+0.1);
                gain.gain.setValueAtTime(0.4, now); gain.gain.linearRampToValueAtTime(0, now+0.1); osc.start(); osc.stop(now+0.1);
            }
        }

        let camera, scene, renderer, controls;
        let moveF=false, moveB=false, moveL=false, moveR=false, isSprinting=false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3(); const direction = new THREE.Vector3();

        let doorGroup = new THREE.Group();
        let zombieModel = null;
        let keyModel = null;
        let glockModel = null;
        let glockMixer = null; 
        let shootAction = null;
        let muzzleLight = null;

        // Oyun Durumları
        let hasKey = true;
        let hasGun = false;
        let doorState = 0; 
        let zombieState = 0; // 0:Bekliyor, 1:Dönüyor, 2:Kovalıyor, 3:Ölü
        let zombieHP = CONFIG.zombieHealth;

        // Silah & Aim
        let isAiming = false;
        let canShoot = true;
        // Silah Konumları (Kameraya göre)
        const gunHipPos = new THREE.Vector3(0.35, -0.4, -0.6); // Kalça
        const gunAimPos = new THREE.Vector3(0, -0.28, -0.4);   // Nişan (Göz hizası) - Model merkezine göre ayarlanmalı
        const gunCurrentPos = new THREE.Vector3().copy(gunHipPos);

        init(); animate();

        function init() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x050505);
            scene.fog = new THREE.FogExp2(0x050505, 0.08);

            camera = new THREE.PerspectiveCamera(CONFIG.fovBase, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.7, 12);

            const ambient = new THREE.AmbientLight(0xffffff, 0.2); scene.add(ambient);
            const flashLight = new THREE.SpotLight(0xffffff, 5, 45, Math.PI/6, 0.3, 1);
            flashLight.position.set(0,0,0); flashLight.target.position.set(0,0,-1);
            flashLight.castShadow=true; 
            camera.add(flashLight); camera.add(flashLight.target); scene.add(camera);

            controls = new PointerLockControls(camera, document.body);
            document.getElementById('blocker').addEventListener('click', ()=>controls.lock());
            controls.addEventListener('lock', ()=>document.getElementById('blocker').style.display='none');
            controls.addEventListener('unlock', ()=>{if(zombieState!==3)document.getElementById('blocker').style.display='flex';});

            // --- MAP ---
            const cvs = document.createElement('canvas'); cvs.width=512; cvs.height=512; const ctx=cvs.getContext('2d');
            ctx.fillStyle='#222'; ctx.fillRect(0,0,512,512); 
            ctx.strokeStyle='#111'; ctx.lineWidth=10; ctx.strokeRect(0,0,512,512); // Grid
            // Kan lekeleri
            for(let i=0;i<10;i++){ctx.fillStyle='rgba(50,0,0,0.5)';ctx.beginPath();ctx.arc(Math.random()*512,Math.random()*512,Math.random()*20+10,0,Math.PI*2);ctx.fill();}
            const mat = new THREE.MeshStandardMaterial({map:new THREE.CanvasTexture(cvs), roughness:0.8});

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(14,60), mat); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);
            const wGeo = new THREE.BoxGeometry(1,8,60);
            const wL = new THREE.Mesh(wGeo, mat); wL.position.set(-7,4,0); wL.receiveShadow=true; scene.add(wL);
            const wR = new THREE.Mesh(wGeo, mat); wR.position.set(7,4,0); wR.receiveShadow=true; scene.add(wR);
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(14,60), new THREE.MeshBasicMaterial({color:0x111111})); ceil.rotation.x=Math.PI/2; ceil.position.y=8; scene.add(ceil);

            const endZ = -20;
            const dw1 = new THREE.Mesh(new THREE.BoxGeometry(6,8,1), mat); dw1.position.set(-4,4,endZ); scene.add(dw1);
            const dw2 = new THREE.Mesh(new THREE.BoxGeometry(6,8,1), mat); dw2.position.set(4,4,endZ); scene.add(dw2);
            const dw3 = new THREE.Mesh(new THREE.BoxGeometry(2,2,1), mat); dw3.position.set(0,7,endZ); scene.add(dw3);

            // --- LOADER ---
            const loader = new GLTFLoader();

            loader.load('./Door.glb', (g)=>{
                const m = g.scene; m.position.set(0.5,0,0);
                doorGroup.add(m); doorGroup.position.set(-0.5,0,endZ); scene.add(doorGroup);
            }, undefined, ()=>{const d=new THREE.Mesh(new THREE.BoxGeometry(2,5,0.2),new THREE.MeshStandardMaterial({color:0x503010}));d.position.set(1,2.5,0);doorGroup.add(d);doorGroup.position.set(-1,0,endZ);scene.add(doorGroup);});

            loader.load('./Zombie.glb', (g)=>{
                zombieModel = g.scene;
                zombieModel.traverse(o=>{if(o.isMesh)o.castShadow=true;});
                zombieModel.position.set(0, 0, endZ - 4); 
                zombieModel.rotation.y = 0; // Duvara bakıyor (Arkası dönük)
                scene.add(zombieModel);
            }, undefined, ()=>{zombieModel=new THREE.Mesh(new THREE.CapsuleGeometry(0.6,1.8),new THREE.MeshStandardMaterial({color:0x00ff00}));zombieModel.position.set(0,0.9,endZ-4);scene.add(zombieModel);});

            loader.load('./Skeleton Key.glb', (g)=>{
                keyModel=g.scene; keyModel.scale.set(0.5,0.5,0.5);
                keyModel.position.set(0.5,-0.5,-0.8); keyModel.rotation.set(0,1.5,0); camera.add(keyModel);
            });

            // --- RIGGED GLOCK 19 ---
            loader.load('./Rigged Glock 19.glb', (g)=>{
                glockModel = g.scene;
                const s = CONFIG.gunScale;
                glockModel.scale.set(s, s, s);
                // "Rigged" modeller genelde ters veya farklı açıda gelebilir.
                // Namluyu öne (-Z) baktırmak için döndürüyoruz.
                glockModel.rotation.y = Math.PI; 
                glockModel.visible = false; 
                camera.add(glockModel);

                muzzleLight = new THREE.PointLight(0xffaa00, 0, 4);
                muzzleLight.position.set(0, 0.2, -0.6); // Namlu ucu ayarı
                glockModel.add(muzzleLight);

                // Animasyonları Yükle (Shoot)
                if(g.animations && g.animations.length > 0){
                    glockMixer = new THREE.AnimationMixer(glockModel);
                    // İlk animasyonu shoot olarak varsayıyoruz
                    shootAction = glockMixer.clipAction(g.animations[0]);
                    shootAction.setLoop(THREE.LoopOnce); 
                    shootAction.clampWhenFinished = true;
                }
            }, undefined, (err) => console.error("Glock yüklenemedi:", err));

            renderer = new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight);
            renderer.shadowMap.enabled=true; document.body.appendChild(renderer.domElement);
            
            window.addEventListener('resize', ()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
            
            document.addEventListener('keydown', (e)=>{
                switch(e.code){case 'KeyW':moveF=true;break;case 'KeyA':moveL=true;break;case 'KeyS':moveB=true;break;case 'KeyD':moveR=true;break;case 'ShiftLeft':isSprinting=true;break;case 'KeyE':interact();break;}
            });
            document.addEventListener('keyup', (e)=>{
                switch(e.code){case 'KeyW':moveF=false;break;case 'KeyA':moveL=false;break;case 'KeyS':moveB=false;break;case 'KeyD':moveR=false;break;case 'ShiftLeft':isSprinting=false;break;}
            });
            document.addEventListener('mousedown', (e)=>{
                if(!controls.isLocked) return;
                if(e.button === 0) shoot(); 
                if(e.button === 2) isAiming = true;
            });
            document.addEventListener('mouseup', (e)=>{ if(e.button===2) isAiming=false; });
        }

        function interact() {
            if(!hasKey || doorState !== 0) return;
            if(camera.position.distanceTo(doorGroup.position) < 5) {
                doorState = 1; playSound('unlock');
                if(keyModel) keyModel.visible = false; hasKey = false;
                setTimeout(()=>{ equipGun(); }, 500);
            }
        }

        function equipGun() {
            hasGun = true;
            if(glockModel) {
                glockModel.visible = true;
                glockModel.position.copy(gunHipPos);
            }
            document.getElementById('status-text').innerText = "HAYATTA KAL";
            document.getElementById('status-text').style.color = "red";
            document.getElementById('ammo-counter').style.display = "block";
        }

        function shoot() {
            if(!hasGun || !canShoot || !glockModel) return;
            canShoot = false;

            // Animasyon
            if(shootAction) { shootAction.stop(); shootAction.play(); }
            
            playSound('gunshot');
            if(muzzleLight) { muzzleLight.intensity = 5; setTimeout(()=>muzzleLight.intensity=0, 50); }
            
            // Recoil (Geri tepme)
            camera.rotation.x += CONFIG.recoil;

            // Raycast Hit Check
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
            if(zombieModel && zombieState !== 3) {
                const intersects = ray.intersectObject(zombieModel, true);
                if(intersects.length > 0) {
                    playSound('hit');
                    zombieHP--;
                    zombieModel.position.z -= 0.6; // Impact
                    const f = document.getElementById('hit-flash');
                    f.style.display='block'; setTimeout(()=>f.style.display='none', 100);
                    if(zombieHP <= 0) zombieDeath();
                }
            }
            setTimeout(()=>{ canShoot = true; }, 150); // Fire rate
        }

        function zombieDeath() {
            zombieState = 3; 
            if(zombieModel) {
                zombieModel.rotation.x = -Math.PI/2; 
                zombieModel.position.y = 0.2;
            }
            document.getElementById('msg').innerText = "BAŞARDIN";
            document.getElementById('msg').style.color = "#0f0";
            document.getElementById('blocker').style.display = 'flex';
            controls.unlock();
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now(); const delta = (time - prevTime) / 1000; prevTime = time;

            if(glockMixer) glockMixer.update(delta);

            if(hasGun && glockModel) {
                const targetPos = isAiming ? gunAimPos : gunHipPos;
                const targetFov = isAiming ? CONFIG.fovAim : CONFIG.fovBase;
                glockModel.position.lerp(targetPos, 15 * delta);
                camera.fov = THREE.MathUtils.lerp(camera.fov, targetFov, 15 * delta);
                camera.updateProjectionMatrix();
                document.getElementById('crosshair').style.opacity = isAiming ? '0' : '1';
                
                // Recoil Recovery (Silahı yavaşça aşağı indir)
                // Basit bir düzeltme:
                if(!canShoot && camera.rotation.x > 0) camera.rotation.x -= 1 * delta;
            }

            if(doorState === 1) {
                if(doorGroup.rotation.y > -Math.PI/1.5) doorGroup.rotation.y -= 1.5 * delta;
                else { doorState = 2; zombieState = 1; }
            }

            // ZOMBİ AI
            if(zombieModel && zombieState !== 3) {
                if(zombieState === 1) { // Dönüyor
                    const targetQ = new THREE.Quaternion();
                    const m = new THREE.Matrix4();
                    m.lookAt(new THREE.Vector3(camera.position.x, zombieModel.position.y, camera.position.z), zombieModel.position, new THREE.Vector3(0,1,0));
                    targetQ.setFromRotationMatrix(m);
                    zombieModel.quaternion.slerp(targetQ, CONFIG.zombieTurnSpeed * delta);
                    if(zombieModel.quaternion.angleTo(targetQ) < 0.2) zombieState = 2;
                } else if(zombieState === 2) { // Kovalıyor
                    zombieModel.lookAt(camera.position.x, 0, camera.position.z);
                    const dir = new THREE.Vector3().subVectors(camera.position, zombieModel.position).normalize();
                    zombieModel.position.add(dir.multiplyScalar(CONFIG.zombieSpeed * delta));
                    if(camera.position.distanceTo(zombieModel.position) < 1.2) {
                        document.getElementById('msg').innerText = "ÖLDÜN";
                        document.getElementById('blocker').style.display = 'flex';
                        controls.unlock();
                    }
                }
            }

            if(controls.isLocked) {
                const speed = isSprinting ? CONFIG.runSpeed : CONFIG.walkSpeed;
                velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveF) - Number(moveB); direction.x = Number(moveR) - Number(moveL); direction.normalize();
                if (moveF || moveB) velocity.z -= direction.z * speed * delta;
                if (moveL || moveR) velocity.x -= direction.x * speed * delta;
                controls.moveRight(-velocity.x*delta*0.02); controls.moveForward(-velocity.z*delta*0.02);
                
                const r = new THREE.Raycaster(); r.setFromCamera(new THREE.Vector2(), camera);
                const hits = r.intersectObjects([doorGroup], true);
                document.getElementById('interaction').style.display = (hits.length>0 && hits[0].distance<5 && doorState===0 && hasKey) ? 'block' : 'none';
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
