<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Karanlƒ±k Koridor: Hƒ±zlƒ± ve √ñfkeli</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        /* --- G√ñRSEL EFEKTLER --- */
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
            pointer-events: none; z-index: 5;
        }

        #grain {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.05"/%3E%3C/svg%3E');
            pointer-events: none; z-index: 4; opacity: 0.3;
            animation: grainAnim 0.5s steps(5) infinite;
        }
        @keyframes grainAnim { 0% { transform:translate(0,0) } 100% { transform:translate(-5%,-5%) } }

        /* ARAY√úZ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        #inventory { padding: 25px; color: #ffcc00; font-size: 22px; font-weight: bold; text-shadow: 2px 2px 5px #000; }
        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 18px; display: none; text-align: center; letter-spacing: 2px;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; border: 1px solid #fff;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: rgba(255, 255, 255, 0.8); border-radius: 50%; transform: translate(-50%, -50%); z-index: 6;
            box-shadow: 0 0 6px #fff;
        }
        
        /* EKRANLAR */
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #111;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 999; pointer-events: all; color: #ddd;
        }
        #instructions { font-size: 24px; cursor: pointer; text-align: center; }
        #instructions span { color: #f00; font-size: 40px; font-weight: bold; }
        
        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #200; color: #f00; z-index: 1000;
            justify-content: center; align-items: center; flex-direction: column;
            font-size: 100px; font-weight: bold; text-shadow: 0 0 30px #f00;
        }

    </style>
</head>
<body>

    <div id="vignette"></div>
    <div id="grain"></div>
    <div id="game-over">YAKALANDIN</div>

    <div id="blocker">
        <div id="instructions">
            <span>BA≈ûLAT</span><br/><br/>
            (Farenin hassasiyeti ve hƒ±z arttƒ±rƒ±ldƒ±)<br/>
            W,A,S,D = Hareket | SHIFT = Depar
        </div>
    </div>

    <div id="crosshair"></div>

    <div id="ui-layer">
        <div id="inventory">ENVANTER: <span id="key-status">Skeleton Key</span> üóùÔ∏è</div>
        <div id="interaction">[E] KAPIYI A√á</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- AYARLAR ---
        const SETTINGS = {
            walkSpeed: 800.0,    // √ñnceki: 400 (2 kat hƒ±zlandƒ±)
            runMultiplier: 2.5,  // Ko≈üma √ßarpanƒ±
            zombieSpeed: 11.0,   // Zombi de hƒ±zlandƒ± (Adil olsun)
            fogDensity: 0.05,    // √ñnceki: 0.12 (Daha az sis, daha √ßok g√∂r√º≈ü)
            lightIntensity: 0.6  // Ortam ƒ±≈üƒ±ƒüƒ±
        };

        // --- SES ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'unlock') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(100, now+0.3);
                gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
                osc.start(); osc.stop(now+0.3);
            } else if (type === 'scream') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(800, now+0.5);
                gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now+1.0);
                osc.start(); osc.stop(now+1.0);
            }
        }

        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, isSprinting = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        let doorGroup = new THREE.Group();
        let zombieModel = null;
        let keyModel = null;
        let hasKey = true;
        let doorState = 0; 
        let chaseMode = false;
        let isGameOver = false;

        const interactionUI = document.getElementById('interaction');
        const blocker = document.getElementById('blocker');
        const instructions = document.getElementById('instructions');
        const gameOverScreen = document.getElementById('game-over');

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101010); // Arka plan biraz grile≈üti
            scene.fog = new THREE.FogExp2(0x101010, SETTINGS.fogDensity); // Sis azaltƒ±ldƒ±

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.7, 10);

            // --- I≈ûIKLANDIRMA (Geli≈ütirildi) ---
            const ambient = new THREE.AmbientLight(0xffffff, SETTINGS.lightIntensity); 
            scene.add(ambient);

            const flashLight = new THREE.SpotLight(0xffffff, 8, 45, Math.PI/5, 0.3, 1);
            flashLight.position.set(0, 0, 0);
            flashLight.target.position.set(0, 0, -1);
            flashLight.castShadow = true;
            flashLight.shadow.bias = -0.0001;
            camera.add(flashLight);
            camera.add(flashLight.target);
            scene.add(camera);

            controls = new PointerLockControls(camera, document.body);

            instructions.addEventListener('click', () => controls.lock());
            controls.addEventListener('lock', () => { blocker.style.display = 'none'; });
            controls.addEventListener('unlock', () => { if(!isGameOver) blocker.style.display = 'flex'; });

            // --- DOKULAR VE MAP ---
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            // Daha a√ßƒ±k renkli duvarlar (I≈üƒ±k yansƒ±sƒ±n diye)
            ctx.fillStyle = '#444'; ctx.fillRect(0,0,512,512); 
            ctx.strokeStyle = '#222'; ctx.lineWidth=10; ctx.strokeRect(0,0,512,512);
            // Biraz detay
            for(let i=0;i<20;i++){
                ctx.fillStyle = Math.random()>0.5 ? '#333' : '#555';
                ctx.fillRect(Math.random()*500, Math.random()*500, 50, 50);
            }
            const wallTex = new THREE.CanvasTexture(canvas);
            wallTex.wrapS = THREE.RepeatWrapping; wallTex.wrapT = THREE.RepeatWrapping;
            wallTex.repeat.set(4, 4);

            const wallMat = new THREE.MeshStandardMaterial({ map: wallTex, roughness: 0.6 });

            // Zemin
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(12, 60), wallMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Duvarlar
            const wallGeo = new THREE.BoxGeometry(1, 8, 60);
            const wallL = new THREE.Mesh(wallGeo, wallMat); wallL.position.set(-6, 4, 0);
            wallL.receiveShadow = true; wallL.castShadow = true;
            scene.add(wallL);
            const wallR = new THREE.Mesh(wallGeo, wallMat); wallR.position.set(6, 4, 0);
            wallR.receiveShadow = true; wallR.castShadow = true;
            scene.add(wallR);

            // Tavan
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(12, 60), new THREE.MeshBasicMaterial({color:0x111111}));
            ceil.rotation.x = Math.PI / 2; ceil.position.y = 8;
            scene.add(ceil);

            // Kapƒ± Duvarƒ± (Zombi Saklayan)
            const endZ = -20;
            const w1 = new THREE.Mesh(new THREE.BoxGeometry(5, 8, 1), wallMat); w1.position.set(-3.5, 4, endZ);
            w1.castShadow = true; scene.add(w1);
            const w2 = new THREE.Mesh(new THREE.BoxGeometry(5, 8, 1), wallMat); w2.position.set(3.5, 4, endZ);
            w2.castShadow = true; scene.add(w2);
            const w3 = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 1), wallMat); w3.position.set(0, 6.5, endZ);
            w3.castShadow = true; scene.add(w3);

            // --- MODEL Y√úKLEME ---
            const loader = new GLTFLoader();

            loader.load('./Door.glb', (gltf) => {
                const model = gltf.scene;
                model.position.set(0.5, 0, 0);
                doorGroup.add(model);
                doorGroup.position.set(-0.5, 0, endZ);
                scene.add(doorGroup);
            }, undefined, () => {
                // Yedek
                const d = new THREE.Mesh(new THREE.BoxGeometry(2, 5, 0.2), new THREE.MeshStandardMaterial({color:0x503010}));
                d.position.set(1, 2.5, 0); doorGroup.add(d); doorGroup.position.set(-1, 0, endZ); scene.add(doorGroup);
            });

            loader.load('./Zombie.glb', (gltf) => {
                zombieModel = gltf.scene;
                zombieModel.traverse(o=>{if(o.isMesh)o.castShadow=true;});
                zombieModel.position.set(0, 0, endZ - 4); // Duvarƒ±n arkasƒ±nda
                zombieModel.rotation.y = Math.PI;
                scene.add(zombieModel);
            }, undefined, () => {
                zombieModel = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.8), new THREE.MeshStandardMaterial({color:0x33ff33}));
                zombieModel.position.set(0, 0.9, endZ - 4); scene.add(zombieModel);
            });

            loader.load('./Skeleton Key.glb', (gltf) => {
                keyModel = gltf.scene;
                keyModel.scale.set(0.5, 0.5, 0.5);
                keyModel.position.set(0.5, -0.5, -0.8);
                keyModel.rotation.set(0, 1.5, 0);
                camera.add(keyModel);
            });

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
        }

        function onKeyDown(e) {
            switch(e.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyD': moveRight = true; break;
                case 'ShiftLeft': isSprinting = true; break;
                case 'KeyE': interact(); break;
            }
        }
        function onKeyUp(e) {
            switch(e.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyD': moveRight = false; break;
                case 'ShiftLeft': isSprinting = false; break;
            }
        }

        function interact() {
            if(!hasKey || doorState !== 0) return;
            if(camera.position.distanceTo(doorGroup.position) < 5) {
                doorState = 1;
                hasKey = false;
                if(keyModel) keyModel.visible = false;
                document.getElementById('key-status').innerText = "YOK";
                document.getElementById('key-status').style.color = "red";
                playSound('unlock');
                setTimeout(()=>playSound('scream'), 500);
            }
        }

        function animate() {
            if(isGameOver) return;
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            prevTime = time;

            // Kapƒ±
            if(doorState === 1) {
                if(doorGroup.rotation.y > -Math.PI/1.5) doorGroup.rotation.y -= 2 * delta;
                else chaseMode = true;
            }

            // Zombi
            if(chaseMode && zombieModel) {
                zombieModel.lookAt(camera.position.x, 0, camera.position.z);
                const dir = new THREE.Vector3().subVectors(camera.position, zombieModel.position).normalize();
                zombieModel.position.add(dir.multiplyScalar(SETTINGS.zombieSpeed * delta));
                
                // Titreme efekti
                if(Math.random()>0.7) zombieModel.position.x += (Math.random()-0.5)*0.3;

                if(camera.position.distanceTo(zombieModel.position) < 1.5) {
                    isGameOver = true;
                    controls.unlock();
                    gameOverScreen.style.display = 'flex';
                }
            }

            // Hareket (Hƒ±zlandƒ±rƒ±ldƒ±)
            if(controls.isLocked) {
                const speedMulti = isSprinting ? SETTINGS.runMultiplier : 1.0;
                
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * SETTINGS.walkSpeed * speedMulti * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * SETTINGS.walkSpeed * speedMulti * delta;

                controls.moveRight(-velocity.x * delta * 0.02);
                controls.moveForward(-velocity.z * delta * 0.02);

                const ray = new THREE.Raycaster();
                ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects([doorGroup], true);
                if(hits.length > 0 && hits[0].distance < 5 && doorState === 0 && hasKey) {
                    interactionUI.style.display = 'block';
                } else {
                    interactionUI.style.display = 'none';
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
