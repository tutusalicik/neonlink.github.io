<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CS2 WEB: TITAN RTX</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; user-select: none; font-family: 'Segoe UI', sans-serif; }
        
        /* SHADER OVERLAYS (Vignette & Grain) */
        #screen-fx { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 50; box-shadow: inset 0 0 150px rgba(0,0,0,0.8); }
        #screen-fx::after { content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.03; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); pointer-events: none; }

        /* LOADING */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ffd700; }
        .bar-bg { width: 300px; height: 3px; background: #222; margin-top: 15px; }
        .bar-fill { width: 0%; height: 100%; background: #ffd700; transition: 0.1s; box-shadow: 0 0 10px #ffd700; }
        
        /* HUD */
        #hud { position: absolute; width:100%; height:100%; pointer-events: none; display: none; z-index: 60; }
        
        #crosshair { position: absolute; top:50%; left:50%; width:4px; height:4px; background:#0f0; transform:translate(-50%,-50%); box-shadow: 0 0 4px #000; border-radius: 50%; transition: 0.1s; }
        .spread #crosshair { width: 20px; height: 20px; border: 2px solid #0f0; background: transparent; }

        #stats { position: absolute; bottom: 30px; left: 30px; display: flex; gap: 30px; text-shadow: 2px 2px 0 #000; }
        .stat h1 { margin: 0; font-size: 50px; color: #fff; font-weight: 900; }
        .stat span { font-size: 12px; color: #888; letter-spacing: 2px; font-weight: bold; }
        #ammo-val { color: #ffd700; }
        
        #damage-flash { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, transparent 50%, red 100%); opacity: 0; transition: opacity 0.1s; }

        /* MENU */
        #menu { position: absolute; width:100%; height:100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 100; display: none; align-items: center; justify-content: center; }
        button { padding: 20px 50px; background: #ffd700; border: none; font-size: 20px; font-weight: bold; cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%); transition: 0.2s; }
        button:hover { transform: scale(1.05); background: #fff; }
    </style>
</head>
<body>

    <div id="loader">
        <h2 style="font-family: monospace;">INITIALIZING SHADERS...</h2>
        <div class="bar-bg"><div class="bar-fill" id="l-bar"></div></div>
    </div>

    <div id="menu">
        <h1 style="color:#fff; font-size:60px; font-style:italic;">CS:WEB <span style="color:#ffd700">RTX</span></h1>
        <button onclick="Game.start()">DEPLOY</button>
    </div>

    <div id="hud">
        <div id="screen-fx"></div>
        <div id="damage-flash"></div>
        <div id="crosshair"></div>
        <div id="stats">
            <div class="stat">
                <h1 id="hp-txt">100</h1>
                <span>HEALTH</span>
            </div>
            <div class="stat">
                <h1 id="ammo-txt">30</h1>
                <span>AMMUNITION</span>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // ==========================================
        // ‚öôÔ∏è ULTRA CONFIG (BURAYI KONTROL ET)
        // ==========================================
        const CONFIG = {
            weapon: {
                scale: 0.15,         // Silah boyutu
                pos: { x: 0.2, y: -0.3, z: -0.5 }, // Konum
                rot: { x: 0, y: Math.PI, z: 0 }    // Y√∂n (Tersse PI yap)
            },
            bot: {
                viewDistance: 40,   // Botun g√∂r√º≈ü mesafesi
                reactionTime: 0.5,  // Tepki s√ºresi (saniye)
                scale: 0.05         // Guy.glb boyutu
            },
            graphics: {
                bloom: 1.2,         // Parlama ≈üiddeti
                exposure: 1.0       // I≈üƒ±k patlamasƒ±
            }
        };

        const Sys = { scene: null, camera: null, renderer: null, composer: null, controls: null, assets: {} };
        const World = { map: null, gun: null, bots: [], bullets: [] };
        const Player = { hp: 100, ammo: 30, firing: false, lastShot: 0 };
        const Raycaster = new THREE.Raycaster(); // Bot g√∂r√º≈ü√º i√ßin

        init();

        async function init() {
            // 1. RENDERER (High Quality)
            Sys.renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" }); // AA composerda yapƒ±lacak
            Sys.renderer.setSize(window.innerWidth, window.innerHeight);
            Sys.renderer.setPixelRatio(window.devicePixelRatio);
            Sys.renderer.toneMapping = THREE.ACESFilmicToneMapping; // Ger√ßek√ßi renkler
            Sys.renderer.toneMappingExposure = CONFIG.graphics.exposure;
            Sys.renderer.shadowMap.enabled = true;
            Sys.renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Yumu≈üak g√∂lgeler
            document.body.appendChild(Sys.renderer.domElement);

            // 2. SCENE & CAMERA
            Sys.scene = new THREE.Scene();
            Sys.scene.background = new THREE.Color(0x050505);
            Sys.scene.fog = new THREE.FogExp2(0x050505, 0.02); // Volumetric sis hissi

            Sys.camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.01, 1000); // 0.01 √ßok √∂nemli!
            Sys.camera.position.y = 1.7;

            // 3. POST-PROCESSING (SHADERS)
            const renderScene = new RenderPass(Sys.scene, Sys.camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0;
            bloomPass.strength = CONFIG.graphics.bloom;
            bloomPass.radius = 0.5;

            const outputPass = new OutputPass();

            Sys.composer = new EffectComposer(Sys.renderer);
            Sys.composer.addPass(renderScene);
            Sys.composer.addPass(bloomPass);
            Sys.composer.addPass(outputPass);

            // 4. LIGHTING
            const amb = new THREE.AmbientLight(0xffffff, 0.1); // Karanlƒ±k atmosfer
            Sys.scene.add(amb);
            
            const spot = new THREE.SpotLight(0xffd700, 50); // Sokak lambasƒ± efekti
            spot.position.set(10, 20, 10);
            spot.angle = Math.PI / 4;
            spot.penumbra = 0.5;
            spot.castShadow = true;
            Sys.scene.add(spot);

            const hemi = new THREE.HemisphereLight(0x444444, 0x000000, 1);
            Sys.scene.add(hemi);

            Sys.controls = new PointerLockControls(Sys.camera, document.body);

            // 5. LOAD ASSETS
            await loadAll();
        }

        async function loadAll() {
            const loader = new GLTFLoader();
            const files = { map: 'map.glb', guy: 'guy.glb', gun: 'Ak47.glb' };
            const keys = Object.keys(files);

            for(let i=0; i<keys.length; i++) {
                const k = keys[i];
                try {
                    const gltf = await loader.loadAsync(files[k]);
                    Sys.assets[k] = gltf.scene;
                    document.getElementById('l-bar').style.width = ((i+1)/3)*100 + "%";
                } catch(e) {
                    console.error("Y√ºkleme hatasƒ±:", k);
                    Sys.assets[k] = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshBasicMaterial({color:'red'}));
                }
            }
            document.getElementById('loader').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        }

        window.Game = {
            start: () => {
                document.getElementById('menu').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                Sys.controls.lock();
                buildWorld();
                animate();
            }
        };

        function buildWorld() {
            // MAP
            const map = Sys.assets.map;
            map.traverse(o => { 
                if(o.isMesh) { 
                    o.receiveShadow = true; 
                    o.castShadow = true;
                    // Harita materyallerini ger√ßek√ßi yap
                    o.material.roughness = 0.8;
                    o.material.metalness = 0.2;
                } 
            });
            Sys.scene.add(map);
            World.map = map; // Botlar i√ßin referans

            // WEAPON (FIXED RENDER ORDER)
            const gun = Sys.assets.gun;
            gun.scale.set(CONFIG.weapon.scale, CONFIG.weapon.scale, CONFIG.weapon.scale);
            gun.position.set(CONFIG.weapon.pos.x, CONFIG.weapon.pos.y, CONFIG.weapon.pos.z);
            gun.rotation.set(CONFIG.weapon.rot.x, CONFIG.weapon.rot.y, CONFIG.weapon.rot.z);
            
            // Sƒ∞LAH G√ñR√úNMEZ SORUNUNU √á√ñZEN Sƒ∞Hƒ∞RLƒ∞ KOD:
            gun.traverse(o => {
                if(o.isMesh) {
                    o.castShadow = false;
                    o.receiveShadow = false;
                    o.material.depthTest = false; // Duvarƒ±n i√ßinden ge√ßse bile √ºstte √ßiz
                    o.renderOrder = 999; // Her ≈üeyden sonra √ßiz
                }
            });

            World.gun = new THREE.Group();
            World.gun.add(gun);
            Sys.camera.add(World.gun);
            Sys.scene.add(Sys.camera);

            // BOTS
            spawnBot(5, 0, 10);
            spawnBot(-5, 0, 15);
            spawnBot(0, 0, 20);
        }

        function spawnBot(x, y, z) {
            const bot = Sys.assets.guy.clone();
            bot.scale.set(CONFIG.bot.scale, CONFIG.bot.scale, CONFIG.bot.scale);
            bot.position.set(x, y, z);
            
            bot.traverse(o => { if(o.isMesh) { o.castShadow = true; } });

            // Bota da silah ver
            const botGun = Sys.assets.gun.clone();
            botGun.scale.set(1,1,1); // Guy'ƒ±n scale'ine g√∂re
            botGun.position.set(0.2, 1.2, 0.4); 
            botGun.rotation.y = Math.PI;
            bot.add(botGun);

            Sys.scene.add(bot);
            World.bots.push({ mesh: bot, hp: 100, lastSeenPlayer: 0, state: 'idle' });
        }

        // ==========================================
        // üß† GAME LOOP & AI
        // ==========================================
        function animate() {
            requestAnimationFrame(animate);
            const dt = 0.016;
            const now = Date.now() / 1000;

            // 1. OYUNCU HAREKETƒ∞
            handleMovement(dt);

            // 2. Sƒ∞LAH EFEKTLERƒ∞
            if(Player.firing && Sys.controls.isLocked) {
                if(now - Player.lastShot > 0.1) {
                    fire(true);
                    Player.lastShot = now;
                }
                document.getElementById('hud').classList.add('spread');
                
                // Recoil
                World.gun.position.z = CONFIG.weapon.pos.z + 0.1;
                World.gun.rotation.x = 0.1;
            } else {
                document.getElementById('hud').classList.remove('spread');
                // Recovery
                if(World.gun) {
                    World.gun.position.z = THREE.MathUtils.lerp(World.gun.position.z, CONFIG.weapon.pos.z, 0.1);
                    World.gun.rotation.x = THREE.MathUtils.lerp(World.gun.rotation.x, 0, 0.1);
                }
            }

            // 3. BOT ZEKASI (RAYCAST WALLHACK ENGELLEYƒ∞Cƒ∞)
            World.bots.forEach(bot => {
                if(bot.hp <= 0) return;

                // Oyuncuya olan y√∂n ve mesafe
                const botPos = new THREE.Vector3();
                bot.mesh.getWorldPosition(botPos);
                botPos.y += 1.5; // G√∂z hizasƒ±

                const playerPos = Sys.camera.position.clone();
                const dist = botPos.distanceTo(playerPos);
                const dirToPlayer = playerPos.clone().sub(botPos).normalize();

                // 1. Mesafe Kontrol√º
                if(dist < CONFIG.bot.viewDistance) {
                    // 2. RAYCAST (G√ñR√ú≈û KONTROL√ú)
                    Raycaster.set(botPos, dirToPlayer);
                    // Hem haritayƒ± hem oyuncuyu kontrol etmemiz lazƒ±m ama 
                    // basitlik i√ßin haritaya √ßarpƒ±yor mu diye bakƒ±caz.
                    // Ray'in boyu oyuncuya kadar olsun
                    Raycaster.far = dist; 
                    
                    // Sadece harita meshleri ile test et
                    const hits = Raycaster.intersectObject(World.map, true);

                    if(hits.length === 0) {
                        // Engel yok, oyuncuyu g√∂r√ºyor!
                        bot.mesh.lookAt(playerPos.x, bot.mesh.position.y, playerPos.z);
                        
                        // Ate≈ü etme mantƒ±ƒüƒ±
                        if(Math.random() < 0.05) fire(false, bot); // Rastgele ate≈ü
                    }
                }
            });

            // 4. MERMƒ∞LERƒ∞ G√úNCELLE
            updateBullets();

            Sys.composer.render();
        }

        function handleMovement(dt) {
            const s = 6.0;
            const dir = new THREE.Vector3();
            if(keys.w) dir.z = 1; if(keys.s) dir.z = -1;
            if(keys.a) dir.x = -1; if(keys.d) dir.x = 1;
            if(dir.length()>0) {
                Sys.controls.moveForward(dir.z * s * dt);
                Sys.controls.moveRight(dir.x * s * dt);
            }
        }

        function fire(isPlayer, bot=null) {
            const start = new THREE.Vector3();
            const dir = new THREE.Vector3();

            if(isPlayer) {
                if(Player.ammo <= 0) return;
                Player.ammo--;
                document.getElementById('ammo-txt').innerText = Player.ammo;
                
                Sys.camera.getWorldPosition(start);
                Sys.camera.getWorldDirection(dir);
                // Silah namlusundan √ßƒ±kƒ±yormu≈ü gibi ayarla
                start.add(dir.clone().multiplyScalar(0.5)).add(Sys.camera.getWorldDirection(new THREE.Vector3()).cross(new THREE.Vector3(0,1,0)).multiplyScalar(0.2));
                start.y -= 0.1;

                // Raycast Vuru≈ü
                const ray = new THREE.Raycaster(Sys.camera.position, dir);
                const targets = World.bots.map(b => b.mesh);
                const hits = ray.intersectObjects(targets, true);
                if(hits.length > 0) {
                    const hitObj = hits[0].object;
                    // Botu bul
                    const botRef = World.bots.find(b => b.mesh === hitObj.parent || b.mesh === hitObj);
                    if(botRef) {
                        botRef.hp -= 25;
                        // Hit efekti
                        hitObj.material.emissive = new THREE.Color(0xff0000);
                        setTimeout(() => hitObj.material.emissive = new THREE.Color(0x000000), 50);
                        if(botRef.hp <= 0) {
                            botRef.mesh.rotation.x = -Math.PI/2;
                            botRef.mesh.position.y = 0.2;
                        }
                    }
                }

            } else {
                // Bot Ate≈üi
                bot.mesh.getWorldPosition(start);
                start.y += 1.2;
                dir.subVectors(Sys.camera.position, start).normalize();
                // Biraz hata payƒ± ekle (Aim)
                dir.x += (Math.random()-0.5)*0.1;
                dir.y += (Math.random()-0.5)*0.1;
                
                // Oyuncuya hasar
                if(Math.random() > 0.7) { // %30 isabet
                    Player.hp -= 5;
                    document.getElementById('hp-txt').innerText = Player.hp;
                    document.getElementById('damage-flash').style.opacity = 0.8;
                    setTimeout(() => document.getElementById('damage-flash').style.opacity = 0, 200);
                    if(Player.hp <= 0) { location.reload(); alert("√ñLD√úN!"); }
                }
            }

            // TRACER (Sarƒ± √áizgi)
            const mat = new THREE.MeshBasicMaterial({color: 0xffff00});
            const geo = new THREE.BoxGeometry(0.02, 0.02, 2);
            const bullet = new THREE.Mesh(geo, mat);
            bullet.position.copy(start);
            bullet.lookAt(start.clone().add(dir));
            bullet.userData = { vel: dir.multiplyScalar(2), life: 0 };
            Sys.scene.add(bullet);
            World.bullets.push(bullet);
        }

        function updateBullets() {
            for(let i=World.bullets.length-1; i>=0; i--) {
                const b = World.bullets[i];
                b.position.add(b.userData.vel);
                b.userData.life++;
                if(b.userData.life > 30) {
                    Sys.scene.remove(b);
                    World.bullets.splice(i, 1);
                }
            }
        }

        const keys = { w:false, a:false, s:false, d:false };
        document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        document.addEventListener('mousedown', () => { if(Sys.controls.isLocked) Player.firing = true; });
        document.addEventListener('mouseup', () => Player.firing = false);

    </script>
</body>
</html>
