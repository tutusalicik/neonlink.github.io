<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Karanlƒ±k Koridor: Final S√ºr√ºm</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020202; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        /* --- EKRAN EFEKTLERƒ∞ (SHADER Gƒ∞Bƒ∞) --- */
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 50%, rgba(0,0,0,0.95) 100%);
            pointer-events: none; z-index: 5;
        }
        #grain {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.05"/%3E%3C/svg%3E');
            pointer-events: none; z-index: 4; opacity: 0.4;
            animation: grainAnim 0.5s steps(5) infinite;
        }
        @keyframes grainAnim { 0% { transform:translate(0,0) } 100% { transform:translate(-5%,-5%) } }

        /* --- ARAY√úZ --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        #inventory { padding: 25px; color: #d4af37; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 5px #000; }
        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 16px; display: none; text-align: center; letter-spacing: 2px;
            background: rgba(0,0,0,0.8); padding: 12px; border-radius: 4px; border: 1px solid #555;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: rgba(255, 255, 255, 0.6); border-radius: 50%; transform: translate(-50%, -50%); z-index: 6;
            box-shadow: 0 0 4px #fff;
        }
        
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #050505;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 999; pointer-events: all; color: #999;
        }
        #instructions { font-size: 22px; cursor: pointer; text-align: center; line-height: 1.6; }
        #instructions span { color: #c00; font-size: 36px; font-weight: bold; }
        
        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #300; color: #f00; z-index: 1000;
            justify-content: center; align-items: center; flex-direction: column;
            font-size: 80px; font-weight: bold; text-shadow: 0 0 50px #f00;
        }
    </style>
</head>
<body>
    <div id="vignette"></div>
    <div id="grain"></div>
    <div id="game-over">YAKALANDIN</div>
    
    <div id="blocker">
        <div id="instructions">
            <span>BA≈ûLAT</span><br/>
            (Fair Play Modu Aktif)<br/>
            W,A,S,D = Y√ºr√º | SHIFT = Ko≈ü | E = Kapƒ±
        </div>
    </div>

    <div id="crosshair"></div>
    
    <div id="ui-layer">
        <div id="inventory">ENVANTER: <span id="key-status">Skeleton Key</span> üóùÔ∏è</div>
        <div id="interaction">[E] Kƒ∞Lƒ∞Dƒ∞ A√á</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- OYUN AYARLARI (DENGELƒ∞) ---
        const SETTINGS = {
            walkSpeed: 500.0,    
            runMultiplier: 2.0,  
            zombieSpeed: 9.2,    
            zombieScale: 0.7,    // Zombi boyutu %70
            hesitationTime: 1500, // Zombi kapƒ± a√ßƒ±lƒ±nca 1.5 saniye bekler (Fair Play)
            fogDensity: 0.09,
            lightIntensity: 0.3
        };

        // --- SES MOTORU (CODE-GENERATED) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
            
            if (type === 'unlock') {
                osc.type='sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.linearRampToValueAtTime(50, now+0.4);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.4); osc.start(); osc.stop(now+0.4);
            } else if (type === 'tension') { 
                // Bekleme anƒ± gerilim sesi
                osc.type='triangle'; osc.frequency.setValueAtTime(60, now); 
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+2); 
                osc.start(); osc.stop(now+2);
            } else if (type === 'scream') { 
                // Saldƒ±rƒ± sesi
                osc.type='sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(1200, now+0.8);
                gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now+1.2); 
                osc.start(); osc.stop(now+1.2);
            }
        }

        let camera, scene, renderer, controls;
        let moveForward=false, moveBackward=false, moveLeft=false, moveRight=false, isSprinting=false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3(); const direction = new THREE.Vector3();

        let doorGroup = new THREE.Group();
        let zombieModel = null; let keyModel = null;
        let hasKey = true;
        
        // DURUMLAR: 0:Kapalƒ±, 1:A√ßƒ±lƒ±yor(Anim), 2:A√ßƒ±k(Bekliyor), 3:Kovalƒ±yor
        let doorState = 0; 
        let zombieSpottedTime = 0;
        let isGameOver = false;

        const interactionUI = document.getElementById('interaction');
        const blocker = document.getElementById('blocker');
        const gameOverScreen = document.getElementById('game-over');

        init(); animate();

        function init() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x050505);
            scene.fog = new THREE.FogExp2(0x050505, SETTINGS.fogDensity);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.7, 12); 

            // I≈üƒ±klandƒ±rma
            const ambient = new THREE.AmbientLight(0xffffff, SETTINGS.lightIntensity); scene.add(ambient);
            const flashLight = new THREE.SpotLight(0xffffff, 8, 55, Math.PI/5, 0.4, 1);
            flashLight.position.set(0,0,0); flashLight.target.position.set(0,0,-1);
            flashLight.castShadow=true; flashLight.shadow.bias=-0.0001;
            camera.add(flashLight); camera.add(flashLight.target); scene.add(camera);

            controls = new PointerLockControls(camera, document.body);
            document.getElementById('instructions').addEventListener('click', ()=>controls.lock());
            controls.addEventListener('lock', ()=>{blocker.style.display='none';});
            controls.addEventListener('unlock', ()=>{if(!isGameOver)blocker.style.display='flex';});

            // --- MAP DOKULARI ---
            const canvas = document.createElement('canvas'); canvas.width=512; canvas.height=512; const ctx=canvas.getContext('2d');
            ctx.fillStyle='#333'; ctx.fillRect(0,0,512,512); 
            ctx.strokeStyle='#111'; ctx.lineWidth=10; ctx.strokeRect(0,0,512,512);
            // Duvar kirleri
            for(let i=0;i<60;i++){ctx.fillStyle=`rgba(0,0,0,${Math.random()*0.4})`;ctx.fillRect(Math.random()*512,Math.random()*512,30,30);}
            const wallTex = new THREE.CanvasTexture(canvas); wallTex.wrapS=wallTex.wrapT=THREE.RepeatWrapping; wallTex.repeat.set(4,4);
            const wallMat = new THREE.MeshStandardMaterial({map:wallTex, roughness:0.8});

            // Zemin ve Duvarlar
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(14,70), wallMat); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);
            const wallGeo = new THREE.BoxGeometry(1,9,70);
            const wallL = new THREE.Mesh(wallGeo,wallMat); wallL.position.set(-7,4.5,0); wallL.receiveShadow=wallL.castShadow=true; scene.add(wallL);
            const wallR = new THREE.Mesh(wallGeo,wallMat); wallR.position.set(7,4.5,0); wallR.receiveShadow=wallR.castShadow=true; scene.add(wallR);
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(14,70), new THREE.MeshBasicMaterial({color:0x020202})); ceil.rotation.x=Math.PI/2; ceil.position.y=9; scene.add(ceil);

            // --- KAPI DUVARI (Gƒ∞ZLƒ∞Lƒ∞K ƒ∞√áƒ∞N) ---
            const endZ = -22;
            const w1 = new THREE.Mesh(new THREE.BoxGeometry(8, 9, 2), wallMat); w1.position.set(-5, 4.5, endZ); w1.castShadow=true; scene.add(w1);
            const w2 = new THREE.Mesh(new THREE.BoxGeometry(8, 9, 2), wallMat); w2.position.set(5, 4.5, endZ); w2.castShadow=true; scene.add(w2);
            const w3 = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 2), wallMat); w3.position.set(0, 7.5, endZ); w3.castShadow=true; scene.add(w3);

            // --- MODELLER ---
            const loader = new GLTFLoader();
            
            // KAPI
            loader.load('./Door.glb', (gltf) => {
                const model = gltf.scene; model.position.set(0.5, 0, 0);
                doorGroup.add(model); doorGroup.position.set(-0.5, 0, endZ); scene.add(doorGroup);
            }, undefined, ()=>{
                // Yedek
                const d=new THREE.Mesh(new THREE.BoxGeometry(2,5,0.2),new THREE.MeshStandardMaterial({color:0x503010}));
                d.position.set(1,2.5,0);doorGroup.add(d);doorGroup.position.set(-1,0,endZ);scene.add(doorGroup);
            });

            // ZOMBƒ∞
            loader.load('./Zombie.glb', (gltf) => {
                zombieModel = gltf.scene;
                zombieModel.traverse(o=>{if(o.isMesh)o.castShadow=true;});
                // %70 K√º√ß√ºltme ve Konum
                const s = SETTINGS.zombieScale;
                zombieModel.scale.set(s, s, s); 
                zombieModel.position.set(0, 0, endZ - 4); // Duvarƒ±n arkasƒ±nda saklƒ±
                zombieModel.rotation.y = Math.PI;
                scene.add(zombieModel);
            }, undefined, ()=>{
                // Yedek
                zombieModel=new THREE.Mesh(new THREE.CapsuleGeometry(0.5,1.7),new THREE.MeshStandardMaterial({color:0x33ff33}));
                zombieModel.position.set(0,0.85,endZ-4);scene.add(zombieModel);
            });

            // ANAHTAR
            loader.load('./Skeleton Key.glb', (gltf)=>{
                keyModel=gltf.scene; keyModel.scale.set(0.5,0.5,0.5);
                keyModel.position.set(0.5,-0.5,-0.8); keyModel.rotation.set(0,1.5,0);
                camera.add(keyModel);
            });

            renderer = new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight);
            renderer.shadowMap.enabled=true; document.body.appendChild(renderer.domElement);
            window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
            document.addEventListener('keydown',onKeyDown); document.addEventListener('keyup',onKeyUp);
        }

        function onKeyDown(e){switch(e.code){case 'KeyW':moveForward=true;break;case 'KeyA':moveLeft=true;break;case 'KeyS':moveBackward=true;break;case 'KeyD':moveRight=true;break;case 'ShiftLeft':isSprinting=true;break;case 'KeyE':interact();break;}}
        function onKeyUp(e){switch(e.code){case 'KeyW':moveForward=false;break;case 'KeyA':moveLeft=false;break;case 'KeyS':moveBackward=false;break;case 'KeyD':moveRight=false;break;case 'ShiftLeft':isSprinting=false;break;}}

        function interact() {
            if(!hasKey || doorState !== 0) return;
            // Mesafe kontrol√º
            if(camera.position.distanceTo(doorGroup.position) < 5) {
                doorState = 1; hasKey = false; if(keyModel)keyModel.visible=false;
                document.getElementById('key-status').innerText="YOK"; document.getElementById('key-status').style.color="red";
                playSound('unlock');
            }
        }

        function animate() {
            if(isGameOver) return; requestAnimationFrame(animate);
            const time = performance.now(); const delta = (time - prevTime) / 1000; prevTime = time;

            // --- KAPI VE ZOMBƒ∞ MANTIƒûI ---
            if(doorState === 1) { 
                // 1. A≈üama: Kapƒ± A√ßƒ±lƒ±yor
                if(doorGroup.rotation.y > -Math.PI/1.6) doorGroup.rotation.y -= 1.5 * delta;
                else {
                    doorState = 2; // A√ßƒ±ldƒ±, bekleme moduna ge√ß
                    zombieSpottedTime = time; 
                    playSound('tension'); 
                }
            } else if (doorState === 2) { 
                // 2. A≈üama: FAIR PLAY (Bekleme Anƒ±)
                // Zombi sadece sana bakarak hafif√ße sallanƒ±r
                if(zombieModel) zombieModel.rotation.y += Math.sin(time*0.005)*0.02;
                
                // S√ºre doldu mu?
                if(time - zombieSpottedTime > SETTINGS.hesitationTime) {
                    doorState = 3; // Saldƒ±r
                    playSound('scream'); 
                }
            } else if (doorState === 3 && zombieModel) { 
                // 3. A≈üama: Kovalamaca
                zombieModel.lookAt(camera.position.x, 0, camera.position.z);
                const dir = new THREE.Vector3().subVectors(camera.position, zombieModel.position).normalize();
                zombieModel.position.add(dir.multiplyScalar(SETTINGS.zombieSpeed * delta));
                
                // Yakalanma
                if(camera.position.distanceTo(zombieModel.position) < 1.3) {
                    isGameOver = true; controls.unlock(); gameOverScreen.style.display = 'flex';
                }
            }

            // --- OYUNCU HAREKETƒ∞ ---
            if(controls.isLocked) {
                const speedMulti = isSprinting ? SETTINGS.runMultiplier : 1.0;
                velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveForward)-Number(moveBackward); direction.x = Number(moveRight)-Number(moveLeft); direction.normalize();
                
                if (moveForward||moveBackward) velocity.z -= direction.z * SETTINGS.walkSpeed * speedMulti * delta;
                if (moveLeft||moveRight) velocity.x -= direction.x * SETTINGS.walkSpeed * speedMulti * delta;
                
                controls.moveRight(-velocity.x*delta*0.02); controls.moveForward(-velocity.z*delta*0.02);

                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(), camera);
                const hits = ray.intersectObjects([doorGroup], true);
                interactionUI.style.display = (hits.length>0 && hits[0].distance<5 && doorState===0 && hasKey) ? 'block' : 'none';
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
