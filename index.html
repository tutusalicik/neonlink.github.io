<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>FINAL BOXING GAME</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; }
        
        /* Nişangah (Tam orta nokta) */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            background: rgba(255, 0, 0, 0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 10;
        }

        /* Can Barları */
        #ui {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        .bar-wrap { width: 40%; background: #333; height: 30px; border: 2px solid #fff; }
        .bar { height: 100%; transition: width 0.2s; }
        #p-hp { width: 100%; background: #00ff00; }
        #e-hp { width: 100%; background: #ff0000; }

        /* Başlama Ekranı */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; z-index: 20;
        }
        button { padding: 15px 40px; font-size: 24px; cursor: pointer; background: #ff0000; color: white; border: none; font-weight: bold; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="crosshair"></div>
    
    <div id="ui">
        <div class="bar-wrap"><div id="p-hp" class="bar"></div></div>
        <div class="bar-wrap"><div id="e-hp" class="bar"></div></div>
    </div>

    <div id="start-screen">
        <h1>BOKS MAÇI HAZIR</h1>
        <p id="loading-msg">Yükleniyor...</p>
        <button id="start-btn" style="display:none">RİNGE ÇIK</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- AYARLAR (Buradan ince ayar yapabilirsin) ---
        const CONFIG = {
            scale: 40.0,         // Ring ve Adamın büyüklüğü (40 kat)
            gloveScale: 0.08,    // Eldivenin boyutu (Kameraya sığması için küçük olmalı)
            cameraHeight: 13.0,  // Oyuncunun boyu (Ring scale'ine uygun olmalı)
            moveSpeed: 25.0,     // Hareket hızı
            punchDist: 15.0      // Vuruş mesafesi
        };

        // --- SAHNE KURULUMU ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.FogExp2(0x111111, 0.01);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, CONFIG.cameraHeight, 20); // Biraz geriden başla

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- IŞIKLAR ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        
        const spot = new THREE.SpotLight(0xffffff, 2);
        spot.position.set(0, 100, 0);
        spot.castShadow = true;
        scene.add(spot);

        // --- OYUN DEĞİŞKENLERİ ---
        let enemy, gloves;
        let mixerEnemy;
        let enemyAction; // Şu anki animasyon
        let animations = {};
        let isPunching = false;
        let playerHp = 100;
        let enemyHp = 100;

        const loader = new GLTFLoader();
        const manager = new THREE.LoadingManager();

        // --- 1. RİNGİ YÜKLE ---
        loader.load('./Boxing Ring.glb', (gltf) => {
            const ring = gltf.scene;
            ring.scale.set(CONFIG.scale, CONFIG.scale, CONFIG.scale);
            ring.position.set(0, -CONFIG.scale * 0.1, 0); // Biraz aşağı al
            scene.add(ring);
        });

        // --- 2. DÜŞMANI YÜKLE ---
        loader.load('./Male Fighter.glb', (gltf) => {
            enemy = gltf.scene;
            enemy.scale.set(CONFIG.scale, CONFIG.scale, CONFIG.scale);
            enemy.position.set(0, 0, -30); // Karşı köşeye koy
            
            // Animasyonları kaydet
            mixerEnemy = new THREE.AnimationMixer(enemy);
            gltf.animations.forEach(clip => {
                animations[clip.name] = mixerEnemy.clipAction(clip);
            });
            
            // İlk duruş (Idle)
            // Eğer Idle animasyonu varsa onu oynat, yoksa ilkini oynat
            const idleAnim = animations['Idle'] || animations['idle'] || mixerEnemy.clipAction(gltf.animations[0]);
            if(idleAnim) {
                enemyAction = idleAnim;
                idleAnim.play();
            }

            scene.add(enemy);
            checkLoad();
        });

        // --- 3. ELDİVENLERİ YÜKLE (KAMERAYA BAĞLA!) ---
        loader.load('./Boxing Gloves.glb', (gltf) => {
            gloves = gltf.scene;
            // Eldivenler kameranın içinde olduğu için "World Scale"den etkilenmez.
            // O yüzden 40 kat büyütmüyoruz, normal boyutta (0.1 civarı) bırakıyoruz.
            gloves.scale.set(CONFIG.gloveScale, CONFIG.gloveScale, CONFIG.gloveScale);
            
            // POZİSYON ÇOK ÖNEMLİ: Kameranın (0,0,0) noktasına göre ayarla
            // x: sağ/sol, y: yukarı/aşağı, z: ileri/geri
            gloves.position.set(0.4, -0.5, -1.0); 
            gloves.rotation.set(0, Math.PI, 0); // Bize dönük

            camera.add(gloves); // Kameranın çocuğu yap (FPS Görünümü)
            scene.add(camera);  // Kamerayı sahneye ekle
            checkLoad();
        });

        let loadedItems = 0;
        function checkLoad() {
            loadedItems++;
            if(loadedItems >= 2) { // Enemy ve Gloves önemli
                document.getElementById('loading-msg').style.display = 'none';
                document.getElementById('start-btn').style.display = 'block';
            }
        }

        // --- KONTROLLER ---
        const controls = new PointerLockControls(camera, document.body);
        const keys = { w: false, s: false, a: false, d: false };

        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            controls.lock();
        });

        document.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
        
        document.addEventListener('mousedown', () => {
            if(controls.isLocked) punch();
        });

        // --- VURUŞ VE AI SİSTEMİ ---
        function punch() {
            if(isPunching || !gloves) return;
            isPunching = true;

            // 1. Görsel Efekt (Eldiven ileri gider)
            const originalZ = -1.0;
            const punchZ = -2.5; // Daha ileri gitsin
            let speed = 0.2;
            
            const interval = setInterval(() => {
                // İleri git
                if(speed > 0 && gloves.position.z > punchZ) {
                    gloves.position.z -= speed;
                } 
                // Geri gel
                else if (gloves.position.z < originalZ) {
                    speed = -0.2; // Yönü ters çevir
                    gloves.position.z -= speed;
                } 
                // Dur
                else {
                    gloves.position.z = originalZ;
                    isPunching = false;
                    clearInterval(interval);
                }
            }, 16);

            // 2. Hasar Kontrolü
            if(enemy) {
                const dist = camera.position.distanceTo(enemy.position);
                // Düşman önümüzde mi?
                const dir = new THREE.Vector3();
                camera.getWorldDirection(dir);
                const enemyDir = enemy.position.clone().sub(camera.position).normalize();
                const angle = dir.angleTo(enemyDir);

                // Mesafe ve Açı uygunsa vur
                if(dist < CONFIG.punchDist && angle < 0.8) {
                    enemyHp -= 10;
                    document.getElementById('e-hp').style.width = enemyHp + '%';
                    
                    // Geri tepme efekti (Basit)
                    enemy.position.z -= 2;

                    // Ölüm kontrolü
                    if(enemyHp <= 0) {
                        enemy.rotation.x = -Math.PI / 2; // Yere yat
                        enemy = null; // AI dursun
                        alert("KAZANDIN!");
                        location.reload();
                    }
                }
            }
        }

        // --- YAPAY ZEKA ---
        function updateAI(dt) {
            if(!enemy || enemyHp <= 0) return;

            const dist = camera.position.distanceTo(enemy.position);
            
            // Yüzünü bize dönsün (Sadece Y ekseninde)
            enemy.lookAt(camera.position.x, enemy.position.y, camera.position.z);

            // Takip Et
            if(dist > 10) { // Çok yakın değilse yaklaşsın
                const speed = 15.0 * dt; // Hızlı gelsin
                enemy.translateZ(speed); // Modelin "önüne" doğru git
            } 
            // Saldır
            else {
                if(Math.random() < 0.05) { // %5 şansla vur
                    playerHp -= 5;
                    document.getElementById('p-hp').style.width = playerHp + '%';
                    
                    // Ekran sarsılsın
                    camera.position.y -= 0.5;
                    setTimeout(() => camera.position.y += 0.5, 100);

                    if(playerHp <= 0) {
                        controls.unlock();
                        alert("NAKAVT! KAYBETTİN.");
                        location.reload();
                    }
                }
            }
        }

        // --- OYUN DÖNGÜSÜ ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // Oyuncu Hareketi
            if(controls.isLocked) {
                const speed = CONFIG.moveSpeed * dt;
                if(keys.w) controls.moveForward(speed);
                if(keys.s) controls.moveForward(-speed);
                if(keys.a) controls.moveRight(-speed);
                if(keys.d) controls.moveRight(speed);
            }

            // Düşman ve Animasyonlar
            if(mixerEnemy) mixerEnemy.update(dt);
            updateAI(dt);

            renderer.render(scene, camera);
        }

        // Yeniden boyutlandırma
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
