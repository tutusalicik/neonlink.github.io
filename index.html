<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 WEB: TITAN v5</title>
    <style>
        :root { --primary: #eebc51; --dark: #0d0e10; --red: #ff3333; }
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; user-select: none; }

        /* LOADING */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); }
        .bar { width: 300px; height: 4px; background: #333; margin-top: 10px; }
        .fill { width: 0%; height: 100%; background: var(--primary); transition: 0.2s; }

        /* MENU */
        #menu { position: absolute; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        h1 { color: #fff; font-size: 70px; margin: 0; letter-spacing: -3px; font-style: italic; }
        .code-box { background: #222; padding: 10px 20px; border: 1px solid var(--primary); color: var(--primary); font-family: monospace; font-size: 24px; margin: 20px; letter-spacing: 2px; }
        button { padding: 15px 40px; margin: 10px; font-size: 18px; font-weight: bold; background: transparent; border: 2px solid #fff; color: #fff; cursor: pointer; transition: 0.2s; }
        button:hover { background: #fff; color: #000; transform: scale(1.05); }

        /* HUD */
        #hud { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; display: none; }
        #crosshair { position: absolute; top:50%; left:50%; width:4px; height:4px; background:#0f0; transform:translate(-50%, -50%); box-shadow: 0 0 2px #000; }
        #health { position: absolute; bottom: 30px; left: 30px; font-size: 40px; color: white; font-weight: 900; text-shadow: 2px 2px 0 #000; }
        #ammo { position: absolute; bottom: 30px; right: 30px; font-size: 40px; color: var(--primary); font-weight: 900; text-shadow: 2px 2px 0 #000; }
        
        /* DAMAGE EFFECT */
        #damage-overlay { position: absolute; top:0; left:0; width:100%; height:100%; box-shadow: inset 0 0 0 0 rgba(255,0,0,0); pointer-events: none; transition: 0.2s; z-index: 50; }
    </style>
</head>
<body>

    <div id="loading">
        <h2>SYSTEM INITIALIZING...</h2>
        <div class="bar"><div class="fill" id="l-fill"></div></div>
        <div id="l-text" style="margin-top:5px; font-size:12px; color:#666;">Assets Loading...</div>
    </div>

    <div id="menu">
        <h1>CS:WEB <span style="color:var(--primary)">v5</span></h1>
        
        <div id="host-panel" style="display:none; text-align:center;">
            <p style="color:#aaa;">ARKADAŞINA BU KODU VER:</p>
            <div class="code-box" id="my-code">...</div>
            <p style="color:#0f0; font-size:12px;">BEKLENİYOR...</p>
        </div>

        <div id="main-buttons">
            <button onclick="Game.host()">ODA KUR (HOST)</button>
            <button onclick="Game.joinMenu()">BAĞLAN (JOIN)</button>
            <button onclick="Game.practice()">BOTLARLA OYNA</button>
        </div>

        <div id="join-panel" style="display:none;">
            <input type="text" id="join-code" placeholder="KODU GİR (Örn: CS-A1-X)" style="padding:15px; width:250px; text-align:center; font-size:16px;">
            <br>
            <button onclick="Game.connect()">GİRİŞ YAP</button>
            <button onclick="location.reload()" style="border-color:#555; font-size:12px;">GERİ</button>
        </div>
    </div>

    <div id="hud">
        <div id="damage-overlay"></div>
        <div id="crosshair"></div>
        <div id="health">100</div>
        <div id="ammo">20 <span style="font-size:16px; color:#aaa;">/ 90</span></div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- AYARLAR ---
        const Settings = {
            speed: 5.0, // Oyuncu hızı (Düşürüldü)
            npcScale: 0.015, // NPC çok büyükse bunu küçült (0.01 gibi), küçükse büyüt (1.0)
            weaponScale: 0.1, // Silah boyutu
            weaponPos: { x: 0.2, y: -0.3, z: -0.4 } // Silah konumu
        };

        const Assets = {};
        let scene, camera, renderer, controls, clock;
        let player = { hp: 100, velocity: new THREE.Vector3(), canJump: false };
        let weapon = { mesh: null, ammo: 20, recoil: 0 };
        let bots = [];
        let network = { peer: null, conn: null };

        // --- BAŞLANGIÇ ---
        init();

        async function init() {
            // Sahne
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Açık mavi gökyüzü (Artık karanlık değil)
            scene.fog = new THREE.Fog(0x87CEEB, 10, 60);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Işıklandırma (GÜÇLENDİRİLDİ)
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2); // Her yeri aydınlatır
            scene.add(hemiLight);
            
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5); // Güneş
            dirLight.position.set(50, 100, 50);
            dirLight.castShadow = true;
            scene.add(dirLight);

            controls = new PointerLockControls(camera, document.body);

            // Yükleme
            await loadAssets();
        }

        async function loadAssets() {
            const loader = new GLTFLoader();
            const files = { map: './map.glb', guy: './guy.glb', pistol: './Pistol.glb' };
            const keys = Object.keys(files);
            
            for(let i=0; i<keys.length; i++) {
                const key = keys[i];
                try {
                    const gltf = await loader.loadAsync(files[key]);
                    Assets[key] = gltf.scene;
                } catch(e) {
                    console.error("Yükleme hatası:", key);
                    Assets[key] = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:0xff0000}));
                }
                document.getElementById('l-fill').style.width = ((i+1)/keys.length*100) + '%';
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        }

        // --- OYUN MANTIĞI ---
        window.Game = {
            host: () => {
                const randomCode = "CS-" + Math.floor(1000 + Math.random() * 9000) + "-X"; // Örn: CS-4821-X
                network.peer = new Peer(randomCode);
                network.peer.on('open', (id) => {
                    document.getElementById('host-panel').style.display = 'block';
                    document.getElementById('main-buttons').style.display = 'none';
                    document.getElementById('my-code').innerText = id;
                });
                network.peer.on('connection', (conn) => {
                    network.conn = conn;
                    startGame();
                });
            },
            joinMenu: () => {
                document.getElementById('main-buttons').style.display = 'none';
                document.getElementById('join-panel').style.display = 'block';
            },
            connect: () => {
                const code = document.getElementById('join-code').value;
                network.peer = new Peer();
                network.peer.on('open', () => {
                    const conn = network.peer.connect(code);
                    conn.on('open', () => {
                        network.conn = conn;
                        startGame();
                    });
                });
            },
            practice: () => {
                startGame(true); // Bot modunu aç
            }
        };

        function startGame(isPractice = false) {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            controls.lock();

            // Harita Ekle
            const map = Assets.map;
            map.traverse(c => { if(c.isMesh) { c.castShadow=true; c.receiveShadow=true; } });
            scene.add(map);

            // Silah Ekle
            const pistol = Assets.pistol;
            pistol.scale.set(Settings.weaponScale, Settings.weaponScale, Settings.weaponScale); 
            pistol.rotation.y = Math.PI; // Silah ters duruyorsa bunu sil veya aç
            pistol.position.set(Settings.weaponPos.x, Settings.weaponPos.y, Settings.weaponPos.z);
            
            weapon.mesh = pistol;
            camera.add(pistol);
            scene.add(camera);

            // Bot Ekle (Eğer practice ise)
            if(isPractice) {
                spawnBot(new THREE.Vector3(10, 0, 10));
                spawnBot(new THREE.Vector3(-10, 0, -10));
            }

            clock = new THREE.Clock();
            animate();
        }

        function spawnBot(pos) {
            const botMesh = Assets.guy.clone();
            // NPC BOYUT AYARI
            botMesh.scale.set(Settings.npcScale, Settings.npcScale, Settings.npcScale); 
            
            botMesh.position.copy(pos);
            scene.add(botMesh);
            
            // Bot verisi
            bots.push({
                mesh: botMesh,
                hp: 100,
                lastShot: 0
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = Math.min(clock.getDelta(), 0.05);

            // 1. OYUNCU HAREKETİ (Yavaşlatıldı)
            player.velocity.x -= player.velocity.x * 10.0 * dt;
            player.velocity.z -= player.velocity.z * 10.0 * dt;
            // player.velocity.y -= 9.8 * dt; // Yer çekimi (Map collider olmadığı için kapalı)

            const dir = new THREE.Vector3();
            // Basit WASD kontrolü (PointerLockControls içindeki vektörlerle)
            // Not: Input dinleyicilerini aşağıda tanımladım
            if (input.w) player.velocity.z -= Settings.speed * 100 * dt; // Hız katsayısı düşürüldü
            if (input.s) player.velocity.z += Settings.speed * 100 * dt;
            if (input.a) player.velocity.x -= Settings.speed * 100 * dt;
            if (input.d) player.velocity.x += Settings.speed * 100 * dt;

            controls.moveRight(player.velocity.x * dt);
            controls.moveForward(-player.velocity.z * dt); // Ters mantık

            // 2. SİLAH EFEKTLERİ
            if(weapon.mesh) {
                // Nefes alma (Bobbing)
                const time = Date.now() * 0.005;
                weapon.mesh.position.y = Settings.weaponPos.y + Math.sin(time) * 0.002;
                
                // Recoil dönüşü
                weapon.recoil = Math.max(0, weapon.recoil - dt * 2);
                weapon.mesh.rotation.x = weapon.recoil; 
            }

            // 3. BOT YAPAY ZEKASI (AI)
            bots.forEach(bot => {
                if(bot.hp <= 0) return;

                // Oyuncuya bak
                bot.mesh.lookAt(camera.position.x, bot.mesh.position.y, camera.position.z);

                // Mesafe ölç
                const dist = bot.mesh.position.distanceTo(camera.position);
                
                // Yakınsa ateş et
                if(dist < 20 && Date.now() - bot.lastShot > 1000) { // 1 saniyede bir ateş
                    bot.lastShot = Date.now();
                    player.hp -= 10;
                    updateHealth();
                    
                    // Kan efekti
                    const overlay = document.getElementById('damage-overlay');
                    overlay.style.boxShadow = "inset 0 0 50px 20px rgba(255,0,0,0.5)";
                    setTimeout(() => overlay.style.boxShadow = "none", 200);

                    if(player.hp <= 0) {
                        alert("ÖLDÜN!");
                        location.reload();
                    }
                }
            });

            renderer.render(scene, camera);
        }

        // --- GİRDİLER ---
        const input = { w:false, s:false, a:false, d:false };
        window.addEventListener('keydown', (e) => {
            switch(e.key.toLowerCase()) {
                case 'w': input.w = true; break;
                case 's': input.s = true; break;
                case 'a': input.a = true; break;
                case 'd': input.d = true; break;
            }
        });
        window.addEventListener('keyup', (e) => {
            switch(e.key.toLowerCase()) {
                case 'w': input.w = false; break;
                case 's': input.s = false; break;
                case 'a': input.a = false; break;
                case 'd': input.d = false; break;
            }
        });
        window.addEventListener('mousedown', () => {
            if(controls.isLocked) {
                // Ateş etme
                weapon.recoil += 0.2;
                weapon.mesh.position.z += 0.05; // Geri tepme pozisyon
                setTimeout(() => weapon.mesh.position.z -= 0.05, 50);
                
                // Raycast Vuruşu
                const ray = new THREE.Raycaster();
                ray.setFromCamera(new THREE.Vector2(0,0), camera);
                const botMeshes = bots.map(b => b.mesh);
                const hits = ray.intersectObjects(botMeshes, true);
                
                if(hits.length > 0) {
                    // Botu bul ve vur
                    // Basitçe ilk botu öldür (Detaylı hiyerarşi taraması gerekir normalde)
                    const hitObj = hits[0].object;
                    // Efekt: Botu kırmızı yap
                    hitObj.material = new THREE.MeshBasicMaterial({color:0xff0000});
                    setTimeout(() => {
                        scene.remove(hitObj.parent || hitObj); // Sahneden sil
                    }, 100);
                }
            }
        });

        function updateHealth() {
            document.getElementById('health').innerText = player.hp;
        }

    </script>
</body>
</html>
