<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>KaranlÄ±k Koridor: Nightmare Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        /* ArayÃ¼z */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }

        #inventory { 
            padding: 20px; 
            color: #d4af37; 
            font-size: 22px; 
            text-shadow: 2px 2px 4px #000; 
            font-weight: bold;
            opacity: 0.8;
        }

        #interaction {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 16px; display: none; text-align: center;
            text-shadow: 0 0 10px #ff0000; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 4px; border: 1px solid #333;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: rgba(255, 255, 255, 0.4); border-radius: 50%; transform: translate(-50%, -50%); z-index: 5;
            box-shadow: 0 0 4px white;
        }

        /* BaÅŸlangÄ±Ã§ ve BitiÅŸ EkranlarÄ± */
        #blocker {
            position: absolute; width: 100%; height: 100%; background: #000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 999; pointer-events: all; color: #ccc; transition: opacity 2s;
        }
        
        #instructions { font-size: 24px; cursor: pointer; text-align: center; line-height: 1.8; }
        #instructions span { font-size: 40px; color: #ff3333; font-weight: bold; letter-spacing: 5px; }
        .sub-text { font-size: 14px; color: #666; margin-top: 20px;}

        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #500 0%, #000 90%); color: #ff0000; z-index: 1000;
            justify-content: center; align-items: center; flex-direction: column;
            font-size: 80px; font-weight: bold; text-shadow: 0 0 30px black; letter-spacing: 10px;
        }
        
        /* Stamina BarÄ± (KoÅŸma) */
        #stamina-container {
            position: absolute; bottom: 20px; left: 20px; width: 200px; height: 10px; background: #333; border: 1px solid #555;
        }
        #stamina-bar { width: 100%; height: 100%; background: #fff; transition: width 0.1s; }

    </style>
</head>
<body>

    <div id="game-over">Ã–LDÃœN</div>
    
    <div id="blocker">
        <div id="instructions">
            <span>BAÅLA</span><br/>
            (KulaklÄ±k Tavsiye Edilir)<br/><br/>
            Hareket: W, A, S, D<br/>
            KoÅŸ: SHIFT<br/>
            EtkileÅŸim: E<br/>
            <div class="sub-text">TÄ±klayarak kilitle</div>
        </div>
    </div>

    <div id="crosshair"></div>

    <div id="ui-layer">
        <div id="inventory">ANAHTAR: <span id="key-status">VAR</span> ğŸ—ï¸</div>
        <div id="interaction">[E] Kilidi AÃ§</div>
        <div id="stamina-container"><div id="stamina-bar"></div></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SES MOTORU (Web Audio API) ---
        // Basit sesleri kodla Ã¼retiyoruz (Dosya boyutu ÅŸiÅŸmesin diye)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'unlock') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } 
            else if (type === 'creak') {
                // GÄ±cÄ±rtÄ± benzeri ses (Testere diÅŸi dalga)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 1.5);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
                osc.start(); osc.stop(audioCtx.currentTime + 1.5);
            }
            else if (type === 'jumpscare') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
                osc.start(); osc.stop(audioCtx.currentTime + 1);
            }
        }

        // --- OYUN DEÄÄ°ÅKENLERÄ° ---
        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, isSprinting = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        
        // Modeller
        let doorGroup = new THREE.Group(); // KapÄ±yÄ± menteÅŸeden dÃ¶ndÃ¼rmek iÃ§in grup
        let doorMesh = null;
        let zombieModel = null;
        let keyModel = null;

        // Oyun MantÄ±ÄŸÄ±
        let hasKey = true;
        let doorState = 0; // 0: KapalÄ±, 1: Animasyon (Anahtar), 2: AÃ§Ä±lÄ±yor, 3: AÃ§Ä±k
        let chaseMode = false;
        let isGameOver = false;
        let stamina = 100;

        // Animasyon DeÄŸiÅŸkenleri
        let keyAnimStartTime = 0;
        let doorOpenStartTime = 0;
        
        // Kafa Sallama (Head Bob)
        let headBobTimer = 0;

        // HTML Elementleri
        const interactionUI = document.getElementById('interaction');
        const blocker = document.getElementById('blocker');
        const instructions = document.getElementById('instructions');
        const gameOverScreen = document.getElementById('game-over');
        const staminaBar = document.getElementById('stamina-bar');
        const keyStatus = document.getElementById('key-status');

        init();
        animate();

        function init() {
            // 1. Sahne
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.FogExp2(0x000000, 0.25); // Ã‡ok yoÄŸun sis

            // 2. Kamera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.y = 1.7; // GÃ¶z hizasÄ±

            // 3. IÅŸÄ±klar (GeliÅŸmiÅŸ El Feneri)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.02); // Neredeyse zifiri karanlÄ±k
            scene.add(ambientLight);

            // El Feneri
            const flashLight = new THREE.SpotLight(0xffffee, 2, 25, Math.PI/7, 0.5, 2);
            flashLight.position.set(0.2, -0.2, 0); // SaÄŸ elden Ã§Ä±kÄ±yormuÅŸ gibi
            flashLight.castShadow = true; // GÃ–LGE AÃ‡IK
            flashLight.shadow.mapSize.width = 1024;
            flashLight.shadow.mapSize.height = 1024;
            camera.add(flashLight);
            camera.add(flashLight.target);
            flashLight.target.position.set(0, 0, -3);
            scene.add(camera);

            // 4. Kontroller
            controls = new PointerLockControls(camera, document.body);

            instructions.addEventListener('click', () => controls.lock());
            controls.addEventListener('lock', () => {
                instructions.style.display = 'none';
                blocker.style.display = 'none';
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
            controls.addEventListener('unlock', () => {
                if(!isGameOver) {
                    blocker.style.display = 'flex';
                    instructions.style.display = '';
                }
            });

            // 5. Ortam (Koridor)
            // Zemin
            const textureLoader = new THREE.TextureLoader();
            // Placeholder texture (Normalde dosya yÃ¼klenir ama renk ile idare edelim)
            const floorGeo = new THREE.PlaneGeometry(10, 50);
            const floorMat = new THREE.MeshStandardMaterial({ 
                color: 0x1a1a1a, roughness: 0.9, metalness: 0.1 
            });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true; // Zemin gÃ¶lge alÄ±r
            scene.add(floor);

            // Duvarlar (Basit Geometri)
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x0f0f0f, roughness: 1 });
            const wall1 = new THREE.Mesh(new THREE.BoxGeometry(1, 5, 50), wallMat);
            wall1.position.set(5.5, 2.5, 0);
            wall1.receiveShadow = true;
            scene.add(wall1);
            
            const wall2 = new THREE.Mesh(new THREE.BoxGeometry(1, 5, 50), wallMat);
            wall2.position.set(-5.5, 2.5, 0);
            wall2.receiveShadow = true;
            scene.add(wall2);

            // Tavan
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(10, 50), wallMat);
            ceil.rotation.x = Math.PI / 2;
            ceil.position.y = 5;
            scene.add(ceil);

            // 6. GLB Model YÃ¼kleyici
            const loader = new GLTFLoader();

            // KAPI
            loader.load('./Door.glb', (gltf) => {
                doorMesh = gltf.scene;
                doorMesh.traverse(c => { if(c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });
                
                // KapÄ±yÄ± pivot noktasÄ±na (MenteÅŸe) gÃ¶re ayarlamak iÃ§in grup iÃ§ine alÄ±yoruz
                // Genelde kapÄ± modellerinin merkezi ortadadÄ±r. MenteÅŸeyi sola almak iÃ§in kapÄ±yÄ± saÄŸa kaydÄ±rÄ±p grubu sola kaydÄ±rÄ±rÄ±z.
                doorMesh.position.set(0.5, 0, 0); // KapÄ±yÄ± grubun iÃ§inde hafif saÄŸa al (tahmini menteÅŸe ayarÄ±)
                
                doorGroup.add(doorMesh);
                doorGroup.position.set(-0.5, 0, -10); // Grubu koridorun sonuna koy
                scene.add(doorGroup);

            }, undefined, (e) => {
                // Fallback (Model yoksa kutu koy)
                const geo = new THREE.BoxGeometry(2, 3.5, 0.2);
                const mat = new THREE.MeshStandardMaterial({color: 0x332211});
                doorMesh = new THREE.Mesh(geo, mat);
                doorMesh.position.set(1, 1.75, 0); 
                doorGroup.add(doorMesh);
                doorGroup.position.set(-1, 0, -10);
                scene.add(doorGroup);
            });

            // ZOMBÄ°
            loader.load('./Zombie.glb', (gltf) => {
                zombieModel = gltf.scene;
                zombieModel.traverse(c => { if(c.isMesh) { c.castShadow = true; } });
                
                // Zombiyi kapÄ±nÄ±n tam arkasÄ±na koy, havada durmasÄ±n diye Y=0
                zombieModel.position.set(0, 0, -12); 
                zombieModel.rotation.y = Math.PI; // Bize baksÄ±n
                scene.add(zombieModel);
            }, undefined, () => {
                // Fallback Zombi
                const geo = new THREE.CapsuleGeometry(0.5, 1.8, 4, 8);
                const mat = new THREE.MeshStandardMaterial({color: 0x225522});
                zombieModel = new THREE.Mesh(geo, mat);
                zombieModel.position.set(0, 1, -12);
                scene.add(zombieModel);
            });

            // ANAHTAR (FPS GÃ¶rÃ¼nÃ¼mÃ¼)
            loader.load('./Skeleton Key.glb', (gltf) => {
                keyModel = gltf.scene;
                keyModel.scale.set(0.5, 0.5, 0.5); // Boyut ayarÄ±
                // BaÅŸlangÄ±Ã§ konumu (EkranÄ±n saÄŸ altÄ±)
                keyModel.position.set(0.4, -0.4, -0.6); 
                keyModel.rotation.set(0, 1.5, 0);
                camera.add(keyModel); // Kameraya ekle
            }, undefined, () => console.log("Anahtar yok"));

            // 7. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; // GÃ¶lge motoru aktif
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyD': moveRight = true; break;
                case 'ShiftLeft': isSprinting = true; break;
                case 'KeyE': triggerDoorSequence(); break;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyD': moveRight = false; break;
                case 'ShiftLeft': isSprinting = false; break;
            }
        }

        // --- GELÄ°ÅMÄ°Å ETKÄ°LEÅÄ°M MEKANÄ°ÄÄ° ---
        function triggerDoorSequence() {
            // EÄŸer kapÄ± zaten aÃ§Ä±lÄ±yorsa veya anahtar yoksa iÅŸlem yapma
            if (doorState !== 0 || !hasKey) return;
            
            // Mesafeyi kontrol et
            const dist = camera.position.distanceTo(doorGroup.position);
            if (dist > 4) return;

            // 1. Durum: Anahtar Animasyonu BaÅŸlÄ±yor
            doorState = 1; // Animasyon modu
            keyAnimStartTime = performance.now();
            interactionUI.style.display = 'none'; // YazÄ±yÄ± gizle
            playSound('unlock'); // Kilit sesi Ã§al
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isGameOver) return;

            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            
            // --- OYUN MANTIÄI ---

            // 1. KapÄ± AÃ§ma Animasyon Zinciri
            if (doorState === 1 && keyModel) {
                // AnahtarÄ± ortaya taÅŸÄ± ve dÃ¶ndÃ¼r
                const elapsed = (time - keyAnimStartTime) / 1000;
                
                // Lerp (YumuÅŸak geÃ§iÅŸ) ile anahtarÄ± ortaya Ã§ek
                keyModel.position.lerp(new THREE.Vector3(0, -0.1, -0.5), 0.1);
                keyModel.rotation.z += 5 * delta; // AnahtarÄ± dÃ¶ndÃ¼r (Kilit aÃ§ma efekti)

                // 1 saniye sonra kapÄ±yÄ± aÃ§maya baÅŸla
                if (elapsed > 1.0) {
                    doorState = 2; // KapÄ± aÃ§Ä±lma modu
                    doorOpenStartTime = time;
                    keyModel.visible = false; // AnahtarÄ± yok et
                    hasKey = false;
                    keyStatus.innerText = "YOK";
                    keyStatus.style.color = "red";
                    playSound('creak'); // KapÄ± gÄ±cÄ±rtÄ±sÄ±
                    
                    // ZOMBÄ°YÄ° TETÄ°KLE!
                    setTimeout(() => {
                        chaseMode = true;
                        playSound('jumpscare');
                    }, 500);
                }
            }

            // 2. KapÄ± Fiziksel Hareketi
            if (doorState === 2 || doorState === 3) {
                // KapÄ± grubunu Y ekseninde 90 derece dÃ¶ndÃ¼r (Radyan: PI/2)
                // Smooth aÃ§Ä±lÄ±ÅŸ iÃ§in
                if (doorGroup.rotation.y > -Math.PI / 2) {
                    doorGroup.rotation.y -= 2 * delta; // AÃ§Ä±lma hÄ±zÄ±
                } else {
                    doorState = 3; // Tamamen aÃ§Ä±k
                }
            }

            // 3. Zombi Yapay ZekasÄ±
            if (chaseMode && zombieModel) {
                // Zombi bize baksÄ±n
                zombieModel.lookAt(camera.position.x, 0, camera.position.z);
                
                // Bize doÄŸru koÅŸsun
                const speed = 7.5; // Zombi hÄ±zÄ±
                const zDir = new THREE.Vector3();
                zDir.subVectors(camera.position, zombieModel.position).normalize();
                
                // Sadece Y ekseni 0 kalsÄ±n (Zombi uÃ§masÄ±n)
                zombieModel.position.x += zDir.x * speed * delta;
                zombieModel.position.z += zDir.z * speed * delta;
                // zombieModel.position.y = 0; // Zaten baÅŸlangÄ±Ã§ta ayarladÄ±k, gerekirse burayÄ± aÃ§.

                // Yakalanma
                if (camera.position.distanceTo(zombieModel.position) < 1.2) {
                    isGameOver = true;
                    controls.unlock();
                    gameOverScreen.style.display = 'flex';
                }
            }

            // --- OYUNCU HAREKETLERÄ° ---
            if (controls.isLocked) {
                // KoÅŸma MantÄ±ÄŸÄ±
                let activeSpeed = 40.0;
                if (isSprinting && stamina > 0) {
                    activeSpeed = 80.0; // KoÅŸma hÄ±zÄ±
                    stamina -= 50 * delta;
                } else {
                    if (stamina < 100) stamina += 20 * delta;
                }
                staminaBar.style.width = stamina + '%';
                if(stamina < 20) staminaBar.style.backgroundColor = 'red';
                else staminaBar.style.backgroundColor = 'white';

                // Fizik
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * activeSpeed * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * activeSpeed * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                // Head Bob (Kafa SallanmasÄ±)
                if (moveForward || moveBackward || moveLeft || moveRight) {
                    const bobSpeed = isSprinting ? 20 : 12;
                    const bobAmount = isSprinting ? 0.1 : 0.05;
                    headBobTimer += delta * bobSpeed;
                    camera.position.y = 1.7 + Math.sin(headBobTimer) * bobAmount;
                } else {
                    // Durunca kafayÄ± yavaÅŸÃ§a merkeze getir
                    camera.position.y = THREE.MathUtils.lerp(camera.position.y, 1.7, 0.1);
                }
            }

            // Raycaster (BakÄ±ÅŸ kontrolÃ¼)
            // KapÄ±ya bakÄ±yor muyuz?
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const intersects = raycaster.intersectObjects([doorGroup], true); // true = alt objeleri de tara
            
            if (intersects.length > 0 && intersects[0].distance < 4 && doorState === 0 && hasKey) {
                interactionUI.style.display = 'block';
            } else {
                interactionUI.style.display = 'none';
            }

            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
