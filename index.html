<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 WEB: GRANDMASTER ENGINE</title>
    <style>
        /* --- CORE VISUALS --- */
        :root { --gold: #ffd700; --dark: #1a1a1a; --danger: #ff2a2a; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }

        /* LOADING OVERLAY */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: var(--gold);
        }
        .load-text { font-size: 24px; letter-spacing: 5px; animation: pulse 1.5s infinite; }
        .progress-box { width: 400px; height: 4px; background: #333; margin-top: 20px; }
        .progress-bar { width: 0%; height: 100%; background: var(--gold); transition: width 0.1s; }
        #debug-log { margin-top: 10px; color: #666; font-family: monospace; font-size: 12px; }

        /* MAIN MENU */
        #menu-layer { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .logo { font-size: 80px; color: #fff; font-weight: 900; font-style: italic; text-shadow: 0 0 20px var(--gold); margin-bottom: 20px; }
        .menu-btn { 
            padding: 20px 60px; font-size: 20px; background: transparent; color: #fff; 
            border: 2px solid var(--gold); cursor: pointer; margin: 10px; font-weight: bold; 
            text-transform: uppercase; transition: 0.3s; position: relative; overflow: hidden;
        }
        .menu-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 30px rgba(255, 215, 0, 0.4); }

        /* GAME HUD */
        #hud-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; display: none; }
        #crosshair { 
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; 
            background: #0f0; transform: translate(-50%, -50%); border-radius: 50%; 
            box-shadow: 0 0 4px #000;
        }
        .ch-line { position: absolute; background: rgba(0, 255, 0, 0.6); }
        .ch-h { width: 24px; height: 2px; top: 1px; left: -10px; }
        .ch-v { width: 2px; height: 24px; top: -10px; left: 1px; }

        #health-display { position: absolute; bottom: 40px; left: 40px; display: flex; align-items: flex-end; }
        .hp-val { font-size: 60px; color: #fff; font-weight: 900; line-height: 1; }
        .hp-icon { font-size: 20px; color: var(--danger); margin-right: 10px; font-weight: bold; }
        
        #ammo-display { position: absolute; bottom: 40px; right: 40px; text-align: right; }
        .ammo-val { font-size: 60px; color: var(--gold); font-weight: 900; line-height: 1; }
        .reserve-val { font-size: 20px; color: #888; font-weight: bold; }

        /* DAMAGE FEEDBACK */
        #damage-flash { position: absolute; top:0; left:0; width:100%; height:100%; background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="load-text">TITAN ENGINE v6.0</div>
        <div class="progress-box"><div class="progress-bar" id="p-bar"></div></div>
        <div id="debug-log">Initializing Core Systems...</div>
    </div>

    <div id="menu-layer">
        <div class="logo">CS:WEB</div>
        <div style="display: flex; gap: 20px;">
            <button class="menu-btn" onclick="Game.hostGame()">ODA KUR (HOST)</button>
            <button class="menu-btn" onclick="UI.showJoin()">BAĞLAN (JOIN)</button>
        </div>
        <div id="join-input-area" style="display:none; margin-top:20px;">
            <input type="text" id="room-code" placeholder="ODA KODU (örn: CS-123)" style="padding:15px; width:300px; text-align:center; font-size:18px;">
            <button class="menu-btn" style="padding:15px 30px;" onclick="Game.joinGame()">GİR</button>
        </div>
        <div id="room-info" style="color:var(--gold); margin-top:20px; font-size:24px; font-family:monospace; display:none;"></div>
    </div>

    <div id="hud-layer">
        <div id="damage-flash"></div>
        <div id="crosshair">
            <div class="ch-line ch-h"></div>
            <div class="ch-line ch-v"></div>
        </div>
        <div id="health-display">
            <div class="hp-icon">✚</div>
            <div class="hp-val" id="ui-hp">100</div>
        </div>
        <div id="ammo-display">
            <div class="ammo-val" id="ui-ammo">30</div>
            <div class="reserve-val">/ 90</div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        /* * =================================================================
         * GLOBAL CONFIGURATION (BURADAN AYARLARI YAPABİLİRSİN)
         * =================================================================
         */
        const Config = {
            playerSpeed: 6.0,      // Oyuncu koşma hızı (Çok hızlıysa düşür)
            mouseSensitivity: 0.002,
            
            // SİLAH AYARLARI (Görünmüyorsa burayla oyna)
            weapon: {
                scale: 0.15,        // Silah boyutu (Büyütmek için 0.5 yap)
                position: { x: 0.25, y: -0.35, z: -0.6 }, // Sağ/Sol, Yukarı/Aşağı, İleri/Geri
                rotationOffset: { x: 0, y: Math.PI, z: 0 } // Silah tersse y: 0 yap
            },

            // ADAM (BOT) AYARLARI
            npc: {
                scale: 1.0,         // Adam çok büyükse 0.01 yap, küçükse 1.5 yap
                positionFix: -1.6   // Yere basma ayarı
            }
        };

        /* ================================================================= */

        // CORE SYSTEMS
        const Sys = {
            scene: null, camera: null, renderer: null, controls: null,
            clock: new THREE.Clock(),
            assets: {},
            sounds: {},
            entities: [], // Bots & Players
            mixer: null, // Animation mixer
        };

        // GAME STATE
        const State = {
            hp: 100,
            ammo: 30,
            isDead: false,
            isPlaying: false
        };

        // INPUT STATE
        const Input = { w: false, a: false, s: false, d: false };

        /* * 1. AUDIO MANAGER (SES SİSTEMİ)
         */
        const AudioSys = {
            init: () => {
                Sys.sounds['shoot'] = new Audio('shoot.mp3');
                Sys.sounds['headshot'] = new Audio('headshot.mp3');
                Sys.sounds['shoot'].volume = 0.4;
                Sys.sounds['headshot'].volume = 0.8;
            },
            play: (name) => {
                if(Sys.sounds[name]) {
                    Sys.sounds[name].currentTime = 0;
                    Sys.sounds[name].play().catch(e => console.warn("Audio play blocked", e));
                }
            }
        };

        /* * 2. INITIALIZATION & LOADING
         */
        init();

        async function init() {
            // Scene Setup
            Sys.scene = new THREE.Scene();
            Sys.scene.background = new THREE.Color(0x87CEEB); // Sky Blue
            Sys.scene.fog = new THREE.Fog(0x87CEEB, 0, 50);

            Sys.camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 1000); // 0.01 near clip (Silah kesilmesin diye)
            Sys.camera.position.y = 1.7;

            Sys.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            Sys.renderer.setSize(window.innerWidth, window.innerHeight);
            Sys.renderer.shadowMap.enabled = true;
            document.body.appendChild(Sys.renderer.domElement);

            // Lighting (Kritik: Adamın görünmesi için)
            const ambLight = new THREE.AmbientLight(0xffffff, 0.7); // Ortam ışığı (karanlığı önler)
            Sys.scene.add(ambLight);
            
            const sun = new THREE.DirectionalLight(0xffffff, 1.5); // Güneş
            sun.position.set(20, 50, 20);
            sun.castShadow = true;
            Sys.scene.add(sun);

            Sys.controls = new PointerLockControls(Sys.camera, document.body);
            
            // Events
            setupInputs();
            window.addEventListener('resize', onResize);

            // Audio Init
            AudioSys.init();

            // Load Assets
            await loadContent();
        }

        async function loadContent() {
            const loader = new GLTFLoader();
            const files = {
                'map': 'map.glb',
                'guy': 'guy.glb',     // Küçük harf
                'pistol': 'Pistol.glb' // Büyük harf
            };

            const keys = Object.keys(files);
            let loaded = 0;

            for (const key of keys) {
                try {
                    document.getElementById('debug-log').innerText = `Loading ${key}...`;
                    const gltf = await loader.loadAsync(files[key]);
                    Sys.assets[key] = gltf.scene;
                    loaded++;
                    document.getElementById('p-bar').style.width = (loaded / keys.length * 100) + '%';
                    console.log(`[OK] ${key} loaded.`);
                } catch (err) {
                    console.error(`[ERR] ${key} failed.`, err);
                    document.getElementById('debug-log').innerText = `Error loading ${key}. Check console.`;
                    // Fail-safe: Create placeholder if missing
                    const box = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({color:0xff0000}));
                    Sys.assets[key] = box;
                }
            }

            // Finish Loading
            document.getElementById('loader').style.display = 'none';
            document.getElementById('menu-layer').style.display = 'flex';
        }

        /* * 3. GAME LOGIC & WORLD BUILDING
         */
        window.Game = {
            hostGame: () => {
                const code = "CS-" + Math.floor(Math.random() * 9000 + 1000);
                startWorld(true);
                // Network (PeerJS) logic would act here as host
                document.getElementById('room-info').innerText = "ODA KODU: " + code;
                document.getElementById('room-info').style.display = "block";
                alert(`Oda kuruldu! Kodun: ${code}`);
            },
            joinGame: () => {
                const code = document.getElementById('room-code').value;
                if(!code) return alert("Kodu yaz!");
                startWorld(false);
            }
        };

        window.UI = {
            showJoin: () => { document.getElementById('join-input-area').style.display = 'block'; }
        };

        function startWorld(isHost) {
            document.getElementById('menu-layer').style.display = 'none';
            document.getElementById('hud-layer').style.display = 'block';
            Sys.controls.lock();
            State.isPlaying = true;

            // 1. ADD MAP
            const map = Sys.assets['map'];
            map.traverse(o => { if(o.isMesh) { o.receiveShadow = true; o.castShadow = true; } });
            map.scale.set(1,1,1);
            Sys.scene.add(map);

            // 2. SETUP WEAPON (VIEWMODEL)
            setupWeapon();

            // 3. SPAWN BOTS
            spawnBot(new THREE.Vector3(5, 0, 10)); // Bot 1
            spawnBot(new THREE.Vector3(-5, 0, 10)); // Bot 2

            // Start Loop
            animate();
        }

        function setupWeapon() {
            const gun = Sys.assets['pistol'];
            // --- SİLAH AYARLARI (CONFİG'DEN ÇEKER) ---
            gun.scale.set(Config.weapon.scale, Config.weapon.scale, Config.weapon.scale);
            gun.position.set(Config.weapon.position.x, Config.weapon.position.y, Config.weapon.position.z);
            gun.rotation.set(Config.weapon.rotationOffset.x, Config.weapon.rotationOffset.y, Config.weapon.rotationOffset.z);
            
            // Silahın gölgelerini kapat (FPS kamerada garip durur)
            gun.traverse(o => { if(o.isMesh) { o.castShadow = false; o.receiveShadow = false; } });

            // Kamera içine grup oluştur (Recoil için)
            Sys.gunGroup = new THREE.Group();
            Sys.gunGroup.add(gun);
            Sys.camera.add(Sys.gunGroup);
            Sys.scene.add(Sys.camera);
        }

        function spawnBot(pos) {
            const botModel = Sys.assets['guy'].clone();
            
            // --- BOT GÖRÜNMEZ İSE BUNLARI DÜZELTİR ---
            botModel.scale.set(Config.npc.scale, Config.npc.scale, Config.npc.scale);
            
            // Model içindeki materyalleri kontrol et
            botModel.traverse((node) => {
                if(node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                    // Eğer model siyahsa materyali düzelt
                    if(!node.material.map) node.material.color.setHex(0x555555);
                }
            });

            botModel.position.copy(pos);
            botModel.position.y = Config.npc.positionFix; // Yere oturtma

            Sys.scene.add(botModel);

            // Bot nesnesi
            const bot = {
                mesh: botModel,
                hp: 100,
                lastFire: 0
            };
            Sys.entities.push(bot);
        }

        /* * 4. MAIN LOOP (FİZİK VE YAPAY ZEKA)
         */
        function animate() {
            requestAnimationFrame(animate);
            if(!State.isPlaying) return;

            const dt = Sys.clock.getDelta();
            
            // --- OYUNCU HAREKETİ ---
            const speed = Config.playerSpeed;
            const velocity = new THREE.Vector3();
            
            if(Input.w) velocity.z += speed * dt;
            if(Input.s) velocity.z -= speed * dt;
            if(Input.a) velocity.x -= speed * dt;
            if(Input.d) velocity.x += speed * dt;

            Sys.controls.moveRight(velocity.x);
            Sys.controls.moveForward(velocity.z);

            // --- BOT AI (YAPAY ZEKA) ---
            Sys.entities.forEach((bot, index) => {
                if(bot.hp <= 0) return;

                // 1. Oyuncuya Bak
                bot.mesh.lookAt(Sys.camera.position.x, bot.mesh.position.y, Sys.camera.position.z);

                // 2. Mesafe Kontrolü
                const dist = bot.mesh.position.distanceTo(Sys.camera.position);
                
                // 3. Ateş Etme
                if(dist < 20 && Date.now() - bot.lastFire > 1500) { // 1.5 saniyede bir
                    bot.lastFire = Date.now();
                    playerTakeDamage(15);
                    // Silah sesi (Uzaklık efekti olmadan basit çalar)
                    AudioSys.play('shoot');
                }
            });

            // --- SİLAH ANIMASYONU (SWAY & RECOIL) ---
            if(Sys.gunGroup) {
                // Nefes alma efekti
                const time = Date.now() * 0.002;
                Sys.gunGroup.position.y = Math.sin(time) * 0.002;
                
                // Recoil Recovery
                Sys.gunGroup.rotation.x *= 0.9;
                Sys.gunGroup.position.z *= 0.9;
            }

            Sys.renderer.render(Sys.scene, Sys.camera);
        }

        /* * 5. COMBAT & EVENTS
         */
        function shootWeapon() {
            if(State.ammo <= 0) return;
            State.ammo--;
            document.getElementById('ui-ammo').innerText = State.ammo;

            // 1. Ses
            AudioSys.play('shoot');

            // 2. Recoil Animasyonu
            if(Sys.gunGroup) {
                Sys.gunGroup.rotation.x += 0.1; // Namlu kalkar
                Sys.gunGroup.position.z += 0.05; // Geri teper
            }

            // 3. Raycast (Vuruş Kontrolü)
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), Sys.camera);

            const botMeshes = Sys.entities.map(b => b.mesh);
            const intersects = ray.intersectObjects(botMeshes, true);

            if(intersects.length > 0) {
                const hitObj = intersects[0].object;
                
                // Botu bul
                const botRoot = findParentBot(hitObj);
                if(botRoot) {
                    // Headshot Kontrolü (Basit yükseklik kontrolü)
                    const hitPoint = intersects[0].point;
                    const isHeadshot = hitPoint.y > (botRoot.position.y + 1.4); // Yüksekse kafadır
                    
                    if(isHeadshot) {
                        AudioSys.play('headshot');
                        killBot(botRoot);
                    } else {
                        // Gövde vuruşu (Şimdilik tek atışta ölsün)
                        killBot(botRoot); 
                    }
                }
            }
        }

        function findParentBot(mesh) {
            // Tıklanan parça (kol, bacak) hangi bota ait?
            let curr = mesh;
            while(curr.parent && curr.parent !== Sys.scene) {
                curr = curr.parent;
            }
            return curr; // Botun ana grubu
        }

        function killBot(botMesh) {
            // Botu sahneden sil veya yatır
            botMesh.rotation.x = -Math.PI / 2; // Yere düşme
            botMesh.position.y = 0.2;
            
            // Listeden düşür (Logic olarak)
            const botData = Sys.entities.find(b => b.mesh === botMesh);
            if(botData) botData.hp = 0;
        }

        function playerTakeDamage(dmg) {
            State.hp -= dmg;
            document.getElementById('ui-hp').innerText = State.hp;
            
            // Kırmızı Ekran
            const flash = document.getElementById('damage-flash');
            flash.style.opacity = 0.5;
            setTimeout(() => flash.style.opacity = 0, 100);

            if(State.hp <= 0) {
                State.isDead = true;
                Sys.controls.unlock();
                alert("ÖLDÜN! F5 AT.");
                location.reload();
            }
        }

        function setupInputs() {
            document.addEventListener('keydown', (e) => {
                switch(e.key.toLowerCase()) {
                    case 'w': Input.w = true; break;
                    case 's': Input.s = true; break;
                    case 'a': Input.a = true; break;
                    case 'd': Input.d = true; break;
                }
            });
            document.addEventListener('keyup', (e) => {
                switch(e.key.toLowerCase()) {
                    case 'w': Input.w = false; break;
                    case 's': Input.s = false; break;
                    case 'a': Input.a = false; break;
                    case 'd': Input.d = false; break;
                }
            });
            document.addEventListener('mousedown', () => {
                if(Sys.controls.isLocked) shootWeapon();
            });
        }

        function onResize() {
            Sys.camera.aspect = window.innerWidth / window.innerHeight;
            Sys.camera.updateProjectionMatrix();
            Sys.renderer.setSize(window.innerWidth, window.innerHeight);
        }

    </script>
</body>
</html>
