<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT: BLACKOUT</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap');

        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Oswald', sans-serif; user-select: none; }

        /* --- BODYCAM EFEKTLERİ (DAHA NET) --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* Köşe Karartması (Vignette) - Daha yumuşak */
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.9) 100%);
        }

        /* Kamera Yazıları */
        #cam-info {
            position: absolute; top: 30px; right: 30px; text-align: right;
            color: #fff; font-size: 20px; text-shadow: 0 0 5px rgba(255,255,255,0.5);
            font-family: monospace;
        }
        #rec-dot {
            color: red; animation: blink 1s infinite;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: rgba(255,255,255,0.8); border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 4px white;
        }

        /* KAN EFEKTİ (HASAR ALINCA) */
        #blood-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(180,0,0,0.8) 90%);
            display: none; z-index: 15; mix-blend-mode: multiply;
        }

        /* --- MENÜLER --- */
        #menu-screen, #death-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
            color: white;
        }

        h1 { font-size: 5rem; margin: 0; letter-spacing: 10px; text-transform: uppercase; background: -webkit-linear-gradient(#fff, #666); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        input {
            background: #111; border: 1px solid #444; color: white;
            padding: 15px; font-size: 1.2rem; margin: 20px;
            text-align: center; width: 250px; outline: none;
            font-family: 'Oswald', sans-serif; transition: 0.3s;
        }
        input:focus { border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); }

        button {
            background: #fff; color: #000; border: none; padding: 15px 50px;
            font-size: 1.5rem; font-weight: bold; cursor: pointer;
            text-transform: uppercase; font-family: 'Oswald', sans-serif;
            transition: 0.2s;
        }
        button:hover { background: #ccc; transform: scale(1.05); }

        @keyframes blink { 50% { opacity: 0; } }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="vignette"></div>
        <div id="cam-info">
            <span id="rec-dot">● REC</span><br>
            <span id="time-display">00:00:00</span><br>
            ISO 800 | F2.8
        </div>
        <div id="crosshair"></div>
        <div id="blood-overlay"></div>
    </div>

    <div id="menu-screen">
        <h1>BLACKOUT</h1>
        <p style="color:#888;">HEDEF: GİZLİ KAPIYI BUL VE KAÇ.</p>
        <input type="text" id="invite-code" placeholder="GİRİŞ KODU">
        <button onclick="startGame()">BAŞLAT</button>
        <p id="error-msg" style="color:red; display:none; margin-top:10px;">GEÇERSİZ KOD</p>
    </div>

    <div id="death-screen" class="hidden">
        <h1 style="color:red; -webkit-text-fill-color: red;">ÖLDÜN</h1>
        <p>ZOMBİ SENİ YAKALADI.</p>
        <button onclick="location.reload()">TEKRAR DENE</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- AYARLAR ---
        const CODE = "1234"; // Basit test kodu
        let isGameRunning = false;
        
        // --- SES SİSTEMİ (Kalp Atışı) ---
        // Rahatsız edici cızırtılar yerine sadece kalp sesi
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let lastHeartbeat = 0;
        
        function playHeartbeat(distance) {
            // Mesafe ne kadar azsa (yakınsa), kalp o kadar hızlı atar
            // Mesafe 15m'den fazlaysa ses yok.
            if (distance > 15) return;

            // Atış hızı: Yakınsa 0.3sn, uzaksa 1.5sn
            const rate = Math.max(0.3, distance / 10); 
            
            if (audioCtx.currentTime - lastHeartbeat > rate) {
                lastHeartbeat = audioCtx.currentTime;
                
                // Tok bir "Güm" sesi (Low Frequency)
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.frequency.setValueAtTime(60, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
                
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime); // Ses seviyesi
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        // --- THREE.JS KURULUMU ---
        const scene = new THREE.Scene();
        // Siyah sis (Karanlık ortam için) - Görüş mesafesini temizledik
        scene.fog = new THREE.Fog(0x000000, 1, 25); 

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.y = 1.7;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio); // Daha keskin görüntü
        // Tone Mapping (Daha gerçekçi ışık)
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 1.5;
        document.body.appendChild(renderer.domElement);

        // --- IŞIKLANDIRMA (EL FENERİ) ---
        // Ambient Light (Ortam ışığı) çok az, zifiri karanlık olmasın
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.05); 
        scene.add(ambientLight);

        // El Feneri (SpotLight) - Çok daha parlak ve geniş
        const flashLight = new THREE.SpotLight(0xffffff, 80, 40, 0.5, 0.5, 2);
        flashLight.position.set(0, 0, 0);
        flashLight.castShadow = true;
        camera.add(flashLight);
        
        // Fenerin hedefini kameranın baktığı yere sabitle
        const lightTarget = new THREE.Object3D();
        lightTarget.position.set(0, 0, -1);
        camera.add(lightTarget);
        flashLight.target = lightTarget;
        
        scene.add(camera);

        // --- DOKU OLUŞTURUCU (Texture Generator) ---
        // Bok gibi renkler yerine prosedürel beton/fayans dokusu
        function createProTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Gri zemin
            ctx.fillStyle = '#222'; 
            ctx.fillRect(0,0,512,512);
            
            // Kirli detaylar (Noise)
            for(let i=0; i<5000; i++) {
                ctx.fillStyle = Math.random() > 0.5 ? '#333' : '#111';
                ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
            }

            // Çizgiler (Fayans etkisi)
            ctx.strokeStyle = '#111';
            ctx.lineWidth = 4;
            ctx.beginPath();
            // Dikey
            for(let i=0; i<=512; i+=128) { ctx.moveTo(i,0); ctx.lineTo(i,512); }
            // Yatay
            for(let i=0; i<=512; i+=128) { ctx.moveTo(0,i); ctx.lineTo(512,i); }
            ctx.stroke();

            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        const wallTexture = createProTexture();
        const wallMat = new THREE.MeshStandardMaterial({ 
            map: wallTexture, 
            roughness: 0.8,
            color: 0x888888 // Renk tonunu nötr gri yaptık
        });
        const floorMat = new THREE.MeshStandardMaterial({ 
            map: wallTexture, 
            roughness: 0.9,
            color: 0x444444
        });

        // --- HARİTA (LABİRENT) ---
        const walls = [];
        // 1: Duvar, 0: Yol, 9: Zombi, 8: Kapı
        const map = [
            [1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,9,1],
            [1,0,1,0,1,0,1,1,1,1],
            [1,0,1,0,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,0,1,1,1,1],
            [1,8,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1]
        ];
        
        const UNIT = 4; // Duvar genişliği

        // Zemin
        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);

        // Tavan
        const ceiling = new THREE.Mesh(floorGeo, floorMat);
        ceiling.rotation.x = Math.PI/2;
        ceiling.position.y = 4; // Yüksek tavan
        scene.add(ceiling);

        let zombieRef = null;
        let doorRef = null;

        map.forEach((row, z) => {
            row.forEach((val, x) => {
                const px = (x - 5) * UNIT;
                const pz = (z - 5) * UNIT;

                if(val === 1) {
                    const geo = new THREE.BoxGeometry(UNIT, 4, UNIT);
                    const mesh = new THREE.Mesh(geo, wallMat);
                    mesh.position.set(px, 2, pz);
                    scene.add(mesh);
                    walls.push(new THREE.Box3().setFromObject(mesh)); // Çarpışma için
                } 
                else if (val === 9) {
                    // ZOMBIE YERİNE KIRMIZI GÖZLÜ SİYAH BİR ŞEKİL (MODEL YOKSA)
                    loadZombie(px, pz);
                }
                else if (val === 8) {
                    loadDoor(px, pz);
                }
            });
        });

        function loadZombie(x, z) {
            const loader = new GLTFLoader();
            loader.load('Zombie.glb', (gltf) => {
                zombieRef = gltf.scene;
                zombieRef.position.set(x, 0, z);
                scene.add(zombieRef);
            }, undefined, () => {
                // Model yoksa: Siyah, Kırmızı Gözlü "Shadow Man"
                const geo = new THREE.CapsuleGeometry(0.5, 1.8, 4, 8);
                const mat = new THREE.MeshStandardMaterial({ color: 0x000000 });
                zombieRef = new THREE.Mesh(geo, mat);
                
                // Gözler (Parlayan)
                const eyeGeo = new THREE.SphereGeometry(0.1);
                const eyeMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
                const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
                leftEye.position.set(-0.2, 0.8, 0.4);
                rightEye.position.set(0.2, 0.8, 0.4);
                zombieRef.add(leftEye);
                zombieRef.add(rightEye);

                zombieRef.position.set(x, 1, z);
                scene.add(zombieRef);
            });
        }

        function loadDoor(x, z) {
            const loader = new GLTFLoader();
            loader.load('Door.glb', (gltf) => {
                doorRef = gltf.scene;
                doorRef.position.set(x, 0, z);
                scene.add(doorRef);
            }, undefined, () => {
                // Model yoksa: Beyaz parlayan kapı
                const geo = new THREE.BoxGeometry(UNIT, 3.5, 0.2);
                const mat = new THREE.MeshStandardMaterial({ color: 0xcccccc });
                doorRef = new THREE.Mesh(geo, mat);
                doorRef.position.set(x, 1.75, z);
                scene.add(doorRef);
                
                // Kapı Işığı
                const l = new THREE.PointLight(0x0000ff, 5, 5);
                l.position.set(x, 3, z);
                scene.add(l);
            });
        }

        // --- KONTROLLER ---
        const controls = new PointerLockControls(camera, document.body);
        const keys = { w:false, a:false, s:false, d:false };

        document.addEventListener('keydown', (e) => {
            if(e.code === 'KeyW') keys.w = true;
            if(e.code === 'KeyS') keys.s = true;
            if(e.code === 'KeyA') keys.a = true;
            if(e.code === 'KeyD') keys.d = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.code === 'KeyW') keys.w = false;
            if(e.code === 'KeyS') keys.s = false;
            if(e.code === 'KeyA') keys.a = false;
            if(e.code === 'KeyD') keys.d = false;
        });

        // --- OYUN MANTIĞI ---
        window.startGame = function() {
            const code = document.getElementById('invite-code').value;
            if(code === CODE) {
                document.getElementById('menu-screen').classList.add('hidden');
                isGameRunning = true;
                controls.lock();
                audioCtx.resume();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        const clock = new THREE.Clock();
        const playerSpeed = 5.0;

        function animate() {
            requestAnimationFrame(animate);

            if(!isGameRunning) {
                renderer.render(scene, camera);
                return;
            }

            const dt = clock.getDelta();
            
            // --- OYUNCU HAREKETİ ---
            const direction = new THREE.Vector3();
            const forward = new THREE.Vector3();
            const right = new THREE.Vector3();
            
            // Kameranın yönünü al ama Y eksenini sıfırla (Uçmasın)
            camera.getWorldDirection(forward);
            forward.y = 0;
            forward.normalize();
            
            right.crossVectors(forward, new THREE.Vector3(0,1,0));
            
            if(keys.w) direction.add(forward);
            if(keys.s) direction.sub(forward);
            if(keys.d) direction.add(right);
            if(keys.a) direction.sub(right);

            if(direction.length() > 0) {
                direction.normalize();
                
                // Duvar Çarpışma Kontrolü (Basit)
                const nextPos = camera.position.clone().add(direction.multiplyScalar(playerSpeed * dt));
                let collide = false;
                
                // Oyuncunun kapladığı alan (Kutu)
                const pBox = new THREE.Box3().setFromCenterAndSize(nextPos, new THREE.Vector3(1,1,1));
                
                for(let w of walls) {
                    if(w.intersectsBox(pBox)) {
                        collide = true;
                        break;
                    }
                }

                if(!collide) {
                    camera.position.copy(nextPos);
                }
            }

            // --- ZOMBİ YAPAY ZEKA (ÖLÜMCÜL) ---
            if(zombieRef) {
                zombieRef.lookAt(camera.position.x, zombieRef.position.y, camera.position.z);
                
                const dist = zombieRef.position.distanceTo(camera.position);
                
                // Ses Sistemi (Kalp Atışı)
                playHeartbeat(dist);

                if(dist > 1.2) {
                    // Takip et
                    const zSpeed = 3.8; // Oyuncudan biraz yavaş ama pes etmez
                    zombieRef.translateZ(zSpeed * dt);
                } else {
                    // YAKALADI - ÖLÜM
                    isGameRunning = false;
                    document.getElementById('blood-overlay').style.display = 'block';
                    document.exitPointerLock();
                    
                    // 1 saniye sonra ölüm ekranı
                    setTimeout(() => {
                        document.getElementById('death-screen').classList.remove('hidden');
                    }, 1000);
                }
            }

            // Kapı kontrol
            if(doorRef) {
                if(camera.position.distanceTo(doorRef.position) < 2) {
                    alert("KAÇIŞ BAŞARILI!");
                    location.reload();
                }
            }

            // Zamanlayıcı
            document.getElementById('time-display').innerText = new Date().toLocaleTimeString();

            renderer.render(scene, camera);
        }

        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
